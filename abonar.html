<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Registrar Abonos con Nota de Crédito</title>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
  <script src="https://facturacionweb.github.io/facturacionweb/firebase-config.js"></script>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; background: #f9f9f9; }
    .container { max-width: 800px; margin: auto; background: white; padding: 20px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
    label, select, input, button { display: block; width: 100%; margin: 10px 0; padding: 10px; }
    #bancoSelect, #referenciaInput, #notaCreditoSelect { display: none; }
  </style>
</head>
<body>
<div class="container">
  <h1>Registrar Abono</h1>
  <label for="clienteSelect">Seleccionar Cliente:</label>
  <select id="clienteSelect"></select>

  <label for="facturaSelect">Seleccionar Factura de Crédito:</label>
  <select id="facturaSelect"></select>

  <label for="metodoPagoSelect">Método de Pago:</label>
  <select id="metodoPagoSelect">
    <option value="Efectivo">Efectivo</option>
    <option value="Transferencia">Transferencia</option>
    <option value="NotaCredito">Nota de Crédito</option>
  </select>

  <div id="bancoSelectContainer">
    <label for="bancoSelect">Banco:</label>
    <select id="bancoSelect">
      <option value="BAC">BAC</option>
      <option value="LA FISE">LA FISE</option>
      <option value="BANPRO">BANPRO</option>
      <option value="AVANZ">AVANZ</option>
    </select>

    <label for="referenciaInput">Referencia Bancaria:</label>
    <input type="text" id="referenciaInput" placeholder="Número de referencia">
  </div>

  <div id="notaCreditoSelectContainer">
    <label for="notaCreditoSelect">Seleccionar Nota de Crédito:</label>
    <select id="notaCreditoSelect"></select>
  </div>

  <label for="montoInput">Monto a Abonar:</label>
  <input type="number" id="montoInput" readonly />

  <button onclick="registrarAbono()">Registrar Abono</button>
</div>

<script>
const db = firebase.firestore();

$(document).ready(function() {
  cargarClientes();

  $('#metodoPagoSelect').change(function() {
    const metodo = $(this).val();
    $('#bancoSelect, #referenciaInput').parent().hide();
    $('#notaCreditoSelectContainer').hide();
    $('#montoInput').prop('readonly', false);
    if (metodo === 'Transferencia') {
      $('#bancoSelectContainer').show();
      $('#referenciaInput').parent().show();
    } else if (metodo === 'NotaCredito') {
      $('#notaCreditoSelectContainer').show();
      cargarNotasCredito();
    }
  });

  $('#notaCreditoSelect').change(function() {
    const selectedOption = $(this).find('option:selected');
    const monto = parseFloat(selectedOption.data('monto')) || 0;
    $('#montoInput').val(monto.toFixed(2)).prop('readonly', true);
  });
});

function cargarClientes() {
  db.collection("clientes").get().then(snapshot => {
    snapshot.forEach(doc => {
      const cliente = doc.data();
      $('#clienteSelect').append(`<option value="${doc.id}">${cliente.nombreCliente} - ${cliente.nombreTienda}</option>`);
    });
  });
}

function cargarNotasCredito() {
  const clienteId = $('#clienteSelect').val();
  if (!clienteId) return;

  $('#notaCreditoSelect').empty();
  db.collection("notasCredito").where("clienteId", "==", clienteId).where("abonoId", "==", null).get()
    .then(snapshot => {
      snapshot.forEach(doc => {
        const nota = doc.data();
        $('#notaCreditoSelect').append(`<option value="${doc.id}" data-monto="${nota.monto}">${nota.descripcion} - C$${nota.monto.toFixed(2)}</option>`);
      });
    });
}

function registrarAbono() {
  const clienteId = $('#clienteSelect').val();
  const facturaId = $('#facturaSelect').val();
  const metodoPago = $('#metodoPagoSelect').val();
  const monto = parseFloat($('#montoInput').val());
  const banco = $('#bancoSelect').val();
  const referencia = $('#referenciaInput').val();
  const notaCreditoId = $('#notaCreditoSelect').val();

  if (!clienteId || !facturaId || isNaN(monto)) {
    alert("Por favor completa todos los campos obligatorios.");
    return;
  }

  const abonoData = {
    clienteId,
    facturaId,
    paymentMethod: metodoPago,
    paymentType: banco || null,
    referenciaBancaria: referencia || null,
    monto,
    fecha: new Date()
  };

  const facturaRef = db.collection("facturas").doc(facturaId);
  facturaRef.collection("abonos").add(abonoData).then(docRef => {
    if (metodoPago === 'NotaCredito' && notaCreditoId) {
      db.collection("notasCredito").doc(notaCreditoId).update({ abonoId: docRef.id });
    }
    alert("Abono registrado exitosamente.");
    location.reload();
  });
}
</script>
</body>
</html>
