<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gesti√≥n de Abonos a Facturas de Cr√©dito</title>

  <!-- Firebase SDK (v8 para compatibilidad con el resto del proyecto) -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
  <!-- Config de Firebase (ajusta la ruta si la tienes en otro lugar) -->
  <script src="https://facturacionweb.github.io/facturacionweb/firebase-config.js"></script>

  <!-- jQuery + Select2 para mejor UX en combos -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

  <style>
    .modal {
      display: none;
      position: fixed;
      z-index: 100;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgba(0,0,0,0.5);
    }
    .modal-content {
      background-color: #fff;
      margin: 10% auto;
      padding: 20px;
      width: 90%;
      max-width: 800px;
      position: relative;
    }
    .close {
      color: #aaa;
      float: right;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
    }
  
    body {
      font-family: Arial, sans-serif;
      background:#f4f4f4;
      margin:0;
      padding:0;
    }
    .container {
      max-width: 900px;
      margin: 20px auto;
      background:#fff;
      padding: 20px;
      box-shadow: 0 0 10px rgba(0,0,0,.1);
    }
    h1, h2 { text-align:center; }
    label { margin-top:10px; display:block; font-weight:bold; }
    select, input[type="number"], input[type="text"], button {
      width:100%;
      padding:10px;
      margin:5px 0 15px;
      box-sizing:border-box;
    }
    button { cursor:pointer; }
    .flex-row {
      display:flex;
      gap:10px;
    }
    .flex-row > * { flex:1; }
    table {
      width:100%;
      border-collapse:collapse;
      margin-top:20px;
    }
    th,td {
      border:1px solid #ccc;
      padding:8px;
      text-align:center;
    }
    th { background:#333; color:#fff; }
    /* Snackbar */
    #snackbar {
      visibility:hidden;
      min-width:250px;
      background-color:#333;
      color:#fff;
      text-align:center;
      border-radius:2px;
      padding:12px;
      position:fixed;
      z-index:1000;
      left:50%;
      bottom:30px;
      transform:translateX(-50%);
    }
    #snackbar.show {
      visibility:visible;
      animation:fadein .5s, fadeout .5s 2.5s;
    }
    @keyframes fadein { from {bottom:0; opacity:0;} to {bottom:30px; opacity:1;} }
    @keyframes fadeout { from {bottom:30px; opacity:1;} to {bottom:0; opacity:0;} }
  </style>
</head>
<body>
<a href="index.html">‚¨ÖÔ∏è Volver a la P√°gina Principal</a>
<div class="container">
  <h1>  üí∏ Registrar Abonos üí∏</h1>

  <!-- Selecci√≥n de Cliente -->
  <label for="clienteSelect">Selecciona Cliente:</label>
  <select id="clienteSelect"></select>

  <!-- Bot√≥n Abono M√∫ltiple (aparte del flujo actual) -->
  <button id="btnAbonoMultiple" style="margin-left:8px; display:inline-block;">
    Abono m√∫ltiple
  </button>

  <!-- Selecci√≥n de Factura Cr√©dito -->
  <label for="facturaSelect">Selecciona Factura de Cr√©dito:</label>
  <select id="facturaSelect"></select>

  <!-- Monto a Abonar -->
  <label for="montoAbono">Monto a Abonar (C$):</label>
  <input type="number" id="montoAbono" min="0.01" step="0.01" />

  <!-- Ruta del Abono -->
  <label for="rutaAbono">Ruta (Opcional):</label>
  <select id="rutaAbono">
    <option value="SIN RUTA">SIN RUTA</option>
    <option value="1">1</option>
    <option value="2">2</option>
    <option value="3">3</option>
    <option value="4">4</option>
    <option value="5">5</option>
    <option value="6">6</option>
    <option value="7">7</option>
    <option value="8">8</option>
    <option value="9">9</option>
    <option value="10">10</option>
  </select>

  <!-- M√©todo de Pago -->
  <label for="metodoPago">M√©todo de Pago:</label>
  <select id="metodoPago">
    <option value="Efectivo">Efectivo</option>
    <option value="Transferencia">Transferencia</option>
    <option value="NotaCredito">Nota de Cr√©dito</option>
  </select>

  <!-- Info de Transferencia -->
  <div id="infoTransferencia" style="display:none;">
    <div class="flex-row">
      <div>
        <label for="bancoSelect">Banco:</label>
        <select id="bancoSelect">
          <option value="BAC">BAC</option>
          <option value="LA FISE">LA FISE</option>
          <option value="BANPRO">BANPRO</option>
          <option value="AVANZ">AVANZ</option>
          <option value="FICOHSA">FICOHSA</option>
        </select>
      </div>
      <div>
        <label for="referenciaBancaria"># Referencia:</label>
        <input type="text" id="referenciaBancaria" placeholder="N√∫mero / C√≥digo de referencia" />
      </div>
    </div>
  </div>

  <!-- Info de Nota de Cr√©dito -->
  <div id="infoNotaCredito" style="display:none;">
    <label for="notaCreditoSelect">Selecciona Nota de Cr√©dito:</label>
    <select id="notaCreditoSelect"></select>
  </div>

  <!-- Botones -->
  <button id="btnRegistrar">REGISTRAR ABONO</button>
  <button id="btnCancelar" style="background:#aaa;">CANCELAR</button>

  <!-- Recibo en pantalla -->
  <div id="reciboContainer" style="display:none; margin-top:30px;">
    <div id="recibo" style="border:1px solid #333; padding:15px;"></div>
    <button id="btnImprimir">Imprimir Recibo üñ®Ô∏è</button>
  </div>

  <h2>Historial de Abonos Recientes!</h2>
  <table>
    <thead>
      <tr>
        <th>Recibo</th>
        <th>Fecha/Hora</th>
        <th>Factura</th>
        <th>Usuario</th>
        <th>M√©todo</th>
        <th>Monto (C$)</th>
        <th>Saldo Pendiente</th>
        <th>Eliminar</th>
      </tr>
    </thead>
    <tbody id="tablaHistorial"></tbody>
  </table>
  <div id="histLoading" style="text-align:center; padding:8px; display:none;">
  Cargando m√°s abonos‚Ä¶
</div>
  
<div id="histSentinel" style="height:1px;"></div>
<!-- Fallback opcional (bot√≥n) -->
<button id="btnLoadMore" style="display:none; margin:10px auto; width:100%; max-width:240px;">
  Cargar m√°s
</button>

</div>

<!-- Snackbar -->
<div id="snackbar"></div>

<!-- Modal de Detalle de Factura -->
<div id="invoiceModal" class="modal">
  <div class="modal-content">
    <span class="close" onclick="closeInvoiceModal()">&times;</span>
    <div id="modalInvoiceContent"></div>
  </div>
</div>  

<!-- Modal: Abono M√∫ltiple -->
<div id="multiAbonoModal" class="modal" style="display:none;">
  <div class="modal-content" style="max-width: 980px;">
    <span class="close" onclick="closeMultiAbonoModal()">&times;</span>
    <h2 style="margin-top:0;">Abono m√∫ltiple</h2>

    <div style="display:flex; gap:12px; align-items: center; margin-bottom:12px;">
      <div>
        <label for="multiMonto">Monto total a distribuir (C$):</label>
        <input type="number" id="multiMonto" min="0.01" step="0.01" />
      </div>
      <button id="btnDistribuir" style="height:38px;">Distribuir abonos</button>
      <div id="multiResumen" style="margin-left:auto; font-weight:600;">
        Total: C$0.00 ‚Ä¢ Distribuido: C$0.00 ‚Ä¢ Restante: C$0.00
      </div>
    </div>


    <!-- M√©todo de pago (aplica para TODOS los abonos del lote) -->
    <div style="display:flex; gap:12px; align-items:center; margin-bottom:12px;">
      <div>
        <label for="multiMetodoPago">M√©todo de Pago:</label>
        <select id="multiMetodoPago">
          <option value="Efectivo">Efectivo</option>
          <option value="Transferencia">Transferencia</option>
        </select>
      </div>

      <!-- Info de Transferencia (multi) -->
      <div id="multiInfoTransferencia" style="display:none; flex:1;">
        <div class="flex-row">
          <div>
            <label for="multiBancoSelect">Banco:</label>
            <select id="multiBancoSelect">
              <option value="BAC">BAC</option>
              <option value="LA FISE">LA FISE</option>
              <option value="BANPRO">BANPRO</option>
              <option value="AVANZ">AVANZ</option>
              <option value="FICOHSA">FICOHSA</option>
            </select>
          </div>
          <div style="flex:1;">
            <label for="multiReferenciaBancaria"># Referencia:</label>
            <input type="text" id="multiReferenciaBancaria" placeholder="N√∫mero / C√≥digo de referencia" />
          </div>
        </div>
      </div>
    </div>

    <div style="overflow:auto; max-height: 55vh; border:1px solid #ddd;">
      <table style="width:100%; border-collapse: collapse;">
        <thead>
          <tr>
            <th>Fecha/Hora</th>
            <th>Id Factura</th>
            <th>Consecutivo</th>
            <th>Monto</th>
            <th>Saldo Pendiente</th>
            <th>Saldo Proyectado</th>
          </tr>
        </thead>
        <tbody id="multiAbonoTbody"></tbody>
      </table>
    </div>

        <div style="display:flex; justify-content:space-between; gap:8px; margin-top:12px; align-items:center; flex-wrap:wrap;">
      <div id="multiReciboStatus" style="font-size:13px; color:#555;"></div>
      <div style="display:flex; justify-content:flex-end; gap:8px; flex-wrap:wrap;">
        <button id="btnImprimirMultiWeb" disabled title="Imprimir recibo (web)">üñ®Ô∏è Imprimir</button>
        <button
          id="btnImprimirMultiMovil"
          disabled
          title="Imprimir recibo (m√≥vil)"
          style="padding:5px 10px;background:#17a2b8;color:#fff;border:none;border-radius:4px;cursor:pointer;">
          üì± M√≥vil
        </button>
        <button onclick="closeMultiAbonoModal()" style="background:#aaa;">Cerrar</button>
        <button id="btnAplicarAbonos" disabled>Aplicar abonos</button>
      </div>
    </div>

    <div id="multiReciboPreview" style="display:none; margin-top:12px; border:1px dashed #bbb; padding:12px; border-radius:10px; background:#fafafa;"></div>
  </div>
</div>

  
<script>
  // Inicializar Firestore
  const db = firebase.firestore();
  const clientesMap = {}; // Para mostrar nombres de clientes

  const HIST_PAGE_SIZE = 20;
  let histQuery = null;      // referencia base
  let histCursor = null;     // √∫ltimo doc de la p√°gina previa
  let histLoading = false;   // bandera de carga
  let histDone = false;      // no hay m√°s datos
  let histObserver = null;   // IntersectionObserver

  /*********************** HELPER: Snackbar *************************/
  function toast(msg) {
    const x = document.getElementById('snackbar');
    x.textContent = msg;
    x.className = 'show';
    setTimeout(() => x.className = x.className.replace('show',''), 3000);
  }

  /*********************** CARGA INICIAL *************************/
  window.onload = () => {

    cargarClientes();

    // Eventos
    //document.getElementById('clienteSelect').addEventListener('change', cargarFacturasCredito);
     /* document.getElementById('clienteSelect').addEventListener('change', () => {
        console.log("Cliente cambiado!");
        cargarFacturasCredito();
        cargarNotasCreditoDisponibles();
      });*/
    $('#clienteSelect').on('change', function () {
      console.log("üî• Cliente cambiado (v√≠a Select2)");
      cargarFacturasCredito();
      cargarNotasCreditoDisponibles();
    });
    document.getElementById('facturaSelect').addEventListener('change', actualizarMontoPorSaldo);
    document.getElementById('metodoPago').addEventListener('change', toggleMetodoPago);
    document.getElementById('notaCreditoSelect').addEventListener('change', setMontoPorNotaCredito);
    document.getElementById('btnRegistrar').addEventListener('click', registrarAbono);
    document.getElementById('btnCancelar').addEventListener('click', limpiarFormulario);
    document.getElementById('btnImprimir').addEventListener('click', imprimirRecibo);
  };

  /*********************** CLIENTES *************************/
  function cargarClientes() {
    const sel = document.getElementById('clienteSelect');
    sel.innerHTML = '';
    db.collection('clientes').get().then(qs => {
      qs.forEach(doc => {
        const cliente = doc.data();
        const nombre = `${cliente.nombreCliente} - ${cliente.nombreTienda}`;
        clientesMap[doc.id] = nombre;
        const opt = document.createElement('option');
        opt.value = doc.id;
        opt.textContent = nombre;
        sel.appendChild(opt);
      });
      // Activar select2
      $(sel).select2({ placeholder:'Seleccione un cliente' });
      // Disparar carga de facturas de primer cliente (si existe)
      if (sel.value) cargarFacturasCredito();
    });
  }

  /*********************** FACTURAS CR√âDITO *************************/
  function cargarFacturasCredito() {
    const clienteId = document.getElementById('clienteSelect').value;
    const sel = document.getElementById('facturaSelect');
    sel.innerHTML = '';
    if (!clienteId) return;
    //.where('clientId','==',clienteId)
    db.collection('facturas')
      .where('clientId','==',clienteId)
      .where('paymentType','==','Credito')
      .where('anulada','==',false)
      .orderBy('fecha','asc')
      .get().then(qs => {
        qs.forEach(doc => {
          const f = doc.data();
          console.log(`üßæ Factura ${doc.id} ‚Üí clientId: [${f.clientId}] | == [${clienteId}] ‚Üí ${f.clientId === clienteId}`);
          const saldo = f.saldo !== undefined ? f.saldo : f.total;
          if (saldo > 0) {
            const opt = document.createElement('option');
            opt.value = doc.id;
            opt.textContent = `Factura ${doc.id} - Saldo: C$${saldo.toFixed(2)}`;
            opt.dataset.saldo = saldo;
            sel.appendChild(opt);
          }
        });
        $(sel).select2({ placeholder:'Seleccione una factura cr√©dito' });
        actualizarMontoPorSaldo();
        // Cargar notas cr√©dito disponibles
        cargarNotasCreditoDisponibles();
      });
  }

  function actualizarMontoPorSaldo() {
    const selFactura = document.getElementById('facturaSelect');
    const opt = selFactura.options[selFactura.selectedIndex];
    if (opt && opt.dataset.saldo) {
      document.getElementById('montoAbono').value = parseFloat(opt.dataset.saldo).toFixed(2);
    } else {
      document.getElementById('montoAbono').value = '';
    }
  }

  /*********************** M√âTODO PAGO *************************/
  function toggleMetodoPago() {
    const metodo = document.getElementById('metodoPago').value;
    document.getElementById('infoTransferencia').style.display = (metodo==='Transferencia')? 'block':'none';
    document.getElementById('infoNotaCredito').style.display = (metodo==='NotaCredito')? 'block':'none';

    if (metodo==='NotaCredito') {
      // Al cambiar a nota cr√©dito, fijar monto readonly (si hay nota seleccionada)
      setMontoPorNotaCredito();
    } else {
      document.getElementById('montoAbono').readOnly = false;
    }
  }

  /*********************** NOTAS CR√âDITO *************************/
  function cargarNotasCreditoDisponibles() {
    const clienteId = document.getElementById('clienteSelect').value;
    const sel = document.getElementById('notaCreditoSelect');
    sel.innerHTML = '';
    if (!clienteId) return;
    // Solo notas del cliente SIN abonoId asociado
    /* .where('clienteId','==',clienteId)
      .where('abonoId','==',null)*/
    db.collection('notasCredito')
      .where('clienteId','==',clienteId)
      .where('abonoId','==',null)
      .get().then(qs => {
        qs.forEach(doc => {
          const nota = doc.data();
          console.log(`Doc ${doc.id} ‚Üí clienteId: [${nota.clienteId}] | == [${clienteId}] ‚Üí ${nota.clienteId === clienteId}`);
          const n = doc.data();
          const opt = document.createElement('option');
          opt.value = doc.id;
          opt.textContent = `${n.codigo} - C$${n.monto.toFixed(2)}`;
          opt.dataset.monto = n.monto;
          sel.appendChild(opt);
        });
        $(sel).select2({ placeholder:'Seleccione nota de cr√©dito' });

        $(sel).off('change select2:select').on('change select2:select', setMontoPorNotaCredito);
        
      });
  }

  function setMontoPorNotaCredito() {
  if (document.getElementById('metodoPago').value !== 'NotaCredito') return;

  const sel = document.getElementById('notaCreditoSelect');

  // ‚úÖ L√çNEA NUEVA (aqu√≠ es donde va):
  const opt = sel.querySelector(`option[value="${sel.value}"]`);

  if (opt && opt.dataset.monto) {
    document.getElementById('montoAbono').value = parseFloat(opt.dataset.monto).toFixed(2);
    document.getElementById('montoAbono').readOnly = true;
  } else {
    document.getElementById('montoAbono').value = '';
    document.getElementById('montoAbono').readOnly = false;
  }
}


  /*********************** REGISTRAR ABONO *************************/
  function generateReference() {
      const now = new Date();
      const yyyy = now.getFullYear();
      const mm = String(now.getMonth() + 1).padStart(2, '0');
      const dd = String(now.getDate()).padStart(2, '0');
      const hh = String(now.getHours()).padStart(2, '0');
      const min = String(now.getMinutes()).padStart(2, '0');
      const ss = String(now.getSeconds()).padStart(2, '0');
      return `${yyyy}${mm}${dd}${hh}${min}${ss}`;
    }
  
  async function registrarAbono() {

    const currentUser = JSON.parse(sessionStorage.getItem('currentUser') || 'null');
    if (!currentUser) {
      alert('Sesi√≥n expirada. Inici√° de nuevo.');
      return window.location.href = 'index.html';
    }
    
    const clienteId = document.getElementById('clienteSelect').value;
    const facturaId = document.getElementById('facturaSelect').value;
    const monto = parseFloat(document.getElementById('montoAbono').value);
    const ruta = document.getElementById('rutaAbono').value;
    const metodo = document.getElementById('metodoPago').value;
    let banco = document.getElementById('bancoSelect').value;
    let referenciaBancaria = document.getElementById('referenciaBancaria').value.trim();
    
    if (metodo === 'Efectivo' || metodo === 'NotaCredito') {
        banco = 'N/A';
        referenciaBancaria = 'N/A';
    }

    const notaCreditoId = document.getElementById('notaCreditoSelect').value;

    // Validaciones b√°sicas
    if (!clienteId || !facturaId) return alert('Seleccione cliente y factura');
    if (isNaN(monto) || monto<=0) return alert('Monto inv√°lido');
    if (metodo==='Transferencia' && !referenciaBancaria) return alert('Ingrese referencia bancaria');
    if (metodo==='NotaCredito' && !notaCreditoId) return alert('Seleccione una nota de cr√©dito');

    let createdAbonoPath = null;  
    
    try {
      await db.runTransaction(async (tx) => {
        const facturaRef = db.collection('facturas').doc(facturaId);
        const facturaSnap = await tx.get(facturaRef);
        if (!facturaSnap.exists) throw new Error('La factura no existe');
        const facturaData = facturaSnap.data();
        //const saldoActual = facturaData.saldo!==undefined ? facturaData.saldo : facturaData.total;
        const saldoActual = Math.round((facturaData.saldo !== undefined ? facturaData.saldo : facturaData.total) * 100) / 100;
        if (saldoActual<=0) throw new Error('La factura ya est√° saldada');
        if (monto>saldoActual) {
          console.log("Monto:"  + monto + " Saldo Actual:" + saldoActual);
          throw new Error('El abono excede el saldo pendiente');
        }
        // Preparar datos abono
        const nuevoSaldo = saldoActual - monto;
        const fecha = new Date();
        const abonoRef = facturaRef.collection('abonos').doc();
        createdAbonoPath = abonoRef.path;         // üëà NUEVO (guardamos la ruta del abono)
        const abonoData = {
          clientId: clienteId,
          amount: monto,
          pendingBalance: nuevoSaldo,
          dateTime: fecha,
          route: ruta,
          metodoPago: metodo,
          banco: banco,
          referenciaBancaria: (metodo==='Transferencia')? referenciaBancaria : null,
          notaCreditoId: (metodo==='NotaCredito')? notaCreditoId : null,
          reference: generateReference(),
          usuario: {
            username: currentUser.username,
            fullName: currentUser.fullName
          }
        };

        // Actualizar factura
        tx.update(facturaRef,{ saldo: nuevoSaldo });
        // Crear abono
        tx.set(abonoRef, abonoData);

        // Si es nota cr√©dito, marcar nota con abonoId
        if (metodo==='NotaCredito') {
          const notaRef = db.collection('notasCredito').doc(notaCreditoId);
          tx.update(notaRef,{ abonoId: abonoRef.id });
        }
      });

      // ‚úÖ Despu√©s del commit: calculamos y escribimos el snapshot total
      const saldoTotalCliente = await calcularSaldoPendienteTotalCliente(clienteId);
      if (createdAbonoPath) {
        await db.doc(createdAbonoPath).update({
        saldoPendienteTotalCliente: saldoTotalCliente
        });
      }

      const clienteNombre =
      clientesMap[clienteId] ||
      $('#clienteSelect option:selected').text(); 

      toast('‚úÖ Abono registrado');
      mostrarReciboEnPantalla({
        clienteNombre,
        facturaId,
        monto,
        saldoPendiente: (document.querySelector(`#facturaSelect option[value="${facturaId}"]`).dataset.saldo - monto),
        saldoPendienteTotalCliente: saldoTotalCliente,   // üëà NUEVO
        fecha: new Date(),
        ruta,
        metodo,
        banco,
        referenciaBancaria,
        notaCreditoId,
        currentUser
      });

      limpiarFormulario(false);
      cargarFacturasCredito();
      cargarHistorialAbonos();
    } catch(err) {
      console.error(err);
      alert('Error: '+err.message);
    }
  }

  /*********************** RECIBO *************************/

    function mostrarReciboEnPantalla({ clienteNombre, facturaId, monto, saldoPendiente, saldoPendienteTotalCliente, fecha, ruta, metodo, banco, referenciaBancaria, notaCreditoId, currentUser }) {
    const div = document.getElementById('recibo');
    const fechaStr = fecha.toLocaleString();
  
    let metodoTxt = metodo;
    if (metodo==='Transferencia') metodoTxt += ` (${banco} #${referenciaBancaria})`;
    if (metodo==='NotaCredito')  metodoTxt += ` (NC: ${notaCreditoId})`;
  
    document.getElementById('reciboContainer').style.display = 'block';
    div.innerHTML = `
      <h3 style="text-align:center;">Recibo de Abono</h3>
      <p><strong>Fecha:</strong> ${fechaStr}</p>
      <p><strong>Cliente:</strong> ${clienteNombre || 'N/A'}</p>
      <p><strong>Registrado por:</strong> ${currentUser.fullName || currentUser.username}</p>
      <p><strong>Factura #:</strong> ${facturaId}</p>
      <p><strong>M√©todo de Pago:</strong> ${metodoTxt}</p>
      <hr>
      <p><strong>Abonado:</strong> C$${Number(monto).toFixed(2)}</p>
      <p><strong>Saldo Pendiente a Factura:</strong> C$${Number(saldoPendiente).toFixed(2)}</p>
      <p><strong>Saldo Pendiente Total:</strong> C$${Number(saldoPendienteTotalCliente || 0).toFixed(2)}</p>
    `;
    document.getElementById('reciboContainer').style.display = 'block';
  }

  function imprimirRecibo() {
    const contenido = document.getElementById('recibo').innerHTML;
    const w = window.open('', '_blank', 'width=800,height=600');
    w.document.write(`<!DOCTYPE html><html><head><title>Recibo</title><style>body{font-family:Arial;margin:20px;}hr{margin:10px 0;}</style></head><body>${contenido}</body></html>`);
    w.document.close();
    w.focus();
    w.print();
    w.close();
  }

  /*********************** LIMPIAR FORM *************************/
  function limpiarFormulario(resetCliente=true) {
    if (resetCliente) {
      $('#clienteSelect').val(null).trigger('change');
    }
    $('#facturaSelect').val(null).trigger('change');
    document.getElementById('montoAbono').value='';
    document.getElementById('montoAbono').readOnly=false;
    document.getElementById('metodoPago').value='Efectivo';
    document.getElementById('referenciaBancaria').value='';
    $('#notaCreditoSelect').val(null).trigger('change');
    toggleMetodoPago();
    document.getElementById('reciboContainer').style.display='none';
  }

  /*********************** HISTORIAL *************************/
/*function cargarHistorialAbonos() {
  const tbody = document.getElementById('tablaHistorial');
  tbody.innerHTML = '';

  db.collectionGroup('abonos')
    .orderBy('dateTime', 'desc')
    .limit(20)
    .get()
    .then(qs => {
      qs.forEach(doc => {
        const a = doc.data();
        const facturaId = doc.ref.parent.parent.id;
        const abonoId = doc.id; // capturamos el ID del abono
        const fecha = (typeof a.dateTime.toDate === 'function') ? a.dateTime.toDate() : new Date(a.dateTime);

        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${fecha.toLocaleString()}</td>
          <td>
            <button onclick="viewInvoiceDetail('${facturaId}')" style="padding:5px 10px; background:#007bff; color:white; border:none; border-radius:4px; cursor:pointer;">
              ${facturaId}
            </button>
          </td>
          <td>${(a.usuario && (a.usuario.fullName || a.usuario.username)) || 'Administrador'}</td>
          <td>${a.metodoPago}</td>
          <td>C$${a.amount.toFixed(2)}</td>
          <td>C$${a.pendingBalance.toFixed(2)}</td>
          <td>
            <button onclick="eliminarAbono('${facturaId}', '${abonoId}')" style="padding:5px 10px; background:#dc3545; color:white; border:none; border-radius:4px;">Eliminar</button>
          </td>
        `;
        tbody.appendChild(tr);
      });
    });
}*/
function cargarHistorialAbonos() {
  // Mantengo el nombre por compatibilidad con tu c√≥digo existente
  setupHistorialInfiniteScroll();
}

async function eliminarAbono(facturaId, abonoId) {
  if (!confirm("¬øEst√°s seguro que deseas eliminar este abono?")) return;

  const facturaRef = db.collection('facturas').doc(facturaId);
  const abonoRef = facturaRef.collection('abonos').doc(abonoId);

  try {
    await db.runTransaction(async (tx) => {
      const abonoSnap = await tx.get(abonoRef);
      if (!abonoSnap.exists) throw new Error("El abono no existe");

      const abonoData = abonoSnap.data();
      const monto = abonoData.amount;
      const notaCreditoId = abonoData.notaCreditoId || null;

      const facturaSnap = await tx.get(facturaRef);
      const facturaData = facturaSnap.data();

      const nuevoSaldo = (facturaData.saldo || 0) + monto;

      // Actualizar saldo de la factura
      tx.update(facturaRef, { saldo: nuevoSaldo });

      // Eliminar el abono
      tx.delete(abonoRef);

      // Si ten√≠a nota de cr√©dito asociada, liberarla
      if (notaCreditoId) {
        const notaRef = db.collection("notasCredito").doc(notaCreditoId);
        tx.update(notaRef, { abonoId: null });
      }
    });

    // üîÅ Reencadenar pendingBalance de los abonos restantes de la misma factura
    await recalcularSaldosFactura(facturaId);
    toast("‚úÖ Abono eliminado y saldos reencadenados");
    
    cargarFacturasCredito();
    cargarHistorialAbonos();
  } catch (err) {
    console.error(err);
    alert("Error al eliminar abono: " + err.message);
  }
}
  
  // Cargar historial de arranque
  cargarHistorialAbonos();

function agruparItemsFactura(items) {
  const grupos = {};
  items.forEach(item => {
    const key = `${item.brand} ${item.model}`;
    if (!grupos[key]) {
      grupos[key] = {
        brand: item.brand,
        model: item.model,
        quantity: 0,
        price: item.price,
        discount: item.discount,
        total: 0,
        imeis: []
      };
    }
    grupos[key].quantity += item.quantity || 1;
    grupos[key].total += item.total || 0;
    if (item.imei) grupos[key].imeis.push(item.imei);
  });
  return Object.values(grupos);
}

function closeInvoiceModal() {
  document.getElementById('invoiceModal').style.display = 'none';
}  

function viewInvoiceDetail(invoiceId) {
  db.collection("facturas").doc(invoiceId).get().then((doc) => {
    if(doc.exists) {
      const invoice = doc.data();
      window.__currentInvoiceItems = invoice.items;
      db.collection("clientes").doc(invoice.clientId).get().then((clientDoc) => {
        const client = clientDoc.data();
        let currencySymbol = invoice.currency === 'CORD' ? 'C$' : '$';
        let currencyText = invoice.currency === 'CORD' ? 'C√≥rdobas (C$)' : 'D√≥lares ($)';

        // Mostrar "ANULADA" si es true
        let invoiceStatus = invoice.anulada 
          ? `<span style="color: red; font-weight: bold;">ANULADA</span>` 
          : '';

        let fecha = (typeof invoice.fecha.toDate === "function") 
        ? invoice.fecha.toDate()
        : new Date(invoice.fecha);
        /*
            <div class="invoice-header">
            <h2>Factura - ${invoiceId} ${invoiceStatus}</h2>
            <p class="currency"><strong>Consecutivo:</strong> ${invoice.consecutivo || 'N/A'}</p>
            <p class="route"><strong>Ruta de la Factura:</strong> ${invoice.route}</p>
            </div>
        */
        const invoiceHTML = `
        
         ${renderInvoiceHeader(invoiceId, invoice.consecutivo, invoice.route)}

          <div class="invoice-body">
            <table class="details-table">
              <tr>
                <td><strong>Fecha y Hora:</strong><br>${fecha}</td>
                <td><strong>Cliente:</strong><br>${client ? client.nombreCliente : "N/A"}</td>
              </tr>
              <tr>
                <td><strong>Tienda:</strong><br>${client ? client.nombreTienda : "N/A"}</td>
                <td><strong>Direcci√≥n:</strong><br>${client ? client.direccion : "N/A"}</td>
              </tr>
              <tr>
                <td><strong>Tel√©fono:</strong><br>${client ? client.telefono : "N/A"}</td>
                <td><strong>Pago:</strong><br>${invoice.paymentMethod || 'N/A'}</td>
              </tr>
            </table>
            <table class="items-table">
              <tr>
                <th>Cantidad</th>
                <th>Descripci√≥n</th>
                <th>Precio Venta</th>
                <th>Descuento</th>
                <th>Total</th>
              </tr>
              ${agruparItemsFactura(invoice.items).map(item => `
                <tr>
                  <td>${item.quantity}</td>
                  <td>
                    ${item.brand} ${item.model}<br>
                    <small>
                      ${item.imeis.length > 0 ? 'IMEIs:<br>' + item.imeis.map(i => `- ${i}`).join('<br>') : ''}
                    </small>
                  </td>
                  <td>${currencySymbol}${item.price.toFixed(2)}</td>
                  <td>${item.discount}%</td>
                  <td>${currencySymbol}${item.total.toFixed(2)}</td>
                </tr>
              `).join('')}
              <tr>
                <td colspan="4" style="text-align: right;"><strong>Total a Pagar:</strong></td>
                <td><strong>${currencySymbol}${invoice.total.toFixed(2)}</strong></td>
              </tr>
            </table>
        `;
        document.getElementById('modalInvoiceContent').innerHTML = invoiceHTML;
        document.getElementById('invoiceModal').style.display = 'block';
      });
    }
  }).catch((error) => {
    console.error("Error al ver factura: ", error);
  });
}

function renderInvoiceHeader(invoiceId, consecutivo, ruta) {
return `
  <div style="display: flex; align-items: center; justify-content: flex-start; margin-bottom: 20px;">
    <div style="flex: 0 0 130px;">
      <img src="https://facturacionweb.github.io/facturacionweb/galaxia.jpg" 
           alt="Logo del negocio" 
           style="width: 100%; height: auto; border-radius: 10px; box-shadow: 0 0 5px rgba(0,0,0,0.1);" />
    </div>
    <div style="flex: 1; text-align: left; padding-left: 20px;">
      <h2 style="margin: 0 0 5px 0;">Factura - ${invoiceId}</h2>
      <p style="margin: 5px 0;"><strong>Consecutivo:</strong> ${consecutivo || 'N/A'}</p>
      <p style="margin: 5px 0;"><strong>Ruta de la Factura:</strong> ${ruta || 'N/A'}</p>
    </div>
  </div>
`;
}

  function renderAbonoRow(doc) {
  const a = doc.data();
  const facturaId = doc.ref.parent.parent.id;
  const abonoId = doc.id;
  const fecha = (typeof a.dateTime?.toDate === 'function') ? a.dateTime.toDate() : new Date(a.dateTime);

  const tr = document.createElement('tr');
  tr.innerHTML = `
    <td>
      <div style="display:flex; gap:6px; justify-content:center; flex-wrap:wrap;">
          <button onclick="imprimirReciboAbono('${facturaId}','${abonoId}')"> üñ®Ô∏è </button>
          
          <button
            onclick="imprimirReciboAbonoMovil('${facturaId}','${abonoId}')"
            title="Imprimir abono m√≥vil"
            style="padding:5px 10px;background:#17a2b8;color:#fff;border:none;border-radius:4px;cursor:pointer;">
            üì±
          </button>
      </div>
    </td>
    <td>${fecha.toLocaleString()}</td>
    <td>
      <button onclick="viewInvoiceDetail('${facturaId}')" style="padding:5px 10px;background:#007bff;color:white;border:none;border-radius:4px;cursor:pointer;">
        ${facturaId}
      </button>
    </td>
    <td>${(a.usuario && (a.usuario.fullName || a.usuario.username)) || 'Administrador'}</td>
    <td>${a.metodoPago}</td>
    <td>C$${a.amount.toFixed(2)}</td>
    <td>C$${a.pendingBalance.toFixed(2)}</td>
    <td>
      <button onclick="eliminarAbono('${facturaId}', '${abonoId}')" style="padding:5px 10px; background:#dc3545; color:white; border:none; border-radius:4px;">Eliminar</button>
    </td>
  `;
  return tr;
}

  async function imprimirReciboAbono(facturaId, abonoId) {
  try {
    const abonoRef = db.collection('facturas').doc(facturaId).collection('abonos').doc(abonoId);
    const snap = await abonoRef.get();
    if (!snap.exists) {
      alert('No se encontr√≥ el abono.');
      return;
    }

    const a = snap.data();
    const fecha = (typeof a.dateTime?.toDate === 'function') ? a.dateTime.toDate() : new Date(a.dateTime);

    // ‚úÖ Tomamos el snapshot si existe; si no, lo calculamos en vivo
    const totalCliente = (a.saldoPendienteTotalCliente != null)
    ? a.saldoPendienteTotalCliente
    : await calcularSaldoPendienteTotalCliente(a.clientId);

    const clienteNombre = clientesMap[a.clientId] || a.clientId;
    // Reusamos tu funci√≥n existente para renderizar el recibo en el contenedor
    // y luego llamamos a imprimir.
    mostrarReciboEnPantalla({
      clienteNombre,
      facturaId: facturaId,
      monto: a.amount,
      saldoPendiente: a.pendingBalance,
      saldoPendienteTotalCliente: totalCliente,    // üëà PASARLO ES LA CLAVE
      fecha: fecha,
      ruta: a.route || 'SIN RUTA',
      metodo: a.metodoPago || 'N/A',
      banco: a.banco || 'N/A',
      referenciaBancaria: a.referenciaBancaria || 'N/A',
      notaCreditoId: a.notaCreditoId || null,
      // Mostramos "Registrado por" con el usuario que qued√≥ guardado en el abono
      currentUser: {
        fullName: (a.usuario && a.usuario.fullName) || (a.usuario && a.usuario.username) || 'Administrador',
        username: (a.usuario && a.usuario.username) || 'admin'
      }
    });

    // Abre la ventana de impresi√≥n con el HTML del recibo
    imprimirRecibo();
  } catch (err) {
    console.error(err);
    alert('Error generando recibo: ' + err.message);
  }
}

/* =========================================================
   IMPRESI√ìN M√ìVIL (Bluetooth / App Android)
   - Env√≠a texto formateado al WebView (AndroidBridge.printTicket)
   - Usa el mismo estilo de tags que facturas.html ([C], [L], <b>, etc.)
========================================================= */

  function formatDateShort(d) {
    try {
      const dt = (d instanceof Date) ? d : new Date(d);
      const pad = (n) => String(n).padStart(2, '0');
      return `${pad(dt.getDate())}/${pad(dt.getMonth() + 1)}/${dt.getFullYear()} ${pad(dt.getHours())}:${pad(dt.getMinutes())}`;
    } catch (_) {
      return String(d || '');
    }
  }
  
  function formatCordobas(n) {
    const num = Number(n);
    if (Number.isNaN(num)) return 'C$0.00';
    return `C$${num.toFixed(2)}`;
  }
  
  function buildAbonoThermalText(payload) {
    const {
      clienteNombre,
      facturaId,
      fecha,
      ruta,
      metodo,
      banco,
      referenciaBancaria,
      notaCreditoId,
      monto,
      saldoPendiente,
      saldoPendienteTotalCliente,
      usuario
    } = payload || {};
  
    const LINE = "================================";
    const SEP  = "--------------------------------";
  
    const parts = [];
    parts.push("[C]<b>RECIBO DE ABONO</b>");
    parts.push("[C]" + SEP);
  
    parts.push(`[L]Fecha: ${formatDateShort(fecha)}`);
    parts.push(`[L]Cliente: ${clienteNombre || 'N/A'}`);
    parts.push(`[L]Factura: ${facturaId || 'N/A'}`);
    if (ruta) parts.push(`[L]Ruta: ${ruta}`);
  
    const metodoTxt = metodo || 'N/A';
    parts.push(`[L]M√©todo: ${metodoTxt}`);
  
    // Detalles extra seg√∫n m√©todo
    const mLower = String(metodoTxt).toLowerCase();
    if (mLower.includes("transfer")) {
      if (banco) parts.push(`[L]Banco: ${banco}`);
      if (referenciaBancaria) parts.push(`[L]Ref: ${referenciaBancaria}`);
    }
    if (mLower.includes("nota")) {
      if (notaCreditoId) parts.push(`[L]Nota cr√©dito: ${notaCreditoId}`);
    }
  
    parts.push("[C]" + SEP);
  
    parts.push(`[L]Monto abonado: ${formatCordobas(monto)}`);
    parts.push(`[L]Saldo factura: ${formatCordobas(saldoPendiente)}`);
    parts.push(`[L]Saldo cliente: ${formatCordobas(saldoPendienteTotalCliente)}`);
  
    parts.push("[C]" + SEP);
    if (usuario) parts.push(`[L]Registrado por: ${usuario}`);
  
    parts.push("");
    parts.push("[C]Gracias por su pago");
    parts.push("[C]" + LINE);
    parts.push("");
  
    return parts.join("\n");
  }
  
  async function imprimirReciboAbonoMovil(facturaId, abonoId) {
    try {
      const abonoRef = db.collection('facturas').doc(facturaId).collection('abonos').doc(abonoId);
      const snap = await abonoRef.get();
      if (!snap.exists) {
        alert('No se encontr√≥ el abono.');
        return;
      }
  
      const a = snap.data();
      const fecha = (typeof a.dateTime?.toDate === 'function') ? a.dateTime.toDate() : new Date(a.dateTime);
  
      const totalCliente = (a.saldoPendienteTotalCliente != null)
        ? a.saldoPendienteTotalCliente
        : await calcularSaldoPendienteTotalCliente(a.clientId);
  
      const clienteNombre = clientesMap[a.clientId] || a.clientId;
      const usuario = (a.usuario && (a.usuario.fullName || a.usuario.username)) || 'Administrador';
  
      const finalText = buildAbonoThermalText({
        clienteNombre,
        facturaId,
        fecha,
        ruta: a.route || '',
        metodo: a.metodoPago || 'N/A',
        banco: a.banco || '',
        referenciaBancaria: a.referenciaBancaria || '',
        notaCreditoId: a.notaCreditoId || '',
        monto: a.amount,
        saldoPendiente: a.pendingBalance,
        saldoPendienteTotalCliente: totalCliente,
        usuario
      });
  
      if (typeof AndroidBridge !== "undefined" && AndroidBridge.printTicket) {
        AndroidBridge.printTicket(finalText);
      } else {
        alert("AndroidBridge no est√° disponible. ¬øEst√°s en la app Android?");
      }
  
    } catch (err) {
      alert('Error en impresi√≥n m√≥vil: ' + err.message);
    }
  }

  

/* =========================================================
   RECIBO ABONO M√öLTIPLE (WEB + M√ìVIL)
   - Se genera despu√©s de aplicar el lote (abono m√∫ltiple)
========================================================= */

function renderMultiReciboHtml(payload) {
  const p = payload || {};
  const fecha = (p.fecha instanceof Date) ? p.fecha : new Date(p.fecha || Date.now());
  const fechaStr = fecha.toLocaleString();

  let metodoTxt = p.metodo || 'N/A';
  if ((p.metodo || '').toLowerCase().includes('transfer')) {
    metodoTxt += ` (${p.banco || 'N/A'} #${p.referenciaBancaria || 'N/A'})`;
  }

  const items = Array.isArray(p.items) ? p.items : [];
  const total = Number(p.totalAplicado || 0);

  const rows = items.map((it, idx) => {
    const facturaId = it.facturaId || 'N/A';
    const consecutivo = it.consecutivo || 'N/A';
    const saldoAntes = Number(it.saldoAntes || 0);
    const monto = Number(it.monto || 0);
    const saldoDespues = Number(it.saldoDespues || 0);

    return `
      <tr>
        <td style="text-align:center;">${idx + 1}</td>
        <td>${facturaId}</td>
        <td>${consecutivo}</td>
        <td style="text-align:right;">${cord(saldoAntes)}</td>
        <td style="text-align:right;">${cord(monto)}</td>
        <td style="text-align:right;">${cord(saldoDespues)}</td>
      </tr>
    `;
  }).join('');

  return `
    <h3 style="text-align:center;">Recibo de Abono M√∫ltiple</h3>
    <p><strong>Fecha:</strong> ${fechaStr}</p>
    <p><strong>Cliente:</strong> ${p.clienteNombre || 'N/A'}</p>
    <p><strong>Registrado por:</strong> ${p.usuarioNombre || 'N/A'}</p>
    <p><strong>M√©todo de Pago:</strong> ${metodoTxt}</p>
    <p><strong>Referencia lote:</strong> ${p.refBase || 'N/A'}</p>
    <hr>
    <p><strong>Total abonado:</strong> ${cord(total)}</p>
    <p><strong>Saldo Pendiente Total:</strong> ${cord(Number(p.saldoPendienteTotalCliente || 0))}</p>

    <div style="margin-top:12px;">
      <table style="width:100%; border-collapse:collapse;" border="1" cellpadding="6">
        <thead>
          <tr style="background:#f3f3f3;">
            <th style="width:40px;">#</th>
            <th>Factura</th>
            <th>Consecutivo</th>
            <th>Saldo antes</th>
            <th>Abono</th>
            <th>Saldo despu√©s</th>
          </tr>
        </thead>
        <tbody>
          ${rows || `<tr><td colspan="6" style="text-align:center;">Sin detalle</td></tr>`}
        </tbody>
        <tfoot>
          <tr>
            <td colspan="4" style="text-align:right;"><strong>Total</strong></td>
            <td style="text-align:right;"><strong>${cord(total)}</strong></td>
            <td></td>
          </tr>
        </tfoot>
      </table>
    </div>
  `;
}

function printHtmlInNewWindow(html) {
  const w = window.open('', '_blank', 'width=900,height=650');
  w.document.write(`<!DOCTYPE html><html><head><title>Recibo</title>
    <style>
      body{font-family:Arial;margin:20px;color:#111;}
      hr{margin:10px 0;}
      table{font-size:13px;}
      th,td{border:1px solid #ddd;}
    </style>
  </head><body>${html}</body></html>`);
  w.document.close();
  w.focus();
  w.print();
  w.close();
}

function mostrarReciboMultiPreview(payload) {
  const div = document.getElementById('multiReciboPreview');
  if (!div) return;
  div.innerHTML = renderMultiReciboHtml(payload);
  div.style.display = 'block';
}

function imprimirReciboMultiWeb() {
  if (!lastMultiReceiptPayload) {
    alert('Todav√≠a no hay un recibo listo. Primero aplic√° los abonos.');
    return;
  }
  const html = renderMultiReciboHtml(lastMultiReceiptPayload);
  printHtmlInNewWindow(html);
}

function buildMultiAbonoThermalText(payload) {
  const p = payload || {};
  const LINE = "================================";
  const SEP  = "--------------------------------";

  const parts = [];
  parts.push("[C]<b>RECIBO ABONO MULTIPLE</b>");
  parts.push("[C]" + SEP);

  parts.push(`[L]Fecha: ${formatDateShort(p.fecha)}`);
  parts.push(`[L]Cliente: ${p.clienteNombre || 'N/A'}`);
  parts.push(`[L]Registrado: ${p.usuarioNombre || 'N/A'}`);
  parts.push(`[L]Ref lote: ${p.refBase || 'N/A'}`);

  const metodoTxt = p.metodo || 'N/A';
  parts.push(`[L]Metodo: ${metodoTxt}`);

  const mLower = String(metodoTxt).toLowerCase();
  if (mLower.includes("transfer")) {
    if (p.banco) parts.push(`[L]Banco: ${p.banco}`);
    if (p.referenciaBancaria) parts.push(`[L]Ref: ${p.referenciaBancaria}`);
  }

  parts.push("[C]" + SEP);

  const items = Array.isArray(p.items) ? p.items : [];
  items.forEach((it, idx) => {
    const facturaId = it.facturaId || 'N/A';
    const monto = it.monto || 0;
    const saldoDespues = it.saldoDespues || 0;

    parts.push(`[L]${idx + 1}. F:${facturaId}`);
    parts.push(`[L]   Abono: ${formatCordobas(monto)}`);
    parts.push(`[L]   Saldo: ${formatCordobas(saldoDespues)}`);
  });

  parts.push("[C]" + SEP);
  parts.push(`[L]Total abonado: ${formatCordobas(p.totalAplicado || 0)}`);
  parts.push(`[L]Saldo cliente: ${formatCordobas(p.saldoPendienteTotalCliente || 0)}`);

  parts.push("[C]" + SEP);
  parts.push("[C]Gracias por su pago");
  parts.push("[C]" + LINE);
  parts.push("");

  return parts.join("\n");
}

function imprimirReciboMultiMovil() {
  if (!lastMultiReceiptPayload) {
    alert('Todav√≠a no hay un recibo listo. Primero aplic√° los abonos.');
    return;
  }

  const finalText = buildMultiAbonoThermalText(lastMultiReceiptPayload);

  if (typeof AndroidBridge !== "undefined" && AndroidBridge.printTicket) {
    AndroidBridge.printTicket(finalText);
  } else {
    alert("AndroidBridge no est√° disponible. ¬øEst√°s en la app Android?");
  }
}

async function loadMoreAbonos() {
    if (histLoading || histDone) return;
    histLoading = true;
    document.getElementById('histLoading').style.display = 'block';
  
    try {
      let q = histQuery.limit(HIST_PAGE_SIZE);
      if (histCursor) q = q.startAfter(histCursor);
  
      const snap = await q.get();
  
      // ¬øNo hay m√°s?
      if (snap.empty) {
        histDone = true;
        document.getElementById('histLoading').textContent = 'No hay m√°s abonos.';
        if (histObserver) histObserver.disconnect();
        return;
      }
  
      const tbody = document.getElementById('tablaHistorial');
      snap.forEach(doc => tbody.appendChild(renderAbonoRow(doc)));
  
      // actualiza cursor
      histCursor = snap.docs[snap.docs.length - 1];
  
      // Si vino menos de lo pedido, llegamos al final
      if (snap.size < HIST_PAGE_SIZE) {
        histDone = true;
        document.getElementById('histLoading').textContent = 'Fin del historial.';
        if (histObserver) histObserver.disconnect();
      } else {
        document.getElementById('histLoading').style.display = 'none';
      }
    } catch (err) {
      console.error(err);
      alert('Error al cargar historial: ' + err.message);
    } finally {
      histLoading = false;
    }
}

function setupHistorialInfiniteScroll() {
  // query base
  histQuery = db.collectionGroup('abonos').orderBy('dateTime', 'desc');

  // reset de estado
  histCursor = null;
  histLoading = false;
  histDone = false;

  // limpia tabla
  const tbody = document.getElementById('tablaHistorial');
  tbody.innerHTML = '';

  // desconecta observer previo
  if (histObserver) histObserver.disconnect();

  const sentinel = document.getElementById('histSentinel');
  histObserver = new IntersectionObserver(entries => {
    const entry = entries[0];
    if (entry.isIntersecting) {
      loadMoreAbonos();
    }
  }, { root: null, rootMargin: '200px', threshold: 0 });

  histObserver.observe(sentinel);

  // primera p√°gina
  loadMoreAbonos();
}

  const btnLoadMore = document.getElementById('btnLoadMore');
  btnLoadMore.onclick = loadMoreAbonos;
  
  function enableLoadMoreButtonMode() {
    // Mostrar bot√≥n y desactivar observer
    if (histObserver) histObserver.disconnect();
    btnLoadMore.style.display = 'block';
    document.getElementById('histSentinel').style.display = 'none';
  }

  /*L√≥gica de multi-abonos*/
    /************* ABONO M√öLTIPLE ‚Äì ESTADO *************/
  let multiFacturas = []; // [{id, fecha, consecutivo, total, saldo, proyectado, abono}]
  let multiObserverAttached = false;
  let lastMultiReceiptPayload = null; // snapshot para imprimir recibo del lote
  
  /************* ABONO M√öLTIPLE ‚Äì UI HOOK *************/
  window.addEventListener('load', () => {
    const btnMulti = document.getElementById('btnAbonoMultiple');
    if (btnMulti) {
      btnMulti.addEventListener('click', openMultiAbonoModal);
    }
  });
  
  /************* Utils *************/
  function cord(n) {
    if (isNaN(n)) return 'C$0.00';
    return 'C$' + (Math.round(n * 100) / 100).toFixed(2);
  }
  function toDateMaybe(tsOrDate) {
    // Firestore Timestamp o Date/ISO
    if (tsOrDate && typeof tsOrDate.toDate === 'function') return tsOrDate.toDate();
    return new Date(tsOrDate);
  }


  /************* M√©todo de Pago (multi) *************/
  function toggleMultiMetodoPago() {
    const metodo = document.getElementById('multiMetodoPago')?.value || 'Efectivo';
    const info = document.getElementById('multiInfoTransferencia');
    if (!info) return;
    info.style.display = (metodo === 'Transferencia') ? 'block' : 'none';
  }

  /************* Modal *************/
  function openMultiAbonoModal() {
    const clienteId = document.getElementById('clienteSelect').value;
    if (!clienteId) {
      alert('Seleccion√° primero un cliente.');
      return;
    }
  
    // Limpia estado
    multiFacturas = [];
    document.getElementById('multiAbonoTbody').innerHTML = '';
    document.getElementById('multiMonto').value = '';
    updateMultiResumen(0, 0);
  
    // Reset impresi√≥n multi
    lastMultiReceiptPayload = null;
    const btnPW = document.getElementById('btnImprimirMultiWeb');
    const btnPM = document.getElementById('btnImprimirMultiMovil');
    if (btnPW) btnPW.disabled = true;
    if (btnPM) btnPM.disabled = true;
    const prev = document.getElementById('multiReciboPreview');
    if (prev) { prev.style.display = 'none'; prev.innerHTML = ''; }
    const st = document.getElementById('multiReciboStatus');
    if (st) st.textContent = '';
    const btnAp = document.getElementById('btnAplicarAbonos');
    if (btnAp) btnAp.disabled = true;
    const btnDist = document.getElementById('btnDistribuir');
    if (btnDist) btnDist.disabled = false;
  
    
    // Reset m√©todo de pago multi (por defecto: efectivo)
    const selMultiMetodo = document.getElementById('multiMetodoPago');
    if (selMultiMetodo) selMultiMetodo.value = 'Efectivo';
    const selMultiBanco = document.getElementById('multiBancoSelect');
    if (selMultiBanco) selMultiBanco.value = 'BAC';
    const inpMultiRef = document.getElementById('multiReferenciaBancaria');
    if (inpMultiRef) inpMultiRef.value = '';
    if (document.getElementById('multiInfoTransferencia')) {
      document.getElementById('multiInfoTransferencia').style.display = 'none';
    }
// Cargar facturas del cliente con saldo > 0 (m√°s antiguas primero)
    db.collection('facturas')
      .where('clientId', '==', clienteId)
      .where('paymentType', '==', 'Credito')
      .where('anulada', '==', false)
      .orderBy('fecha', 'asc')
      .get()
      .then(qs => {
        const tbody = document.getElementById('multiAbonoTbody');
        qs.forEach(doc => {
          const f = doc.data();
          const total = f.total;
          const saldo = (f.saldo !== undefined ? f.saldo : total);
          if (saldo <= 0) return; // solo con saldo pendiente
  
          const fecha = toDateMaybe(f.fecha);
          const row = {
            id: doc.id,
            fecha,
            consecutivo: f.consecutivo || 'N/A',
            total: Math.round(total * 100) / 100,
            saldo: Math.round(saldo * 100) / 100,
            proyectado: Math.round(saldo * 100) / 100,
            abono: 0
          };
          multiFacturas.push(row);
  
          const tr = document.createElement('tr');
          tr.dataset.facturaId = row.id;
          tr.innerHTML = `
            <td>${fecha.toLocaleString()}</td>
            <td>${row.id}</td>
            <td>${row.consecutivo}</td>
            <td style="text-align:right;">${cord(row.total)}</td>
            <td style="text-align:right;" data-col="saldo">${cord(row.saldo)}</td>
            <td style="text-align:right;" data-col="proyectado">${cord(row.proyectado)}</td>
          `;
          tbody.appendChild(tr);
        });
  
        if (multiFacturas.length === 0) {
          const tr = document.createElement('tr');
          tr.innerHTML = `<td colspan="6" style="text-align:center; padding:12px;">Este cliente no tiene facturas con saldo pendiente.</td>`;
          document.getElementById('multiAbonoTbody').appendChild(tr);
        }
      })
      .catch(err => {
        console.error(err);
        alert('Error al cargar facturas: ' + err.message);
      });
  
    // Bindear botones del modal (una sola vez)
    if (!multiObserverAttached) {
      document.getElementById('btnDistribuir').addEventListener('click', distribuirAbonos);
      document.getElementById('btnAplicarAbonos').addEventListener('click', aplicarAbonos);

      // Impresi√≥n del recibo multi (web + m√≥vil)
      const btnPW = document.getElementById('btnImprimirMultiWeb');
      const btnPM = document.getElementById('btnImprimirMultiMovil');
      if (btnPW) btnPW.addEventListener('click', imprimirReciboMultiWeb);
      if (btnPM) btnPM.addEventListener('click', imprimirReciboMultiMovil);

      const mp = document.getElementById('multiMetodoPago');
      if (mp) mp.addEventListener('change', toggleMultiMetodoPago);
multiObserverAttached = true;
    }
  
    document.getElementById('multiAbonoModal').style.display = 'block';

    // Ajustar UI seg√∫n m√©todo seleccionado
    toggleMultiMetodoPago();
  }
  
  function closeMultiAbonoModal() {
    document.getElementById('multiAbonoModal').style.display = 'none';
  }
  
  /************* Distribuci√≥n *************/
  function distribuirAbonos() {
    let monto = parseFloat(document.getElementById('multiMonto').value);
    if (isNaN(monto) || monto <= 0) {
      alert('Ingres√° un monto v√°lido a distribuir.');
      return;
    }
    monto = Math.round(monto * 100) / 100;
  
    // Reset proyecci√≥n
    multiFacturas.forEach(f => { f.proyectado = f.saldo; f.abono = 0; });
  
    let restante = monto;
    // Regla: pagar primero las m√°s antiguas (ya vienen ordenadas por fecha asc)
    for (const f of multiFacturas) {
      if (restante <= 0) break;
      const aplicar = Math.min(f.saldo, restante);
      f.abono = Math.round(aplicar * 100) / 100;
      f.proyectado = Math.round((f.saldo - f.abono) * 100) / 100;
      restante = Math.round((restante - aplicar) * 100) / 100;
  
      // Actualizar celda "Saldo Proyectado"
      const tr = document.querySelector(`tr[data-factura-id="${f.id}"]`);
      if (tr) {
        tr.querySelector('[data-col="proyectado"]').textContent = cord(f.proyectado);
      }
    }
  
    const distribuido = Math.round((monto - restante) * 100) / 100;
    updateMultiResumen(monto, distribuido);
  
    // Habilitar aplicar si hay algo que aplicar
    document.getElementById('btnAplicarAbonos').disabled = (distribuido <= 0 || multiFacturas.every(f => f.abono <= 0));
  }
  
  function updateMultiResumen(monto, distribuido) {
    const restante = Math.max(0, Math.round((monto - distribuido) * 100) / 100);
    document.getElementById('multiResumen').textContent =
      `Total: ${cord(monto)} ‚Ä¢ Distribuido: ${cord(distribuido)} ‚Ä¢ Restante: ${cord(restante)}`;
  }
  
  /************* Aplicar (transacci√≥n multi-doc) *************/
  /*async function aplicarAbonos() {
    const abonos = multiFacturas.filter(f => f.abono > 0);
    if (abonos.length === 0) {
      alert('No hay abonos propuestos.');
      return;
    }
  
    // Datos comunes
    const currentUser = JSON.parse(sessionStorage.getItem('currentUser') || 'null');
    if (!currentUser) {
      alert('Sesi√≥n expirada. Inici√° de nuevo.');
      return window.location.href = 'index.html';
    }
  
    const clienteId = document.getElementById('clienteSelect').value;
    const ruta = document.getElementById('rutaAbono').value || 'SIN RUTA';
    const metodo = 'Efectivo';           // Dejamos simple para el m√∫ltiple
    const banco = 'N/A';
    const referenciaBancaria = 'N/A';
    const fecha = new Date();            // Misma fecha/hora para todos
    const refBase = generateReference(); // base legible (si quer√©s)
  
    try {
      await db.runTransaction(async (tx) => {
        for (let i = 0; i < abonos.length; i++) {
          const f = abonos[i];
          const facturaRef = db.collection('facturas').doc(f.id);
          const facturaSnap = await tx.get(facturaRef);
          if (!facturaSnap.exists) throw new Error(`La factura ${f.id} no existe`);
  
          const data = facturaSnap.data();
          const saldoActual = Math.round((data.saldo !== undefined ? data.saldo : data.total) * 100) / 100;
          if (saldoActual <= 0) continue; // ya saldada
  
          // Seguridad por si cambi√≥ el saldo desde que se proyect√≥
          const aplicar = Math.min(f.abono, saldoActual);
          if (aplicar <= 0) continue;
  
          const nuevoSaldo = Math.round((saldoActual - aplicar) * 100) / 100;
  
          const abonoRef = facturaRef.collection('abonos').doc();
          const abonoData = {
            clientId: clienteId,
            amount: aplicar,
            pendingBalance: nuevoSaldo,
            dateTime: fecha,
            route: ruta,
            metodoPago: metodo,
            banco,
            referenciaBancaria: (metodo==='Transferencia')? referenciaBancaria : null, // aplica si es transferencia
            notaCreditoId: null,          // no aplica en m√∫ltiple
            reference: `${refBase}-${String(i+1).padStart(2,'0')}`,
            usuario: {
              username: currentUser.username,
              fullName: currentUser.fullName
            }
          };
  
          // Actualizar factura + crear abono
          tx.update(facturaRef, { saldo: nuevoSaldo });
          tx.set(abonoRef, abonoData);
        }
      });
  
      toast(`‚úÖ Abonos aplicados: ${abonos.length}`);
      closeMultiAbonoModal();
  
      // Refrescar UI existente
      cargarFacturasCredito();     // repobla select de facturas (filtra saldadas)
      cargarHistorialAbonos();     // historial infinito actualizado
    } catch (err) {
      console.error(err);
      alert('Error aplicando abonos: ' + err.message);
    }
  }*/

async function aplicarAbonos() {
  // 1) Validaciones y datos comunes
  const montoTotal = parseFloat(document.getElementById('multiMonto').value);
  if (isNaN(montoTotal) || montoTotal <= 0) {
    alert('Ingres√° un monto v√°lido a distribuir.');
    return;
  }

  const currentUser = JSON.parse(sessionStorage.getItem('currentUser') || 'null');
  if (!currentUser) {
    alert('Sesi√≥n expirada. Inici√° de nuevo.');
    return window.location.href = 'index.html';
  }

  const clienteId = document.getElementById('clienteSelect').value;
  const ruta = document.getElementById('rutaAbono').value || 'SIN RUTA';

  // M√©todo de pago para TODO el lote
  const metodo = document.getElementById('multiMetodoPago')?.value || 'Efectivo';
  let banco = 'N/A';
  let referenciaBancaria = null;

  if (metodo === 'Transferencia') {
    banco = document.getElementById('multiBancoSelect')?.value || 'N/A';
    referenciaBancaria = (document.getElementById('multiReferenciaBancaria')?.value || '').trim();
    if (!referenciaBancaria) {
      alert('Ingrese referencia bancaria');
      return;
    }
  }
  const fecha = new Date();
  const refBase = generateReference();

  // Tomamos las facturas en el orden ya mostrado (asc por fecha)
  const targets = multiFacturas.map(f => ({ id: f.id }));

  if (targets.length === 0) {
    alert('Este cliente no tiene facturas con saldo pendiente.');
    return;
  }

  const facturaRefs = targets.map(t => db.collection('facturas').doc(t.id));
  let accionesAplicadas = [];

  try {
    
    const createdAbonoPaths = []; // üëà NUEVO
    
    await db.runTransaction(async (tx) => {
      // 2) LEER TODO PRIMERO (todas las facturas dentro de la transacci√≥n)
      const snaps = await Promise.all(facturaRefs.map(ref => tx.get(ref)));

      // 3) Recalcular distribuci√≥n con saldos actuales (a prueba de concurrencia)
      let restante = Math.round(montoTotal * 100) / 100;
      const acciones = []; // {ref, aplicar, nuevoSaldo}

      for (let i = 0; i < snaps.length && restante > 0; i++) {
        const snap = snaps[i];
        if (!snap.exists) continue;

        const data = snap.data();
        const total = Math.round((data.total || 0) * 100) / 100;
        const saldoActual = Math.round(((data.saldo !== undefined ? data.saldo : total)) * 100) / 100;
        if (saldoActual <= 0) continue;

        const aplicar = Math.min(restante, saldoActual);
        if (aplicar <= 0) continue;

        const nuevoSaldo = Math.round((saldoActual - aplicar) * 100) / 100;

        acciones.push({ ref: facturaRefs[i], aplicar, nuevoSaldo, saldoAntes: saldoActual, consecutivo: data.consecutivo || 'N/A' });
        restante = Math.round((restante - aplicar) * 100) / 100;
      }

      // Si no hay nada para aplicar, abortamos
      if (acciones.length === 0) return;

      // Snapshot para recibo multi (para imprimir)
      accionesAplicadas = acciones.map(x => ({
        facturaId: x.ref.id,
        consecutivo: x.consecutivo || 'N/A',
        saldoAntes: x.saldoAntes,
        monto: x.aplicar,
        saldoDespues: x.nuevoSaldo
      }));

      // 4) ESCRIBIR TODO DESPU√âS (updates + abonos)
      for (let i = 0; i < acciones.length; i++) {
        const { ref, aplicar, nuevoSaldo } = acciones[i];

        const abonoRef = ref.collection('abonos').doc();
        const abonoData = {
          clientId: clienteId,
          amount: aplicar,
          pendingBalance: nuevoSaldo,
          dateTime: fecha,
          route: ruta,
          metodoPago: metodo,
          banco,
          referenciaBancaria: (metodo==='Transferencia')? referenciaBancaria : null,
          notaCreditoId: null,
          reference: `${refBase}-${String(i + 1).padStart(2, '0')}`,
          usuario: {
            username: currentUser.username,
            fullName: currentUser.fullName
          }
        };
        
        createdAbonoPaths.push(abonoRef.path);  
        
        tx.update(ref, { saldo: nuevoSaldo });
        tx.set(abonoRef, abonoData);
      }
    });

    if (createdAbonoPaths.length === 0) {
      alert('No se aplic√≥ ning√∫n abono (quiz√° las facturas ya estaban saldadas).');
      return;
    }

    // Setear el snapshot total en todos los abonos creados
    const totalCliente = await calcularSaldoPendienteTotalCliente(clienteId);
    const batch = db.batch();
    createdAbonoPaths.forEach(p => batch.update(db.doc(p), { saldoPendienteTotalCliente: totalCliente }));
    await batch.commit();

    // 5) UI final
    toast('‚úÖ Abonos aplicados correctamente.');

    const clienteNombre =
      clientesMap[clienteId] ||
      ($('#clienteSelect option:selected').text() || clienteId);

    const usuarioNombre =
      (currentUser && (currentUser.fullName || currentUser.username)) || 'Administrador';

    const totalAplicado = Math.round(
      accionesAplicadas.reduce((acc, it) => acc + Number(it.monto || 0), 0) * 100
    ) / 100;

    // Guardar snapshot para impresi√≥n
    lastMultiReceiptPayload = {
      fecha,
      clienteNombre,
      usuarioNombre,
      metodo,
      banco,
      referenciaBancaria,
      refBase,
      totalAplicado,
      saldoPendienteTotalCliente: totalCliente,
      items: accionesAplicadas
    };

    const st = document.getElementById('multiReciboStatus');
    if (st) st.textContent = `Listo ‚úÖ Pod√©s imprimir el recibo del lote ${refBase}.`;

    const btnPW = document.getElementById('btnImprimirMultiWeb');
    const btnPM = document.getElementById('btnImprimirMultiMovil');
    if (btnPW) btnPW.disabled = false;
    if (btnPM) btnPM.disabled = false;

    mostrarReciboMultiPreview(lastMultiReceiptPayload);

    // Evitar doble aplicaci√≥n del lote
    const btnAp = document.getElementById('btnAplicarAbonos');
    if (btnAp) btnAp.disabled = true;
    const btnDist = document.getElementById('btnDistribuir');
    if (btnDist) btnDist.disabled = true;

    // Refrescar UI existente
    cargarFacturasCredito();
    cargarHistorialAbonos();
} catch (err) {
    console.error(err);
    alert('Error aplicando abonos: ' + err.message);
  }
}

async function recalcularSaldosFactura(facturaId) {
  const facturaRef = db.collection('facturas').doc(facturaId);

  // 1) Leemos total de la factura
  const facturaSnap = await facturaRef.get();
  if (!facturaSnap.exists) return;
  const totalFactura = Math.round((facturaSnap.data().total || 0) * 100) / 100;

  // 2) Leemos todos los abonos en orden cronol√≥gico
  const abonosSnap = await facturaRef
    .collection('abonos')
    .orderBy('dateTime', 'asc')
    .get();

  // 3) Reencadenamos saldos
  let saldo = totalFactura;
  const batch = db.batch();

  abonosSnap.forEach(doc => {
    const a = doc.data();
    const monto = Math.round((a.amount || 0) * 100) / 100;

    saldo = Math.round((saldo - monto) * 100) / 100;     // saldo despu√©s de aplicar este abono
    batch.update(doc.ref, { pendingBalance: saldo });     // actualizamos el snapshot
  });

  // 4) Dejamos el saldo real de la factura coherente con el √∫ltimo saldo
  batch.update(facturaRef, { saldo });

  await batch.commit();
}  

  /*function round2(n){ return Math.round((Number(n)||0)*100)/100; }
  async function calcularSaldoPendienteTotalCliente(clienteId) {
    const qs = await db.collection('facturas')
      .where('clientId','==',clienteId)
      .get();
    
    let total = 0;
    qs.forEach(d => {
      const data = d.data();
      const saldo = Number(data.saldo != null ? data.saldo : data.total);
      // si quer√©s excluir anuladas: if (data.anulada) return;
      if (saldo > 0) total += saldo;
    });
    return round2(total);
  }*/
  
function round2(n){ return Math.round((Number(n)||0)*100)/100; }

/**
 * Calcula la deuda total pendiente del cliente
 * Opciones por defecto alineadas con el reporte.
 */
async function calcularSaldoPendienteTotalCliente(clienteId, {
  soloCredito = true,
  excluirAnuladas = true,
  usarSaldoPrimero = true
} = {}) {
  let q = db.collection('facturas').where('clientId','==',clienteId);
  if (soloCredito)     q = q.where('paymentType','==','Credito');
  if (excluirAnuladas) q = q.where('anulada','==',false);

  const qs = await q.get();
  let total = 0;

  for (const doc of qs.docs) {
    const f = doc.data();
    let saldo;

    if (usarSaldoPrimero && f.saldo != null) {
      saldo = Number(f.saldo);
    } else {
      // Fallback: recomputar por abonos
      const abonosSnap = await doc.ref.collection('abonos').get();
      const abonado = abonosSnap.docs.reduce((s,a)=> s + Number(a.data().amount||0), 0);
      saldo = Number(f.total||0) - abonado;
    }

    saldo = Math.max(0, round2(saldo));  // sin negativos por redondeo
    if (saldo > 0) total += saldo;
  }

  return round2(total);
}


  
</script>

<script type="module">
  import {requireAccess} from './auth.js';
  requireAccess('abonar');  
</script>  
  
</body>
</html>
