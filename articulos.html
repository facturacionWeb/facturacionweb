<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Gesti√≥n de Art√≠culos y Existencias (IMEI) üòé</title>

  <!-- Para exportar a excel -->
  <script src="https://cdn.sheetjs.com/xlsx-0.19.3/package/dist/xlsx.full.min.js"></script>

  <!-- Import Firebase SDK (v8 with namespaced API) -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
  <!-- Firebase Config -->
  <script src="https://facturacionweb.github.io/facturacionweb/firebase-config.js"></script>
  
  <style>
    html { scroll-behavior: smooth; }

    body {
      font-family: Arial, sans-serif;
      padding: 20px;
    }
    .container {
      max-width: 1000px;
      margin: 0 auto;
      margin-bottom: 40px;
    }
    input[type="text"],
    input[type="number"],
    button,
    select {
      margin: 10px 0;
      display: block;
      width: 100%;
      padding: 10px;
      box-sizing: border-box;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }
    table, th, td {
      border: 1px solid #ccc;
    }
    th, td {
      padding: 8px;
      text-align: left;
    }
    h1, h2, h3 {
      text-align: center;
    }

    /* Modal proveedor encima del dropdown */
    #modalProveedor {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      z-index: 9999; /* suficiente para estar encima del dropdown */
    }

    /* Panel colapsable + scroll para el listado grande */
    details#listadoArticulos {
      margin-top: 16px;
    }
    details#listadoArticulos > summary {
      cursor: pointer;
      font-weight: bold;
      padding: 8px 0;
    }
    .table-scroll {
      max-height: 420px;   /* üëà ajustable */
      overflow-y: auto;
      border: 1px solid #ddd;
      border-radius: 6px;
    }
    .table-scroll table {
      margin: 0; /* quitar margen extra dentro del contenedor scroll */
    }
    .table-scroll thead th {
      position: sticky;
      top: 0;
      background: #fff;
      z-index: 1;
    }

    /* Bloque de acciones r√°pidas arriba */
    .quick-actions {
      display: grid;
      grid-template-columns: 1fr;
      gap: 8px;
      margin: 10px 0 4px 0;
    }
    .muted {
      color: #666; font-size: 0.9rem;
    }
  </style>

  <script>
    // Script para cargar versi√≥n (opcional)
    (function loadVersionScript() {
      const versionScript = document.createElement('script');
      versionScript.src = 'https://facturacionweb.github.io/facturacionweb/version.js?v=' + new Date().getTime();
      document.head.appendChild(versionScript);
    })();
  </script>
  <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
</head>
<body>
  <h1>üíæ Gesti√≥n de Art√≠culos y Existencias (IMEI) üíæüì±üíæ</h1>

  <!-- Secci√≥n de Art√≠culos -->
  <div class="container" id="articlesSection">
    <h2>Gesti√≥n de Art√≠culos</h2>

    <!-- üîé Nuevo: Buscador r√°pido para editar -->
    <label for="articleQuickEdit" class="muted">Buscar y cargar art√≠culo para editar</label>
    <select id="articleQuickEdit" style="width: 100%;" placeholder="Buscar art√≠culo...">
      <option value="">Escribe ID, marca o modelo‚Ä¶</option>
    </select>

    <!-- Formulario para Art√≠culos -->
    <input type="text" id="articleId" placeholder="ID del Art√≠culo" />
    <input type="text" id="marca" placeholder="Marca" />
    <input type="text" id="modelo" placeholder="Modelo" />
    <input type="number" id="precioCompra" placeholder="Precio de Compra" step="0.01" />
    <input type="number" id="precioVenta" placeholder="Precio de Venta" step="0.01" />
    <select id="proveedorSelect" style="width: 100%;" placeholder="Seleccione un Proveedor">
      <option value="">Seleccione un proveedor</option>
    </select>

    <div class="quick-actions">
      <button onclick="addOrUpdateArticle()">Agregar/Actualizar Art√≠culo</button>
      <button onclick="clearArticleFields()">Limpiar Campos</button>
      <button onclick="document.getElementById('imeiSection').scrollIntoView({behavior:'smooth'});">Ir a Gesti√≥n de Existencias (IMEI) ‚§µÔ∏è</button>
    </div>

    <!-- Listado grande de art√≠culos: colapsable + scroll -->
    <details id="listadoArticulos" open>
      <summary>Listado de art√≠culos (click para contraer/expandir) üìã</summary>
      <div class="table-scroll">
        <table>
          <thead>
            <tr>
              <th>ID</th>
              <th>Marca</th>
              <th>Modelo</th>
              <th>Precio Compra</th>
              <th>Precio Venta</th>
              <th>Proveedor</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody id="articleTable">
            <!-- Las filas se cargar√°n din√°micamente -->
          </tbody>
        </table>
      </div>
    </details>
  </div>

  <!-- Secci√≥n de IMEI -->
  <div class="container" id="imeiSection">
    <h2>Gesti√≥n de Existencias (IMEI)</h2>
    <!-- Selector para elegir un Art√≠culo -->
    <select id="articleSelector">
      <option value="">Seleccione un Art√≠culo</option>
      <!-- Opciones cargadas din√°micamente -->
    </select>
    <!-- Formulario para agregar IMEI -->
    <input type="text" id="imei" placeholder="IMEI" />
    <button onclick="addIMEI()">Agregar IMEI</button>

    <!-- Previsualizaci√≥n de IMEIs pendientes -->
    <h3>Previsualizaci√≥n de IMEIs pendientes üìã</h3>
    <table id="previewTable">
      <thead>
        <tr>
          <th>IMEI</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody>
        <!-- Se llenar√° din√°micamente -->
      </tbody>
    </table>
    <button onclick="savePendingIMEIs()">Guardar todos los IMEIs</button>

    <!-- Tabla de IMEIs guardados -->
    <h3>IMEIs Guardados en Firestore üíæ</h3>
    <table>
      <thead>
        <tr>
          <th>ID (Registro)</th>
          <th>IMEI</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody id="imeiTable">
        <!-- Las filas se cargar√°n din√°micamente -->
      </tbody>
    </table>

    <button id="btnExportarInventario" onclick="exportarInventarioExcel()">Exportar Inventario a Excel üì§</button>
    <div id="estadoExportacionInventario" style="margin-top:10px;font-weight:bold;color:#444;"></div>

    <div class="quick-actions" style="margin-top:12px;">
      <button onclick="document.getElementById('articlesSection').scrollIntoView({behavior:'smooth'});">Volver a Gesti√≥n de Art√≠culos ‚§¥Ô∏è</button>
    </div>
  </div>

  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
  <script>
    // Inicializar Firestore
    const db = firebase.firestore();

    // Arreglo para acumular los IMEIs pendientes
    let pendingIMEIs = [];

    /* =============================
       Funciones para Art√≠culos
       ============================= */
    function clearArticleFields() {
      document.getElementById('articleId').value = '';
      document.getElementById('marca').value = '';
      document.getElementById('modelo').value = '';
      document.getElementById('precioCompra').value = '';
      document.getElementById('precioVenta').value = '';

      // ‚ú® Limpiar proveedor
      document.getElementById('proveedorSelect').value = '';
      $('#proveedorSelect').val(null).trigger('change'); // para Select2

      // ‚ú® Limpiar selecci√≥n r√°pida tambi√©n
      $('#articleQuickEdit').val(null).trigger('change');
    }

    function addOrUpdateArticle() {
      const id = document.getElementById('articleId').value.trim();
      const marca = document.getElementById('marca').value.trim();
      const modelo = document.getElementById('modelo').value.trim();
      const proveedorId = document.getElementById('proveedorSelect').value;
      const precioCompra = parseFloat(document.getElementById('precioCompra').value);
      const precioVenta = parseFloat(document.getElementById('precioVenta').value);

      if (!id) {
        alert("El ID del art√≠culo es requerido üòÖ");
        return;
      }
      if (!marca || !modelo || isNaN(precioCompra) || isNaN(precioVenta)) {
        alert("Por favor, complete todos los campos correctamente üò¨");
        return;
      }

      // Guardar o actualizar el art√≠culo en la colecci√≥n "Articulos"
      db.collection("Articulos").doc(id).set({
        id,
        marca,
        modelo,
        precioCompra,
        precioVenta,
        proveedorId
      })
      .then(() => {
        alert("Art√≠culo guardado con √©xito üòé");
        loadArticles();
        clearArticleFields();
      })
      .catch((error) => {
        console.error("Error al guardar el art√≠culo: ", error);
      });
    }

    async function loadArticles() {
      const articleTable = document.getElementById('articleTable');
      const articleSelector = document.getElementById('articleSelector');
      const quickEdit = document.getElementById('articleQuickEdit');

      articleTable.innerHTML = '';
      articleSelector.innerHTML = '<option value="">Seleccione un Art√≠culo</option>';
      quickEdit.innerHTML = '<option value="">Escribe ID, marca o modelo‚Ä¶</option>';

      const querySnapshot = await db.collection("Articulos").get();

      for (const doc of querySnapshot.docs) {
        const article = doc.data();
        const proveedorId = article.proveedorId || '';
        let proveedorNombre = 'Sin proveedor';

        if (proveedorId) {
          try {
            const provDoc = await db.collection("proveedores").doc(proveedorId).get();
            if (provDoc.exists) {
              proveedorNombre = provDoc.data().nombreProveedor || 'Desconocido';
            }
          } catch (err) {
            console.warn("Error obteniendo proveedor:", err);
          }
        }

        const row = `<tr>
          <td>${article.id}</td>
          <td>${article.marca}</td>
          <td>${article.modelo}</td>
          <td>${article.precioCompra}</td>
          <td>${article.precioVenta}</td>
          <td>${proveedorNombre}</td>
          <td>
            <button onclick="editArticle('${doc.id}')">Editar</button>
            <button onclick="deleteArticle('${doc.id}')">Eliminar</button>
          </td>
        </tr>`;
        articleTable.innerHTML += row;

        // Selector IMEI
        const option = `<option value="${article.id}">${article.id} - ${article.marca} ${article.modelo}</option>`;
        articleSelector.innerHTML += option;

        // üîé Nuevo: opciones para el buscador r√°pido de edici√≥n
        const quickOpt = document.createElement('option');
        quickOpt.value = article.id;
        quickOpt.textContent = `${article.id} - ${article.marca} ${article.modelo}`;
        quickEdit.appendChild(quickOpt);
      }

      // Refrescar Select2 de edici√≥n r√°pida tras recargar datos
      $('#articleQuickEdit').trigger('change.select2');
    }

    function editArticle(id) {
      db.collection("Articulos").doc(id).get().then((doc) => {
        if (doc.exists) {
          const article = doc.data();
          document.getElementById('articleId').value = article.id;
          document.getElementById('marca').value = article.marca;
          document.getElementById('modelo').value = article.modelo;
          document.getElementById('precioCompra').value = article.precioCompra;
          document.getElementById('precioVenta').value = article.precioVenta;
          
          // üÜï Establecer proveedor en Select2
          document.getElementById('proveedorSelect').value = article.proveedorId || '';
          $('#proveedorSelect').trigger('change');

          // UX: subir al formulario y enfocar
          document.getElementById('articlesSection').scrollIntoView({behavior:'smooth', block:'start'});
          document.getElementById('marca').focus();
        }
      }).catch((error) => {
        console.error("Error al obtener el art√≠culo: ", error);
      });
    }

    function deleteArticle(id) {
      // Verificar si hay IMEIs asociados al art√≠culo
      db.collection("Articulos_X_IMEI").where("articleId", "==", id).get()
      .then((querySnapshot) => {
        if (!querySnapshot.empty) {
          if (confirm("Este art√≠culo tiene IMEIs asociados. Si lo borra, se eliminar√°n tambi√©n todos los IMEIs asociados. ¬øEst√° seguro?")) {
            // Eliminar todos los IMEIs asociados
            let deletePromises = [];
            querySnapshot.forEach((doc) => {
              deletePromises.push(db.collection("Articulos_X_IMEI").doc(doc.id).delete());
            });
            // Despu√©s eliminar el art√≠culo
            Promise.all(deletePromises).then(() => {
              db.collection("Articulos").doc(id).delete()
              .then(() => {
                alert("Art√≠culo e IMEIs eliminados correctamente üòä");
                loadArticles();
              })
              .catch((error) => {
                console.error("Error al eliminar el art√≠culo: ", error);
              });
            }).catch((error) => {
              console.error("Error al eliminar los IMEIs: ", error);
            });
          }
        } else {
          // Si no hay IMEIs, confirmar eliminaci√≥n normal
          if (confirm("¬øEst√° seguro de que desea eliminar este art√≠culo?")) {
            db.collection("Articulos").doc(id).delete()
            .then(() => {
              alert("Art√≠culo eliminado üòä");
              loadArticles();
            })
            .catch((error) => {
              console.error("Error al eliminar el art√≠culo: ", error);
            });
          }
        }
      })
      .catch((error) => {
        console.error("Error al verificar IMEIs asociados: ", error);
      });
    }

    /* =============================
       Funciones para IMEI
       ============================= */
    function addIMEI() {
      const articleId = document.getElementById('articleSelector').value;
      const imei = document.getElementById('imei').value.trim();
      if (!articleId) {
        alert("Debes seleccionar un art√≠culo primero üòÖ");
        return;
      }
      if (!imei) {
        alert("Debes ingresar un IMEI v√°lido üò¨");
        return;
      }
      // Verificar si el IMEI ya est√° en la lista pendiente
      if (pendingIMEIs.includes(imei)) {
        alert("Este IMEI ya se encuentra en la lista pendiente üò¨");
        return;
      }
      // Agregar el IMEI al arreglo pendiente
      pendingIMEIs.push(imei);
      updatePreviewTable();
      document.getElementById('imei').value = '';
      document.getElementById('imei').focus();
    }

    function updatePreviewTable() {
      const previewTableBody = document.getElementById('previewTable').getElementsByTagName('tbody')[0];
      previewTableBody.innerHTML = '';
      pendingIMEIs.forEach((imei, index) => {
        const row = `<tr>
                       <td>${imei}</td>
                       <td><button onclick="removePendingIMEI(${index})">Eliminar</button></td>
                     </tr>`;
        previewTableBody.innerHTML += row;
      });
    }

    function removePendingIMEI(index) {
      pendingIMEIs.splice(index, 1);
      updatePreviewTable();
    }

    // Abrir modal de proveedor y confirmar guardado
    function savePendingIMEIs() {
      if (pendingIMEIs.length === 0) {
        alert("No hay IMEIs pendientes para guardar üò¨");
        return;
      }
      cargarProveedoresEnModal();
      document.getElementById("modalProveedor").style.display = "flex";
    }

    function cargarProveedoresEnModal() {
      const select = document.getElementById("modalProveedorSelect");
      select.innerHTML = '<option value="">Seleccione un proveedor</option>';
      db.collection("proveedores").get().then((snapshot) => {
        snapshot.forEach((doc) => {
          const opt = document.createElement("option");
          opt.value = doc.id;
          opt.textContent = doc.data().nombreProveedor;
          select.appendChild(opt);
        });
        // Inicializar Select2 dentro del modal
        $('#modalProveedorSelect').select2({
          dropdownParent: $('#modalProveedor')
        });
      });
    }

    function cerrarModalProveedor() {
      document.getElementById("modalProveedor").style.display = "none";
    }

    function confirmarGuardadoIMEIs() {
      const proveedorId = document.getElementById("modalProveedorSelect").value;
      const articleId = document.getElementById("articleSelector").value;
      
      if (!articleId) {
        alert("Debes seleccionar un art√≠culo primero üòÖ");
        return;
      }
      if (!proveedorId) {
        alert("Selecciona un proveedor v√°lido üò¨");
        return;
      }
      
      let promises = [];
      pendingIMEIs.forEach((imei) => {
        let promise = db.collection("Articulos_X_IMEI").where("imei", "==", imei).get()
          .then((querySnapshot) => {
            if (!querySnapshot.empty) {
              console.log("El IMEI ya existe:", imei);
              return Promise.resolve(null);
            } else {
              return db.collection("Articulos_X_IMEI").add({
                articleId,
                imei,
                proveedorId
              });
            }
          });
        promises.push(promise);
      });
      
      Promise.all(promises)
      .then(() => {
        alert("Todos los IMEIs se guardaron exitosamente üéâ");
        pendingIMEIs = [];
        updatePreviewTable();
        cerrarModalProveedor();
        loadIMEIs(articleId);
      })
      .catch((err) => {
        console.error("Error al guardar IMEIs:", err);
      });
    }

    function loadIMEIs(articleId) {
      db.collection("Articulos_X_IMEI").where("articleId", "==", articleId).get()
      .then((querySnapshot) => {
        const imeiTable = document.getElementById('imeiTable');
        imeiTable.innerHTML = '';
        querySnapshot.forEach((doc) => {
          const imeiData = doc.data();
          const row = `<tr>
                        <td>${doc.id}</td>
                        <td>${imeiData.imei}</td>
                        <td><button onclick="deleteIMEI('${doc.id}', '${articleId}')">Eliminar</button></td>
                      </tr>`;
          imeiTable.innerHTML += row;
        });
      })
      .catch((error) => {
        console.error("Error al cargar los IMEIs: ", error);
      });
    }

    function deleteIMEI(docId, articleId) {
      if (confirm("¬øEst√° seguro de que desea eliminar este IMEI?")) {
        db.collection("Articulos_X_IMEI").doc(docId).delete().then(() => {
          alert("IMEI eliminado üòä");
          loadIMEIs(articleId);
        }).catch((error) => {
          console.error("Error al eliminar el IMEI: ", error);
        });
      }
    }

    // Evento para cargar los IMEIs guardados al seleccionar un art√≠culo
    document.getElementById('articleSelector').addEventListener('change', function() {
      const articleId = this.value;
      // Limpiar la previsualizaci√≥n cuando se cambia de art√≠culo
      pendingIMEIs = [];
      updatePreviewTable();
      if (articleId) {
        loadIMEIs(articleId);
      } else {
        document.getElementById('imeiTable').innerHTML = '';
      }
    });

    // Evento para permitir agregar IMEI con la tecla Enter
    document.getElementById('imei').addEventListener('keyup', function(event) {
      if (event.key === 'Enter') {
        addIMEI();
      }
    });

    // üîé Nuevo: evento de edici√≥n r√°pida por Select2
    function wireQuickEdit() {
      $('#articleQuickEdit').on('change', function() {
        const id = $(this).val();
        if (id) {
          editArticle(id);
        }
      });
    }

    // Cargar los art√≠culos al iniciar la p√°gina
    window.onload = function() {
      // Inicializar select2
      $('#proveedorSelect').select2({ placeholder: 'Seleccione un proveedor', allowClear: true, width: '100%' });
      $('#articleQuickEdit').select2({ placeholder: 'Buscar art√≠culo‚Ä¶', allowClear: true, width: '100%' });

      wireQuickEdit();
      cargarProveedores(); // cargar proveedores para el select de art√≠culos
      loadArticles();
    };

    function cargarProveedores() {
      db.collection("proveedores").get().then((querySnapshot) => {
        const proveedorSelect = document.getElementById("proveedorSelect");
        querySnapshot.forEach((doc) => {
          const data = doc.data();
          const option = document.createElement("option");
          option.value = doc.id;
          option.text = data.nombreProveedor;
          proveedorSelect.appendChild(option);
        });
      }).catch((error) => {
        console.error("Error cargando proveedores: ", error);
      });
    }

    async function exportarInventarioExcel() {
      const btn = document.getElementById("btnExportarInventario");
      const estado = document.getElementById("estadoExportacionInventario");
    
      btn.disabled = true;
      btn.textContent = "Exportando... ‚è≥";
      estado.textContent = "Generando archivo Excel de inventario...";
      estado.style.color = "#444";
    
      try {
        const articulosSnapshot = await db.collection("Articulos").get();
        const imeisSnapshot = await db.collection("Articulos_X_IMEI").get();
    
        let inventario = {};
    
        articulosSnapshot.forEach((doc) => {
          const art = doc.data();
          const clave = `${art.marca} ${art.modelo}`;
          inventario[clave] = {
            cantidad: 0,
            imeis: []
          };
        });
    
        imeisSnapshot.forEach((doc) => {
          const i = doc.data();
          const articulo = articulosSnapshot.docs.find(a => a.id === i.articleId);
          if (articulo) {
            const art = articulo.data();
            const clave = `${art.marca} ${art.modelo}`;
            if (!inventario[clave]) {
              inventario[clave] = { cantidad: 0, imeis: [] };
            }
            inventario[clave].cantidad++;
            inventario[clave].imeis.push(i.imei);
          }
        });
    
        let hoja = [["Marca Modelo", "Cantidad"]];
        for (const key in inventario) {
          hoja.push([key, inventario[key].cantidad]);
          hoja.push(["IMEIS", ""]);
          for (const imei of inventario[key].imeis) {
            hoja.push([imei, ""]);
          }
          hoja.push([]); // l√≠nea en blanco entre grupos
        }
    
        const ws = XLSX.utils.aoa_to_sheet(hoja);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "InventarioIMEI");
    
        XLSX.writeFile(wb, `Inventario_IMEI_${new Date().toISOString().slice(0,10)}.xlsx`);
    
        estado.textContent = "‚úîÔ∏è Inventario exportado con √©xito.";
        estado.style.color = "green";
      } catch (err) {
        console.error("Error al exportar inventario:", err);
        estado.textContent = "‚ùå Error al generar el archivo Excel.";
        estado.style.color = "red";
      }
    
      btn.disabled = false;
      btn.textContent = "Exportar Inventario a Excel üì§";
    }
  </script>

  <script type="module">
    import {requireAccess} from './auth.js';
    requireAccess('articulos');  
  </script>

  <!-- Modal de selecci√≥n de proveedor -->
  <div id="modalProveedor" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%;
    background-color:rgba(0,0,0,0.5); z-index:999; justify-content:center; align-items:center;">
    <div style="background:white; padding:20px; border-radius:8px; max-width:400px; width:100%;">
      <h3>Selecciona un proveedor</h3>
      <select id="modalProveedorSelect" style="width:100%; padding:10px; margin-top:10px;"></select>
      <button onclick="confirmarGuardadoIMEIs()" style="margin-top:15px;">Confirmar y Guardar</button>
      <button onclick="cerrarModalProveedor()" style="margin-top:10px;">Cancelar</button>
    </div>
  </div>

</body>
</html>
