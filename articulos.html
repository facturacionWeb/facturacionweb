<!DOCTYPE html> 
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestión de Artículos</title>

    <!-- Import Firebase SDK (v8 with namespaced API) -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    
    <!-- Import Firebase configuration -->
    <script src="https://facturacionweb.github.io/facturacionweb/firebase-config.js"></script>
    
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
        }
        input[type="text"],
        input[type="number"],
        input[type="datetime-local"],
        select,
        textarea,
        button {
            margin: 10px 0;
            display: block;
            width: 100%;
            padding: 10px;
            box-sizing: border-box;
        }
        textarea {
            height: 100px;
            resize: vertical;
        }
        label {
            margin: 10px 0;
        }
        .form-group {
            margin-bottom: 15px;
        }
        .checkbox-group {
            display: flex;
            align-items: center;
        }
        .checkbox-group label {
            margin-left: 5px;
            margin-bottom: 0;
        }
        .table-container {
            overflow-x: auto;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            table-layout: fixed;
        }
        table, th, td {
            border: 1px solid black;
        }
        th, td {
            padding: 5px;
            text-align: center;
            font-size: 12px;
            word-wrap: break-word;
        }
        th {
            background-color: #f2f2f2;
        }
    </style>
    <script>
        (function loadVersionScript() {
            const versionScript = document.createElement('script');
            versionScript.src = 'https://facturacionweb.github.io/facturacionweb/version.js?v=' + new Date().getTime();
            document.head.appendChild(versionScript);
        })();
    </script>
</head>
<body>
    <script>
        window.onload = function() {
            const isAuthenticated = sessionStorage.getItem('isAuthenticated');
            if (!isAuthenticated) {
                alert("Debe autenticarse primero");
                window.location.href = "index.html";
            } else {
                loadArticulos();
                loadProveedoresToDropdown();
            }
        };
    </script>

    <a href="index.html">Volver a la Página Principal</a>
    
    <div class="container">
        <h1>Gestión de Artículos</h1>

        <!-- Formulario para agregar o editar un artículo -->
        <div class="form-group">
            <input type="text" id="codigoArticulo" placeholder="Código del Artículo" />
        </div>
        <div class="form-group">
            <select id="rubro">
                <option value="">Seleccione un Rubro</option>
                <option value="teléfonos">Teléfonos</option>
                <option value="tablet">Tablet</option>
                <option value="otros">Otros</option>
            </select>
        </div>
        <div class="form-group">
            <input type="text" id="marca" placeholder="Marca" />
        </div>
        <div class="form-group">
            <input type="text" id="modelo" placeholder="Modelo" />
        </div>
        <div class="form-group">
            <textarea id="descripcion" placeholder="Descripción"></textarea>
        </div>
        <div class="form-group">
            <input type="text" id="imei1" placeholder="IMEI 1" />
        </div>
        <div class="form-group">
            <input type="text" id="imei2" placeholder="IMEI 2" />
        </div>
        <div class="form-group">
            <select id="proveedor">
                <option value="">Seleccione un Proveedor</option>
                <!-- Opciones cargadas dinámicamente -->
            </select>
        </div>
        <div class="form-group">
            <input type="text" id="facturaProveedor" placeholder="Factura del Proveedor" />
        </div>
        <div class="form-group">
            <input type="datetime-local" id="fechaEntrada" />
        </div>
        <div class="form-group">
            <input type="text" id="semana" placeholder="Semana" />
        </div>
        <div class="form-group">
            <select id="ubicacion">
                <option value="">Seleccione Ubicación</option>
                <option value="Ruta 1">Ruta 1</option>
                <option value="Ruta 2">Ruta 2</option>
                <option value="Bodega General">Bodega General</option>
                <option value="En Taller">En Taller</option>
            </select>
        </div>
        <div class="form-group">
            <input type="number" id="precioCompra" placeholder="Precio de Compra" />
        </div>
        <div class="form-group">
            <input type="number" id="precioVenta" placeholder="Precio de Venta" />
        </div>
        <div class="form-group checkbox-group">
            <input type="checkbox" id="activo" />
            <label for="activo">Activo</label>
        </div>
        <div class="form-group">
            <input type="number" id="existencias" placeholder="Existencias" />
        </div>

        <button onclick="addOrUpdateArticulo()">Agregar/Actualizar Artículo</button>
        <button onclick="clearFields()">Limpiar Campos</button>

        <!-- Tabla para mostrar los artículos existentes -->
        <h2>Artículos Existentes</h2>
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>Código</th>
                        <th>Descripción</th>
                        <th>Marca</th>
                        <th>Modelo</th>
                        <th>Rubro</th>
                        <th>IMEI 1</th>
                        <th>IMEI 2</th>
                        <th>Proveedor</th>
                        <th>Factura Proveedor</th>
                        <th>Fecha Entrada</th>
                        <th>Semana</th>
                        <th>Ubicación</th>
                        <th>Precio Compra</th>
                        <th>Precio Venta</th>
                        <th>Activo</th>
                        <th>Existencias</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody id="articuloTable">
                    <!-- Filas de artículos se cargarán dinámicamente -->
                </tbody>
            </table>
        </div>
    </div>

    <script>
        const db = firebase.firestore();

        function clearFields() {
            document.getElementById('codigoArticulo').value = '';
            document.getElementById('rubro').value = '';
            document.getElementById('marca').value = '';
            document.getElementById('modelo').value = '';
            document.getElementById('descripcion').value = '';
            document.getElementById('imei1').value = '';
            document.getElementById('imei2').value = '';
            document.getElementById('proveedor').value = '';
            document.getElementById('facturaProveedor').value = '';
            document.getElementById('fechaEntrada').value = '';
            document.getElementById('semana').value = '';
            document.getElementById('ubicacion').value = '';
            document.getElementById('precioCompra').value = '';
            document.getElementById('precioVenta').value = '';
            document.getElementById('activo').checked = false;
            document.getElementById('existencias').value = '';
        }

        function addOrUpdateArticulo() {
            const codigoArticulo = document.getElementById('codigoArticulo').value.trim();
            const rubro = document.getElementById('rubro').value;
            const marca = document.getElementById('marca').value.trim();
            const modelo = document.getElementById('modelo').value.trim();
            const descripcion = document.getElementById('descripcion').value.trim();
            const imei1 = document.getElementById('imei1').value.trim();
            const imei2 = document.getElementById('imei2').value.trim();
            const proveedor = document.getElementById('proveedor').value;
            const facturaProveedor = document.getElementById('facturaProveedor').value.trim();
            const fechaEntrada = document.getElementById('fechaEntrada').value;
            const semana = document.getElementById('semana').value.trim();
            const ubicacion = document.getElementById('ubicacion').value;
            const precioCompra = parseFloat(document.getElementById('precioCompra').value);
            const precioVenta = parseFloat(document.getElementById('precioVenta').value);
            const activo = document.getElementById('activo').checked;
            const existencias = parseInt(document.getElementById('existencias').value);

            if (codigoArticulo) {
                db.collection("articulos").doc(codigoArticulo).set({
                    codigoArticulo: codigoArticulo,
                    rubro: rubro,
                    marca: marca,
                    modelo: modelo,
                    descripcion: descripcion,
                    imei1: imei1,
                    imei2: imei2,
                    proveedor: proveedor,
                    facturaProveedor: facturaProveedor,
                    fechaEntrada: fechaEntrada,
                    semana: semana,
                    ubicacion: ubicacion,
                    precioCompra: precioCompra,
                    precioVenta: precioVenta,
                    activo: activo,
                    existencias: existencias
                }).then(() => {
                    alert("Artículo agregado o actualizado con éxito");
                    loadArticulos();
                    clearFields();
                }).catch((error) => {
                    console.error("Error al agregar o actualizar el artículo: ", error);
                });
            } else {
                alert("El código del artículo es requerido");
            }
        }

        function loadArticulos() {
            db.collection("articulos").get().then((querySnapshot) => {
                const articuloTable = document.getElementById('articuloTable');
                articuloTable.innerHTML = '';
                querySnapshot.forEach((doc) => {
                    const articulo = doc.data();
                    db.collection("proveedores").doc(articulo.proveedor).get().then((proveedorDoc) => {
                        const nombreProveedor = proveedorDoc.exists ? proveedorDoc.data().nombreProveedor : 'No disponible';
                        const row = `<tr>
                                        <td>${articulo.codigoArticulo || ''}</td>
                                        <td>${articulo.descripcion || ''}</td>
                                        <td>${articulo.marca || ''}</td>
                                        <td>${articulo.modelo || ''}</td>
                                        <td>${articulo.rubro || ''}</td>
                                        <td>${articulo.imei1 || ''}</td>
                                        <td>${articulo.imei2 || ''}</td>
                                        <td>${nombreProveedor}</td>
                                        <td>${articulo.facturaProveedor || ''}</td>
                                        <td>${articulo.fechaEntrada || ''}</td>
                                        <td>${articulo.semana || ''}</td>
                                        <td>${articulo.ubicacion || ''}</td>
                                        <td>${articulo.precioCompra || ''}</td>
                                        <td>${articulo.precioVenta || ''}</td>
                                        <td>${articulo.activo ? 'Sí' : 'No'}</td>
                                        <td>${articulo.existencias || ''}</td>
                                        <td>
                                            <button onclick="editArticulo('${doc.id}')">Editar</button>
                                            <button onclick="deleteArticulo('${doc.id}')">Eliminar</button>
                                        </td>
                                    </tr>`;
                        articuloTable.innerHTML += row;
                    });
                });
            }).catch((error) => {
                console.error("Error al cargar los artículos: ", error);
            });
        }

        function loadProveedoresToDropdown() {
            const proveedorDropdown = document.getElementById('proveedor');
            db.collection("proveedores").get().then((querySnapshot) => {
                proveedorDropdown.innerHTML = '<option value="">Seleccione un Proveedor</option>';
                querySnapshot.forEach((doc) => {
                    const proveedor = doc.data();
                    const option = `<option value="${doc.id}">${proveedor.nombreProveedor}</option>`;
                    proveedorDropdown.innerHTML += option;
                });
            }).catch((error) => {
                console.error("Error al cargar los proveedores: ", error);
            });
        }

        function editArticulo(id) {
            db.collection("articulos").doc(id).get().then((doc) => {
                if (doc.exists) {
                    const articulo = doc.data();
                    document.getElementById('codigoArticulo').value = articulo.codigoArticulo;
                    document.getElementById('rubro').value = articulo.rubro;
                    document.getElementById('marca').value = articulo.marca;
                    document.getElementById('modelo').value = articulo.modelo;
                    document.getElementById('descripcion').value = articulo.descripcion;
                    document.getElementById('imei1').value = articulo.imei1;
                    document.getElementById('imei2').value = articulo.imei2;
                    document.getElementById('proveedor').value = articulo.proveedor;
                    document.getElementById('facturaProveedor').value = articulo.facturaProveedor;
                    document.getElementById('fechaEntrada').value = articulo.fechaEntrada;
                    document.getElementById('semana').value = articulo.semana;
                    document.getElementById('ubicacion').value = articulo.ubicacion;
                    document.getElementById('precioCompra').value = articulo.precioCompra;
                    document.getElementById('precioVenta').value = articulo.precioVenta;
                    document.getElementById('activo').checked = articulo.activo;
                    document.getElementById('existencias').value = articulo.existencias;
                }
            }).catch((error) => {
                console.error("Error al obtener el artículo: ", error);
            });
        }

        function deleteArticulo(id) {
            if (confirm("¿Está seguro de que desea eliminar este artículo?")) {
                db.collection("articulos").doc(id).delete().then(() => {
                    alert("Artículo eliminado con éxito");
                    loadArticulos();
                }).catch((error) => {
                    console.error("Error al eliminar el artículo: ", error);
                });
            }
        }
    </script>
</body>
</html>





