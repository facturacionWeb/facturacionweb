<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>üöÄ Dashboard de Ventas</title>

  <!-- Firebase Core -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <!-- Config -->
  <script src="https://facturacionweb.github.io/facturacionweb/firebase-config.js"></script>
  <script>
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
  </script>
  <!-- Firestore -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    body { font-family: Arial, sans-serif; background:#f4f4f4; margin:0; padding:20px; }
    h1 { text-align:center; margin-bottom:20px; }
    .flex { display:flex; flex-wrap:wrap; gap:10px; }
    .card {
      background:#fff; padding:15px; border-radius:8px;
      box-shadow:0 2px 5px rgba(0,0,0,0.1); text-align:center; flex:1; min-width:180px;
    }
    button {
      background:#4CAF50; color:#fff; border:none; padding:10px 15px;
      border-radius:5px; cursor:pointer;
    }
    button:hover { background:#45a049; }
    .chart-container { position:relative; max-width:600px; height:300px; margin:0 auto; }

    .card p {
      font-size: 1.8em;
      font-weight: bold;
      color: #333;
    }

    .hint {
      margin: 6px 0 0;
      font-size: 0.9em;
      color: #666;
    }

    /* Tiny toolbar inside cards */
    .card-toolbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
      margin-bottom:10px;
    }
    .card-toolbar .left{
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
    }
    .select{
      padding:8px 10px;
      border:1px solid #ddd;
      border-radius:8px;
      background:#fff;
    }
    .select:focus{ outline: none; border-color:#4CAF50; box-shadow:0 0 0 3px rgba(76,175,80,.15); }

    /* Modal */
    .modal-overlay{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,.55);
      display:none;
      align-items:center;
      justify-content:center;
      padding:16px;
      z-index:9999;
    }
    .modal-overlay.show{ display:flex; }
    .modal{
      background:#fff;
      width:min(980px, 96vw);
      border-radius:12px;
      box-shadow:0 15px 45px rgba(0,0,0,.25);
      padding:14px;
    }
    .modal-header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      margin-bottom:10px;
      padding-bottom:8px;
      border-bottom:1px solid #eee;
    }
    .modal-header h2{
      margin:0;
      font-size:1.1rem;
      text-align:left;
    }
    .btn-close{
      background:#e74c3c;
      padding:8px 12px;
      border-radius:8px;
    }
    .btn-close:hover{ background:#cf3e30; }

    .modal-note{
      text-align:left;
      margin: 6px 0 0;
      font-size: 0.9em;
      color: #666;
    }

    .chart-container.modal-chart{
      max-width: 920px;
      height: 420px;
    }
  </style>
</head>
<body>
  <h1>üöÄ Dashboard de VentasüöÄüöÄüöÄ</h1>

  <!-- Filtros -->
  <div class="flex">
    <div class="card" style="flex:0 0 200px;">
      <label><strong>Desde:</strong></label><br>
      <input type="date" id="startDate">
    </div>
    <div class="card" style="flex:0 0 200px;">
      <label><strong>Hasta:</strong></label><br>
      <input type="date" id="endDate">
    </div>
    <div class="card" style="flex:0 0 150px; align-self:flex-end;">
      <button onclick="generarDashboard()">Generar üìä</button>
    </div>
  </div>

  <!-- M√©tricas -->
  <div class="flex" style="margin-top:20px;">
    <div class="card">
      <h2>Total Ventas ($)</h2>
      <p id="totalSales">$0.00</p>
    </div>
    <div class="card">
      <h2># Ventas</h2>
      <p id="countSales">0</p>
    </div>
    <div class="card">
      <h2>Ganancia ($)</h2>
      <p id="totalProfit">$0.00</p>
    </div>
  </div>

  <!-- Top 5 -->
  <div class="card" style="margin-top:20px;">
    <h2>üèÜ Top 5 Productos</h2>
    <div class="chart-container">
      <canvas id="topProductsChart"></canvas>
    </div>
  </div>

  <!-- Ventas Diarias -->
  <div class="card" style="margin-top:20px;">
    <h2>üìÖ Ventas Diarias</h2>
    <div class="chart-container">
      <canvas id="dailyChart"></canvas>
    </div>
  </div>

  <!-- Art√≠culos vendidos por mes -->
  <div class="card" style="margin-top:20px;">
    <div class="card-toolbar">
      <div class="left">
        <h2 style="margin:0;">üì¶ Art√≠culos vendidos por mes</h2>
      </div>
      <div class="left">
        <label for="yearSelect"><strong>A√±o:</strong></label>
        <select id="yearSelect" class="select" title="Seleccion√° el a√±o"></select>
      </div>
    </div>

    <p class="hint">Se muestran todos los meses del a√±o seleccionado. Si es el a√±o actual, llega hasta el mes vigente üòâ (click en una barra para ver detalle por modelo)</p>

    <div class="chart-container">
      <canvas id="monthlyItemsChart"></canvas>
    </div>
  </div>

  <!-- Modal: detalle por modelo -->
  <div id="monthModal" class="modal-overlay" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="monthModalTitle">
      <div class="modal-header">
        <h2 id="monthModalTitle">üì¶ Ventas por modelo</h2>
        <button class="btn-close" onclick="closeMonthModal()">Cerrar ‚úñ</button>
      </div>

      <div class="chart-container modal-chart">
        <canvas id="monthModelsChart"></canvas>
      </div>

      <div id="monthModalNote" class="modal-note"></div>
    </div>
  </div>

  <script>
    const db = firebase.firestore();

    const NOW = new Date();
    const CURRENT_YEAR  = NOW.getFullYear();
    const CURRENT_MONTH = NOW.getMonth() + 1; // 1..12

    function obtenerLabelProducto(item) {
      if (item.brand || item.model) return `${item.brand||''} ${item.model||''}`.trim();
      if (item.descripcion) return item.descripcion;
      return item.articleId || 'SIN_ID';
    }

    function capFirst(s){
      if (!s) return s;
      return s.charAt(0).toUpperCase() + s.slice(1);
    }

    function getInvoiceDate(inv){
      // 1) Timestamp de Firestore
      if (inv && inv.fecha && typeof inv.fecha.toDate === 'function') return inv.fecha.toDate();
      // 2) Date nativo
      if (inv && inv.fecha instanceof Date) return inv.fecha;
      // 3) fechaStr tipo 'YYYY-MM-DD'
      if (inv && inv.fechaStr) {
        const dt = new Date(inv.fechaStr + 'T00:00:00');
        if (!isNaN(dt.getTime())) return dt;
      }
      return null;
    }

    function monthKeyFromDate(dt){
      const y = dt.getFullYear();
      const m = String(dt.getMonth() + 1).padStart(2, '0');
      return `${y}-${m}`;
    }

    function monthLabelFromKey(key){
      const [y, m] = key.split('-').map(Number);
      const dt = new Date(y, (m||1) - 1, 1);
      const label = new Intl.DateTimeFormat('es-NI', { month: 'short', year: 'numeric' }).format(dt);
      return capFirst(label.replace('.', ''));
    }

    function buildMonthKeysForYear(year){
      const maxMonth = (year === CURRENT_YEAR) ? CURRENT_MONTH : 12;
      const keys = [];
      for (let m = 1; m <= maxMonth; m++){
        keys.push(`${year}-${String(m).padStart(2,'0')}`);
      }
      return keys;
    }

    async function generarDashboard() {
      const start = document.getElementById('startDate').value;
      const end   = document.getElementById('endDate').value;
      if (!start || !end) return alert('Eleg√≠ ambas fechas üòâ');

      const [y1,m1,d1] = start.split('-').map(Number);
      const [y2,m2,d2] = end.split('-').map(Number);
      const fechaInicio = new Date(y1, m1 - 1, d1, 0,0,0,0);
      const fechaFin    = new Date(y2, m2 - 1, d2, 23,59,59,999);

      const snap = await db.collection("facturas")
        .where("fecha", ">=", fechaInicio)
        .where("fecha", "<=", fechaFin)
        .where("anulada", "==", false)
        .get();

      let totalSales = 0;
      let countSales = 0;
      let totalProfit = 0;

      const productStats = {};
      const daily = {};
      const dailyCount = {};

      snap.docs.forEach(doc => {
        const inv = doc.data();
        totalSales += inv.total || 0;
        countSales++;

        const day = inv.fechaStr || (
          inv.fecha && inv.fecha.toDate
            ? inv.fecha.toDate().toISOString().slice(0,10)
            : 'SIN_FECHA'
        );

        if (!daily[day])      daily[day]      = { ventas:0, profit:0 };
        if (!dailyCount[day]) dailyCount[day] = 0;
        daily[day].ventas += inv.total || 0;
        dailyCount[day]++;

        if (!Array.isArray(inv.items)) {
          console.warn("‚ö† Factura sin items o items no array:", doc.id);
          return;
        }

        inv.items.forEach(item => {
          const costo = Number(item.costo_compra) || 0;
          const descuento = Number(item.discount || 0);
          const price = Number(item.price || 0);
          const qty = Number(item.quantity || 0);

          const gananciaUnit = (price - costo) * (1 - descuento / 100);
          const gananciaTotal = gananciaUnit * qty;
          totalProfit += gananciaTotal;

          daily[day].profit += gananciaTotal;

          const key = item.articleId || `${item.brand || ''}-${item.model || ''}` || 'SIN_ID';
          if (!productStats[key]) {
            productStats[key] = { qty: 0, label: obtenerLabelProducto(item) };
          }
          productStats[key].qty += qty;
        });

      });

      const formatter = new Intl.NumberFormat('es-NI', { style: 'currency', currency: 'USD' });
      const numberFormatter = new Intl.NumberFormat('es-NI');

      document.getElementById('totalSales').innerText  = formatter.format(totalSales);
      document.getElementById('countSales').innerText  = numberFormatter.format(countSales);
      document.getElementById('totalProfit').innerText = formatter.format(totalProfit);

      const top5 = Object.entries(productStats)
        .sort((a,b)=> b[1].qty - a[1].qty)
        .slice(0,5);

      renderChart('topProductsChart', {
        type:'bar',
        data:{
          labels: top5.map(([,v]) => v.label),
          datasets:[{ label:'Unidades', data: top5.map(([,v]) => v.qty) }]
        },
        options:{ responsive:true, maintainAspectRatio:false, scales:{ y:{ beginAtZero:true } } }
      });

      const days = Object.keys(daily).sort();
      renderChart('dailyChart', {
        type:'bar',
        data:{
          labels: days,
          datasets:[
            { label:'# Ventas',     data: days.map(d=>dailyCount[d] || 0) },
            { label:'Ventas ($)',   data: days.map(d=>daily[d]?.ventas || 0) },
            { label:'Ganancia ($)', data: days.map(d=>daily[d]?.profit || 0) }
          ]
        },
        options:{ responsive:true, maintainAspectRatio:false, scales:{ y:{ beginAtZero:true } } }
      });
    }

    function renderChart(id, cfg) {
      const ctx = document.getElementById(id).getContext('2d');
      if (window[id + '_chart']) window[id + '_chart'].destroy();
      window[id + '_chart'] = new Chart(ctx, cfg);
    }

    async function loadMonthlyItemsChart(){
      const year = Number(document.getElementById('yearSelect').value);
      const numberFormatter = new Intl.NumberFormat('es-NI');

      const start = new Date(year, 0, 1, 0,0,0,0);
      const end   = new Date(year, 11, 31, 23,59,59,999);

      let snap;
      try{
        snap = await db.collection("facturas")
          .where("fecha", ">=", start)
          .where("fecha", "<=", end)
          .where("anulada", "==", false)
          .get();
      }catch(err){
        console.error("Error cargando mensual por a√±o:", err);
        renderChart('monthlyItemsChart', {
          type:'bar',
          data:{ labels:['Error'], datasets:[{ label:'Unidades vendidas', data:[0] }]},
          options:{ responsive:true, maintainAspectRatio:false, scales:{ y:{ beginAtZero:true } } }
        });
        return;
      }

      const monthlyQty = {};
      const monthlyByModel = {};

      snap.docs.forEach(doc => {
        const inv = doc.data();
        if (!Array.isArray(inv.items)) return;

        const invDate = getInvoiceDate(inv);
        const mk = invDate ? monthKeyFromDate(invDate) : null;
        if (!mk) return;

        inv.items.forEach(item => {
          const qty = Number(item.quantity || 0);
          if (!monthlyQty[mk]) monthlyQty[mk] = 0;
          monthlyQty[mk] += qty;

          const modelLabel = (
            (item.brand || item.model)
              ? `${item.brand || ''} ${item.model || ''}`.trim()
              : (item.model || item.descripcion || item.articleId || 'SIN_MODELO')
          );

          if (!monthlyByModel[mk]) monthlyByModel[mk] = {};
          if (!monthlyByModel[mk][modelLabel]) monthlyByModel[mk][modelLabel] = 0;
          monthlyByModel[mk][modelLabel] += qty;
        });
      });

      const monthKeys = buildMonthKeysForYear(year);
      const monthLabels = monthKeys.map(monthLabelFromKey);
      const monthData   = monthKeys.map(k => monthlyQty[k] || 0);

      window.__monthlyByModel = monthlyByModel;
      window.__monthKeys = monthKeys;

      renderChart('monthlyItemsChart', {
        type:'bar',
        data:{
          labels: monthLabels,
          datasets:[{ label:'Unidades vendidas', data: monthData }]
        },
        options:{
          responsive:true,
          maintainAspectRatio:false,
          scales:{ y:{ beginAtZero:true } },
          plugins:{
            tooltip:{
              callbacks:{
                label: (ctx) => ` ${ctx.dataset.label}: ${numberFormatter.format(ctx.raw)}`
              }
            }
          },
          onHover: (evt, els) => {
            const target = evt?.native?.target;
            if (target) target.style.cursor = els?.length ? 'pointer' : 'default';
          },
          onClick: (evt, els) => {
            if (!els || !els.length) return;
            const idx = els[0].index;
            const key = window.__monthKeys[idx];
            if (!key) return;
            openMonthModal(key);
          }
        }
      });
    }

    function openMonthModal(monthKey){
      const overlay = document.getElementById('monthModal');
      const title = document.getElementById('monthModalTitle');
      const note = document.getElementById('monthModalNote');

      title.innerText = `üì¶ Ventas por modelo ‚Äî ${monthLabelFromKey(monthKey)}`;
      note.innerText = '';

      const modelObj = (window.__monthlyByModel && window.__monthlyByModel[monthKey]) ? window.__monthlyByModel[monthKey] : {};
      const entries = Object.entries(modelObj).sort((a,b) => (b[1]||0) - (a[1]||0));

      if (entries.length === 0) {
        note.innerText = 'Este mes no tiene ventas registradas üòÖ';
        renderChart('monthModelsChart', {
          type:'bar',
          data:{ labels:['Sin datos'], datasets:[{ label:'Unidades', data:[0] }] },
          options:{ responsive:true, maintainAspectRatio:false, scales:{ y:{ beginAtZero:true } } }
        });
      } else {
        const TOP = 60;
        const top = entries.slice(0, TOP);

        if (entries.length > TOP) {
          note.innerText = `Mostrando Top ${TOP} de ${entries.length} modelos (para no saturar la gr√°fica).`;
        } else {
          note.innerText = `Modelos distintos: ${entries.length}`;
        }

        renderChart('monthModelsChart', {
          type:'bar',
          data:{
            labels: top.map(([k]) => k),
            datasets:[{ label:'Unidades', data: top.map(([,v]) => v) }]
          },
          options:{
            responsive:true,
            maintainAspectRatio:false,
            scales:{
              y:{ beginAtZero:true },
              x:{ ticks:{ autoSkip:false, maxRotation:45, minRotation:0 } }
            }
          }
        });
      }

      overlay.classList.add('show');
      overlay.setAttribute('aria-hidden','false');
    }

    function closeMonthModal(){
      const overlay = document.getElementById('monthModal');
      overlay.classList.remove('show');
      overlay.setAttribute('aria-hidden','true');
    }

    document.getElementById('monthModal').addEventListener('click', (e) => {
      if (e.target && e.target.id === 'monthModal') closeMonthModal();
    });

    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') closeMonthModal();
    });

    function initYearSelect(){
      const sel = document.getElementById('yearSelect');
      if (!sel) return;

      const MIN_YEAR = 2018;
      sel.innerHTML = '';

      for (let y = CURRENT_YEAR; y >= MIN_YEAR; y--){
        const opt = document.createElement('option');
        opt.value = String(y);
        opt.textContent = String(y);
        sel.appendChild(opt);
      }
      sel.value = String(CURRENT_YEAR);

      sel.addEventListener('change', () => loadMonthlyItemsChart());

      loadMonthlyItemsChart();
    }

    document.addEventListener('DOMContentLoaded', () => {
      initYearSelect();
    });
  </script>

  <script type="module">
    import {requireAccess} from './auth.js';
    requireAccess('dashboard');
  </script>
</body>
</html>
