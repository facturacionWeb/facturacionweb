<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Facturaci√≥n de Art√≠culos</title>
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
  <!-- Firebase Config -->
  <script src="https://facturacionweb.github.io/facturacionweb/firebase-config.js"></script>
  <!-- jQuery -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <!-- Select2 CSS y JS -->
  <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
  <style>
    /* Estilos b√°sicos */
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      padding: 20px;
      background-color: #f4f4f4;
    }
    .container {
      max-width: 1000px;
      margin: 0 auto;
      background: #fff;
      padding: 20px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    h1, h2, h3 {
      text-align: center;
    }
    label, input, select, button {
      margin: 10px 0;
      padding: 10px;
      width: calc(100% - 20px);
      box-sizing: border-box;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }
    table, th, td {
      border: 1px solid #ccc;
      padding: 10px;
      text-align: center;
    }
    th {
      background-color: #333;
      color: #fff;
    }
    /* Secci√≥n de la factura */
    .invoice-container {
      width: 800px;
      background: #fff;
      padding: 20px;
      margin: 20px auto;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    .invoice-header {
      text-align: center;
      border-bottom: 2px solid #000;
      margin-bottom: 20px;
    }
    .invoice-header h2 {
      margin: 0;
      color: #333;
    }
    .invoice-header .currency, .invoice-header .route {
      font-size: 16px;
      color: #555;
      margin-top: 5px;
    }
    .invoice-body {
      margin-bottom: 20px;
    }
    .details-table, .items-table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 20px;
    }
    .details-table td, .items-table th, .items-table td {
      border: 1px solid #ddd;
      padding: 10px;
      white-space: normal;
      word-wrap: break-word;
    }
    .items-table th {
      background: #333;
      color: #fff;
      text-align: left;
    }
    .signature {
      margin-top: 30px;
      text-align: center;
    }
    /* Estilos para el modal de detalle de factura */
    .modal {
      display: none;
      position: fixed;
      z-index: 100;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgba(0,0,0,0.5);
    }
    .modal-content {
      background-color: #fff;
      margin: 10% auto;
      padding: 20px;
      width: 90%;
      max-width: 800px;
      position: relative;
    }
    .close {
      color: #aaa;
      float: right;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
    }
    /* Oculta todo excepto la factura al imprimir */
    @media print {
      body * {
        visibility: hidden;
      }
      #invoiceContainer, #invoiceContainer * {
        visibility: visible;
      }
      #invoiceContainer {
        position: absolute;
        left: 0;
        top: 0;
        width: 100%;
      }
    }
  </style>
</head>
<body>
  <a href="index.html">Volver a la P√°gina Principal</a>
  <div class="container">
    <h1>Facturaci√≥n de Art√≠culos üìÑüí∞</h1>
    
    <!-- Secci√≥n: Crear Nueva Factura -->
    <h2>Crear Nueva Factura</h2>
    <label for="clientSelect">Selecciona Cliente:</label>
    <select id="clientSelect"></select>

    <label for="invoiceRoute">Ruta de la Factura:</label>
    <select id="invoiceRoute">
      <option value="SIN RUTA">SIN RUTA</option>
      <option value="1">1</option>
      <option value="2">2</option>
      <option value="3">3</option>
      <option value="4">4</option>
      <option value="5">5</option>
    </select>

    <!-- Nuevo selector de Moneda -->
    <label for="currencySelect">Moneda:</label>
    <select id="currencySelect">
      <option value="CORD">C√≥rdobas (C$)</option>
      <option value="USD">D√≥lares ($)</option>
    </select>

    <!-- Nuevo selector de M√©todo de Pago -->
    <label for="paymentType">M√©todo de Pago:</label>
    <select id="paymentType">
      <option value="Efectivo">Efectivo</option>
      <option value="Transferencia">Transferencia</option>
      <option value="Credito">Cr√©dito</option>
    </select>
      
    <!-- Informaci√≥n adicional para Transferencia -->
    <div id="transferInfo" style="display: none;">
      <label for="bankSelect">Selecciona Banco:</label>
      <select id="bankSelect">
        <option value="BAC">BAC</option>
        <option value="LA FISE">LA FISE</option>
        <option value="BANPRO">BANPRO</option>
        <option value="AVANZ">AVANZ</option>
      </select>
      <label for="bankReference">N√∫mero de Referencia Bancaria:</label>
      <input type="text" id="bankReference" placeholder="N√∫mero de Referencia Bancaria">
    </div>

    <!-- Tabla para los items de la factura -->
    <h3>Items de Factura</h3>
    <table id="invoiceItemsTable">
      <thead>
        <tr>
          <th>Art√≠culo</th>
          <th>Cantidad</th>
          <th>Precio Venta</th>
          <th>Descuento (%)</th>
          <th>Total</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody>
        <!-- Aqu√≠ se agregan las filas din√°micamente -->
      </tbody>
    </table>
    <button onclick="addInvoiceItem()">Agregar Item ‚ûï</button>
    <h3>Total a Pagar: <span id="invoiceTotal">0.00</span></h3>
    <button onclick="createInvoice()">Crear Factura üíµ</button>

    <!-- Secci√≥n para mostrar la factura creada -->
    <div id="invoiceDisplay" style="display:none;">
      <h2>Factura Generada</h2>
      <div class="invoice-container" id="invoiceContainer">
        <!-- Aqu√≠ se mostrar√° la factura con el detalle -->
      </div>
      <button onclick="printInvoice()">Imprimir Factura üñ®Ô∏è</button>
    </div>

    <hr>
    <!-- Secci√≥n: Listado de Facturas -->
    <h2>Listado de Facturas</h2>

    <!-- Filtros -->
    <label for="filterDate">Filtrar por Fecha:</label>
    <input type="date" id="filterDate">

    <label for="filterRoute">Filtrar por Ruta:</label>
    <select id="filterRoute">
      <option value="">-- Todas --</option>
      <option value="SIN RUTA">SIN RUTA</option>
      <option value="1">1</option>
      <option value="2">2</option>
      <option value="3">3</option>
      <option value="4">4</option>
      <option value="5">5</option>
    </select>

    <!-- Nuevo filtro: Facturas Anuladas -->
    <label for="filterAnulada">Estado:</label>
    <select id="filterAnulada">
      <option value="">-- Todas --</option>
      <option value="false">No Anuladas</option>
      <option value="true">Anuladas</option>
    </select>

    <!-- Nuevo filtro: M√©todo de Pago -->
    <label for="filterPaymentMethod">M√©todo de Pago:</label>
    <select id="filterPaymentMethod">
      <option value="">-- Todos --</option>
      <option value="Efectivo">Efectivo</option>
      <option value="Transferencia">Transferencia</option>
      <option value="Credito">Cr√©dito</option>
    </select>

    <button onclick="filterInvoices()">Filtrar Facturas üîç</button>

    <table id="invoicesTable">
      <thead>
        <tr>
          <th>ID Factura</th>
          <th>Fecha y Hora</th>
          <th>Cliente</th>
          <th>Ruta</th>
          <th>Total</th>
          <th>Estado</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody>
        <!-- Aqu√≠ se listan las facturas -->
      </tbody>
    </table>
  </div>

  <!-- Modal para ver el detalle de una factura -->
  <div id="invoiceModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeInvoiceModal()">&times;</span>
      <div id="modalInvoiceContent">
        <!-- Detalle de factura -->
      </div>
    </div>
  </div>

  <script>
    // Inicializar Firestore
    const db = firebase.firestore();
    let invoiceTotal = 0;

    // Mostrar u ocultar informaci√≥n adicional para transferencia
    document.getElementById('paymentType').addEventListener('change', function() {
      if (this.value === "Transferencia") {
        document.getElementById('transferInfo').style.display = 'block';
      } else {
        document.getElementById('transferInfo').style.display = 'none';
      }
    });

    // Cargar clientes en el select de facturaci√≥n
    function loadClients() {
      db.collection("clientes").get().then((querySnapshot) => {
        const clientSelect = document.getElementById('clientSelect');
        clientSelect.innerHTML = '';
        querySnapshot.forEach((doc) => {
          const client = doc.data();
          const option = document.createElement('option');
          option.value = doc.id;
          option.textContent = client.nombreCliente + " - " + client.nombreTienda;
          clientSelect.appendChild(option);
        });
      }).catch((error) => {
        console.error("Error al cargar clientes: ", error);
      });
    }

    // Poblar select con art√≠culos (solo IMEIs que existan en Articulos_X_IMEI)
    function populateArticleSelect($select) {
      $select.empty();
      db.collection("Articulos").get().then((articlesSnapshot) => {
        let promises = [];
        articlesSnapshot.forEach((articleDoc) => {
          const articleData = articleDoc.data();
          const p = db.collection("Articulos_X_IMEI")
            .where("articleId", "==", articleDoc.id)
            .get()
            .then((imeiSnapshot) => {
              if (!imeiSnapshot.empty) {
                imeiSnapshot.forEach((imeiDoc) => {
                  const imeiData = imeiDoc.data();
                  // Guardamos tambi√©n el doc ID de 'Articulos_X_IMEI'
                  const payload = {
                    articleId: articleDoc.id,
                    marca: articleData.marca,
                    modelo: articleData.modelo,
                    imei: imeiData.imei,
                    precioVenta: articleData.precioVenta || 0,
                    imeiDocId: imeiDoc.id
                  };
                  const optionText = `${articleData.marca} ${articleData.modelo} - IMEI: ${imeiData.imei}`;
                  const optionValue = JSON.stringify(payload);
                  $select.append(new Option(optionText, optionValue));
                });
              } /*else {
                // Art√≠culo sin IMEI (o ya no hay IMEIs disponibles)
                // Si deseas que no aparezca en absoluto, omite estas l√≠neas.
                const payload = {
                  articleId: articleDoc.id,
                  marca: articleData.marca,
                  modelo: articleData.modelo,
                  imei: "",
                  precioVenta: articleData.precioVenta || 0,
                  imeiDocId: null
                };
                const optionText = `${articleData.marca} ${articleData.modelo}`;
                const optionValue = JSON.stringify(payload);
                $select.append(new Option(optionText, optionValue));
              }*/
            })
            .catch((error) => {
              console.error("Error al cargar IMEI para el art√≠culo: ", error);
            });
          promises.push(p);
        });
        Promise.all(promises).then(() => {
          $select.select2({
            placeholder: "Busca por marca, modelo o IMEI",
            allowClear: true,
            width: '100%'
          });
        });
      })
      .catch((error) => {
        console.error("Error al cargar art√≠culos: ", error);
      });
    }

    // Agregar fila de item en la factura
    function addInvoiceItem() {
      const tbody = document.querySelector('#invoiceItemsTable tbody');
      const row = document.createElement('tr');

      // Columna Art√≠culo
      const articleCell = document.createElement('td');
      const articleSelect = document.createElement('select');
      $(articleSelect).css('width', '100%');
      articleCell.appendChild(articleSelect);
      row.appendChild(articleCell);
      populateArticleSelect($(articleSelect));

      // Columna Cantidad (fija en 1 y no editable)
      const quantityCell = document.createElement('td');
      const quantityInput = document.createElement('input');
      quantityInput.type = 'number';
      quantityInput.value = 1;
      quantityInput.min = 1;
      quantityInput.disabled = true; // Deshabilitado
      quantityCell.appendChild(quantityInput);
      row.appendChild(quantityCell);

      // Columna Precio Venta
      const priceCell = document.createElement('td');
      const priceInput = document.createElement('input');
      priceInput.type = 'number';
      priceInput.placeholder = 'Precio Venta';
      priceCell.appendChild(priceInput);
      row.appendChild(priceCell);

      // Columna Descuento
      const discountCell = document.createElement('td');
      const discountInput = document.createElement('input');
      discountInput.type = 'number';
      discountInput.value = 0;
      discountInput.min = 0;
      discountCell.appendChild(discountInput);
      row.appendChild(discountCell);

      // Columna Total
      const totalCell = document.createElement('td');
      totalCell.textContent = "0.00";
      row.appendChild(totalCell);

      // Columna Acciones
      const actionsCell = document.createElement('td');
      const deleteBtn = document.createElement('button');
      deleteBtn.textContent = "Eliminar";
      deleteBtn.onclick = function() {
        tbody.removeChild(row);
        recalculateInvoice();
      };
      actionsCell.appendChild(deleteBtn);
      row.appendChild(actionsCell);

      // Cuando cambie el art√≠culo, actualizamos precio y total
      $(articleSelect).on('change', function() {
        if ($(this).val()) {
          const parsedValue = JSON.parse($(this).val());
          priceInput.value = parsedValue.precioVenta || 0;
          recalcRow();
        }
      });

      // Funci√≥n para recalcular la fila
      function recalcRow() {
        const qty = parseFloat(quantityInput.value) || 1;
        const price = parseFloat(priceInput.value) || 0;
        const discount = parseFloat(discountInput.value) || 0;
        let total = qty * price;
        if (discount > 0) {
          total -= (total * discount / 100);
        }
        totalCell.textContent = total.toFixed(2);
        recalculateInvoice();
      }

      [priceInput, discountInput].forEach(input => {
        input.addEventListener('input', recalcRow);
      });

      tbody.appendChild(row);
    }

    // Recalcular total de factura
    function recalculateInvoice() {
      const rows = document.querySelectorAll('#invoiceItemsTable tbody tr');
      let total = 0;
      rows.forEach(row => {
        const totalCell = row.children[4];
        total += parseFloat(totalCell.textContent) || 0;
      });
      invoiceTotal = total;
      document.getElementById('invoiceTotal').textContent = invoiceTotal.toFixed(2);
    }

    // Crear factura y guardar en Firestore (eliminando IMEIs)
    function createInvoice() {
      const clientId = document.getElementById('clientSelect').value;
      const route = document.getElementById('invoiceRoute').value;
      const currency = document.getElementById('currencySelect').value;

      let paymentType = document.getElementById('paymentType').value;
      let paymentMethod;
      if (paymentType === "Transferencia") {
        let bank = document.getElementById('bankSelect').value;
        let bankReference = document.getElementById('bankReference').value;
        paymentMethod = `Transferencia - Banco: ${bank} (#Ref: ${bankReference})`;
      } else if (paymentType === "Credito") {
        paymentMethod = "Cr√©dito a 30 d√≠as"; // Ejemplo
      } else {
        paymentMethod = "Efectivo";
      }

      const items = [];
      const rows = document.querySelectorAll('#invoiceItemsTable tbody tr');
      rows.forEach(row => {
        const articleSelectElem = row.children[0].querySelector('select');
        const quantity = parseFloat(row.children[1].querySelector('input').value) || 1;
        const price = parseFloat(row.children[2].querySelector('input').value) || 0;
        const discount = parseFloat(row.children[3].querySelector('input').value) || 0;
        const total = parseFloat(row.children[4].textContent) || 0;

        // Si no hay art√≠culo o total es 0, ignora la fila
        if (!articleSelectElem.value) return;
        if (total <= 0) return;

        const parsedValue = JSON.parse(articleSelectElem.value);
        const brand = parsedValue.marca;
        const model = parsedValue.modelo;
        const imei = parsedValue.imei;
        const articleId = parsedValue.articleId;
        const imeiDocId = parsedValue.imeiDocId;

        // Guardamos imeiDocData para poder reinsertarlo si se anula la factura
        // (agrega m√°s campos si lo necesitas)
        const imeiDocData = {
          articleId: articleId,
          imei: imei
        };

        items.push({
          articleId,
          brand,
          model,
          imei,
          imeiDocId,
          imeiDocData,  // para reinsertar
          quantity,
          price,
          discount,
          total
        });
      });

      // Crear fecha y fechaStr
      const now = new Date();
      const yyyy = now.getFullYear();
      const mm = String(now.getMonth() + 1).padStart(2, '0');
      const dd = String(now.getDate()).padStart(2, '0');
      const fechaStr = `${yyyy}-${mm}-${dd}`;

      const invoice = {
        clientId,
        route,
        currency,
        paymentType,   // Efectivo/Transferencia/Cr√©dito
        paymentMethod, // Detalle
        items,
        total: invoiceTotal,
        fecha: now,    // Timestamp completo
        fechaStr,
        anulada: false // Por defecto, la factura NO est√° anulada
      };

      db.collection("facturas").add(invoice).then((docRef) => {
        alert("¬°Factura creada con √©xito! üéâ");

        // Eliminar los IMEIs seleccionados (si tienen imeiDocId)
        items.forEach(item => {
          if (item.imeiDocId) {
            db.collection("Articulos_X_IMEI").doc(item.imeiDocId).delete()
              .then(() => console.log(`IMEI doc ${item.imeiDocId} eliminado de Articulos_X_IMEI`))
              .catch(err => console.error("Error al eliminar IMEI doc:", err));
          }
        });

        displayInvoice(docRef.id, invoice);
        loadInvoices();
        // Limpieza
        document.querySelector('#invoiceItemsTable tbody').innerHTML = '';
        document.getElementById('invoiceTotal').textContent = "0.00";
      }).catch((error) => {
        console.error("Error al crear factura: ", error);
      });
    }

    // Mostrar factura generada
    function displayInvoice(invoiceId, invoice) {
      db.collection("clientes").doc(invoice.clientId).get().then((doc) => {
        const client = doc.data();
        let currencySymbol = invoice.currency === 'CORD' ? 'C$' : '$';
        let currencyText = invoice.currency === 'CORD' ? 'C√≥rdobas (C$)' : 'D√≥lares ($)';
        const invoiceHTML = `
          <div class="invoice-header">
            <h2>Factura - ${invoiceId}</h2>
            <p class="currency"><strong>Moneda:</strong> ${currencyText}</p>
            <p class="route"><strong>Ruta de la Factura:</strong> ${invoice.route}</p>
          </div>
          <div class="invoice-body">
            <table class="details-table">
              <tr>
                <td><strong>Fecha y Hora:</strong><br>${invoice.fecha ? invoice.fecha.toLocaleString() : ""}</td>
                <td><strong>Cliente:</strong><br>${client ? client.nombreCliente : "N/A"}</td>
              </tr>
              <tr>
                <td><strong>Tienda:</strong><br>${client ? client.nombreTienda : "N/A"}</td>
                <td><strong>Direcci√≥n:</strong><br>${client ? client.direccion : "N/A"}</td>
              </tr>
              <tr>
                <td><strong>Tel√©fono:</strong><br>${client ? client.telefono : "N/A"}</td>
                <td><strong>Pago:</strong><br>${invoice.paymentMethod || 'N/A'}</td>
              </tr>
            </table>
            <table class="items-table">
              <tr>
                <th>Cantidad</th>
                <th>Descripci√≥n</th>
                <th>Precio Venta</th>
                <th>Descuento</th>
                <th>Total</th>
              </tr>
              ${invoice.items.map(item => `
                <tr>
                  <td>${item.quantity}</td>
                  <td>${item.brand} ${item.model} ${item.imei ? '(IMEI: ' + item.imei + ')' : ''}</td>
                  <td>${currencySymbol}${item.price.toFixed(2)}</td>
                  <td>${item.discount}%</td>
                  <td>${currencySymbol}${item.total.toFixed(2)}</td>
                </tr>
              `).join('')}
              <tr>
                <td colspan="4" style="text-align: right;"><strong>Total a Pagar:</strong></td>
                <td><strong>${currencySymbol}${invoice.total.toFixed(2)}</strong></td>
              </tr>
            </table>
            <div class="signature">
              <p>_______________________</p>
              <p>Firma del Cliente</p>
            </div>
          </div>
        `;
        document.getElementById('invoiceContainer').innerHTML = invoiceHTML;
        document.getElementById('invoiceDisplay').style.display = 'block';
      }).catch((error) => {
        console.error("Error al obtener datos del cliente: ", error);
      });
    }

    // Imprimir factura
    function printInvoice() {
      window.print();
    }

    // Listar facturas
    function loadInvoices() {
      db.collection("facturas").orderBy("fecha", "desc").get().then((querySnapshot) => {
        const tbody = document.querySelector('#invoicesTable tbody');
        tbody.innerHTML = '';
        querySnapshot.forEach((doc) => {
          const invoice = doc.data();
          const row = document.createElement('tr');
          row.innerHTML = `
            <td>${doc.id}</td>
            <td>${invoice.fecha ? invoice.fecha.toDate().toLocaleString() : ""}</td>
            <td>${invoice.clientId}</td>
            <td>${invoice.route}</td>
            <td>${invoice.total.toFixed(2)}</td>
            <td>${invoice.anulada ? "ANULADA" : "ACTIVA"}</td>
            <td>
              <button onclick="viewInvoiceDetail('${doc.id}')">Ver</button>
              ${invoice.anulada ? "" : `<button onclick="anularInvoice('${doc.id}')">ANULAR</button>`}
            </td>
          `;
          tbody.appendChild(row);
        });
      }).catch((error) => {
        console.error("Error al cargar facturas: ", error);
      });
    }

    // Anular factura y restaurar IMEIs
    function anularInvoice(invoiceId) {
      if (confirm("¬øEst√° seguro de ANULAR la factura?")) {
        let invoiceData = null;
        // 1) Leer la factura
        db.collection("facturas").doc(invoiceId).get()
          .then(docSnap => {
            if (!docSnap.exists) {
              throw new Error("La factura no existe.");
            }
            invoiceData = docSnap.data();
            // 2) Marcar como anulada
            return db.collection("facturas").doc(invoiceId).update({ anulada: true });
          })
          .then(() => {
            // 3) Restaurar IMEIs
            const items = invoiceData.items || [];
            const promises = [];
            items.forEach(item => {
              // Si el √≠tem ten√≠a un IMEI doc y su "imeiDocData"
              if (item.imeiDocId && item.imeiDocData) {
                // Volvemos a crear el doc en Articulos_X_IMEI con el MISMO docId
                const docRef = db.collection("Articulos_X_IMEI").doc(item.imeiDocId);
                promises.push(docRef.set(item.imeiDocData));
              }
            });
            return Promise.all(promises);
          })
          .then(() => {
            alert("Factura ANULADA con √©xito. IMEIs restaurados.");
            loadInvoices();
          })
          .catch((error) => {
            console.error("Error al anular factura:", error);
          });
      }
    }

    // Filtros de facturas
    function filterInvoices() {
      const filterDate = document.getElementById('filterDate').value;
      const filterRoute = document.getElementById('filterRoute').value;
      const filterAnulada = document.getElementById('filterAnulada').value;
      const filterPaymentMethod = document.getElementById('filterPaymentMethod').value;

      let query = db.collection("facturas");

      // Filtro por fecha
      if (filterDate) {
        query = query.where("fechaStr", "==", filterDate);
      }
      // Filtro por ruta
      if (filterRoute) {
        query = query.where("route", "==", filterRoute);
      }
      // Filtro por anulada
      if (filterAnulada) {
        const boolVal = (filterAnulada === "true");
        query = query.where("anulada", "==", boolVal);
      }
      // Filtro por m√©todo de pago
      if (filterPaymentMethod) {
        query = query.where("paymentType", "==", filterPaymentMethod);
      }

      query = query.orderBy("fecha", "desc");

      query.get()
        .then((querySnapshot) => {
          const tbody = document.querySelector('#invoicesTable tbody');
          tbody.innerHTML = '';
          querySnapshot.forEach((doc) => {
            const invoice = doc.data();
            const row = document.createElement('tr');
            row.innerHTML = `
              <td>${doc.id}</td>
              <td>${invoice.fecha ? invoice.fecha.toDate().toLocaleString() : ""}</td>
              <td>${invoice.clientId}</td>
              <td>${invoice.route}</td>
              <td>${invoice.total.toFixed(2)}</td>
              <td>${invoice.anulada ? "ANULADA" : "ACTIVA"}</td>
              <td>
                <button onclick="viewInvoiceDetail('${doc.id}')">Ver</button>
                ${invoice.anulada ? "" : `<button onclick="anularInvoice('${doc.id}')">ANULAR</button>`}
              </td>
            `;
            tbody.appendChild(row);
          });
        })
        .catch((error) => {
          console.error("Error al filtrar facturas: ", error);
        });
    }

    // Ver detalle de una factura en modal
    function viewInvoiceDetail(invoiceId) {
      db.collection("facturas").doc(invoiceId).get().then((doc) => {
        if(doc.exists) {
          const invoice = doc.data();
          db.collection("clientes").doc(invoice.clientId).get().then((clientDoc) => {
            const client = clientDoc.data();
            let currencySymbol = invoice.currency === 'CORD' ? 'C$' : '$';
            let currencyText = invoice.currency === 'CORD' ? 'C√≥rdobas (C$)' : 'D√≥lares ($)';
            const invoiceHTML = `
              <div class="invoice-header">
                <h2>Factura - ${invoiceId}</h2>
                <p class="currency"><strong>Moneda:</strong> ${currencyText}</p>
                <p class="route"><strong>Ruta de la Factura:</strong> ${invoice.route}</p>
              </div>
              <div class="invoice-body">
                <table class="details-table">
                  <tr>
                    <td><strong>Fecha y Hora:</strong><br>${invoice.fecha ? invoice.fecha.toDate().toLocaleString() : ""}</td>
                    <td><strong>Cliente:</strong><br>${client ? client.nombreCliente : "N/A"}</td>
                  </tr>
                  <tr>
                    <td><strong>Tienda:</strong><br>${client ? client.nombreTienda : "N/A"}</td>
                    <td><strong>Direcci√≥n:</strong><br>${client ? client.direccion : "N/A"}</td>
                  </tr>
                  <tr>
                    <td><strong>Tel√©fono:</strong><br>${client ? client.telefono : "N/A"}</td>
                    <td><strong>Pago:</strong><br>${invoice.paymentMethod || 'N/A'}</td>
                  </tr>
                </table>
                <table class="items-table">
                  <tr>
                    <th>Cantidad</th>
                    <th>Descripci√≥n</th>
                    <th>Precio Venta</th>
                    <th>Descuento</th>
                    <th>Total</th>
                  </tr>
                  ${invoice.items.map(item => `
                    <tr>
                      <td>${item.quantity}</td>
                      <td>${item.brand} ${item.model} ${item.imei ? '(IMEI: ' + item.imei + ')' : ''}</td>
                      <td>${currencySymbol}${item.price.toFixed(2)}</td>
                      <td>${item.discount}%</td>
                      <td>${currencySymbol}${item.total.toFixed(2)}</td>
                    </tr>
                  `).join('')}
                  <tr>
                    <td colspan="4" style="text-align: right;"><strong>Total a Pagar:</strong></td>
                    <td><strong>${currencySymbol}${invoice.total.toFixed(2)}</strong></td>
                  </tr>
                </table>
                <div class="signature">
                  <p>_______________________</p>
                  <p>Firma del Cliente</p>
                </div>
              </div>
            `;
            document.getElementById('modalInvoiceContent').innerHTML = invoiceHTML;
            document.getElementById('invoiceModal').style.display = 'block';
          });
        }
      }).catch((error) => {
        console.error("Error al ver factura: ", error);
      });
    }

    function closeInvoiceModal() {
      document.getElementById('invoiceModal').style.display = 'none';
    }

    // Inicializar la p√°gina
    window.onload = function() {
      loadClients();
      loadInvoices();
    };
  </script>
</body>
</html>
