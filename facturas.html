<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Facturaci√≥n de Art√≠culos con Escaneo de IMEI üòéüì≤</title>
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
  <!-- Firebase Config (ajusta la URL si tu config est√° en otro lado) -->
  <script src="https://facturacionweb.github.io/facturacionweb/firebase-config.js"></script>
  <!-- jQuery -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <!-- Select2 CSS y JS -->
  <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
  <style>
    /* Estilos b√°sicos */
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      padding: 20px;
      background-color: #f4f4f4;
    }
    .container {
      max-width: 1000px;
      margin: 0 auto;
      background: #fff;
      padding: 20px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    h1, h2, h3 {
      text-align: center;
    }
    label, input, select, button {
      margin: 10px 0;
      padding: 10px;
      width: calc(100% - 20px);
      box-sizing: border-box;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }
    table, th, td {
      border: 1px solid #ccc;
      padding: 10px;
      text-align: center;
    }
    th {
      background-color: #333;
      color: #fff;
    }
    /* Secci√≥n de la factura */
    .invoice-container {
      width: 800px;
      background: #fff;
      padding: 20px;
      margin: 20px auto;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    .invoice-header {
      text-align: center;
      border-bottom: 2px solid #000;
      margin-bottom: 20px;
    }
    .invoice-header h2 {
      margin: 0;
      color: #333;
    }
    .invoice-header .currency, .invoice-header .route {
      font-size: 16px;
      color: #555;
      margin-top: 5px;
    }
    .invoice-body {
      margin-bottom: 20px;
    }
    .details-table, .items-table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 20px;
    }
    .details-table td, .items-table th, .items-table td {
      border: 1px solid #ddd;
      padding: 10px;
      white-space: normal;
      word-wrap: break-word;
    }
    .items-table th {
      background: #333;
      color: #fff;
      text-align: left;
    }
    .signature {
      margin-top: 30px;
      text-align: center;
    }
    /* Estilos para el modal de detalle de factura */
    .modal {
      display: none;
      position: fixed;
      z-index: 100;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgba(0,0,0,0.5);
    }
    .modal-content {
      background-color: #fff;
      margin: 10% auto;
      padding: 20px;
      width: 90%;
      max-width: 800px;
      position: relative;
    }
    .close {
      color: #aaa;
      float: right;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
    }
    /* Oculta todo excepto la factura al imprimir (para la ventana principal) */
    @media print {
      body * {
        visibility: hidden;
      }
      #invoiceContainer, #invoiceContainer * {
        visibility: visible;
      }
      #invoiceContainer {
        position: absolute;
        left: 0;
        top: 0;
        width: 100%;
      }
    }
  </style>
</head>
<body>
  <a href="index.html">Volver a la P√°gina Principal</a>
  <div class="container">
    <h1>Facturaci√≥n de Art√≠culos üìÑüí∞</h1>
    
    <!-- Secci√≥n: Crear Nueva Factura -->
    <h2>Crear Nueva Factura</h2>
    <label for="clientSelect">Selecciona Cliente:</label>
    <select id="clientSelect"></select>

    <label for="invoiceRoute">Ruta de la Factura:</label>
    <select id="invoiceRoute">
      <option value="SIN RUTA">SIN RUTA</option>
      <option value="1">1</option>
      <option value="2">2</option>
      <option value="3">3</option>
      <option value="4">4</option>
      <option value="5">5</option>
    </select>

    <!-- Nuevo selector de Moneda -->
    <!--<label for="currencySelect">Moneda:</label>
    <select id="currencySelect">
      <option value="CORD">C√≥rdobas (C$)</option>
      <option value="USD">D√≥lares ($)</option>
    </select>-->

    <!-- Nuevo selector de M√©todo de Pago -->
    <label for="paymentType">M√©todo de Pago:</label>
    <select id="paymentType">
      <option value="Efectivo">Efectivo</option>
      <option value="Transferencia">Transferencia</option>
      <option value="Credito">Cr√©dito</option>
    </select>
      
    <!-- Informaci√≥n adicional para Transferencia -->
    <div id="transferInfo" style="display: none;">
      <label for="bankSelect">Selecciona Banco:</label>
      <select id="bankSelect">
        <option value="BAC">BAC</option>
        <option value="LA FISE">LA FISE</option>
        <option value="BANPRO">BANPRO</option>
        <option value="AVANZ">AVANZ</option>
      </select>
      <label for="bankReference">N√∫mero de Referencia Bancaria:</label>
      <input type="text" id="bankReference" placeholder="N√∫mero de Referencia Bancaria">
    </div>

    <!-- ****************************************************************** -->
    <!-- NUEVA SECCI√ìN: Escaneo de IMEI para Facturaci√≥n -->
    <!-- ****************************************************************** -->
    <h3>Escaneo de IMEI para Facturaci√≥n üì≤</h3>
    <label for="invoiceImei">Escanear IMEI:</label>
    <input type="text" id="invoiceImei" placeholder="Escanea el IMEI del art√≠culo" />
    <button onclick="addInvoiceItemByScan()">Agregar IMEI</button>

    <!-- Tabla de previsualizaci√≥n de items escaneados -->
    <h3>Previsualizaci√≥n de Items Escaneados üìã</h3>
    <table id="invoicePreviewTable">
      <thead>
        <tr>
          <th>Art√≠culo</th>
          <th>Precio Venta</th>
          <th>Descuento (%)</th>
          <th>Total</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody>
        <!-- Se llenar√° din√°micamente -->
      </tbody>
    </table>
    <button onclick="saveInvoicePreviewItems()">Guardar Items Escaneados ‚ûï</button>
    <h3>Total Previsualizaci√≥n: <span id="previewTotal">0.00</span></h3>

    <!-- ****************************************************************** -->
    <!-- FIN DE NUEVA SECCI√ìN -->
    <!-- ****************************************************************** -->

    <!-- Tabla para los items de la factura -->
    <h3>Items de Factura</h3>
    <table id="invoiceItemsTable">
      <thead>
        <tr>
          <th>Art√≠culo</th>
          <th>Cantidad</th>
          <th>Precio Venta</th>
          <th>Descuento (%)</th>
          <th>Total</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody>
        <!-- Aqu√≠ se agregan las filas din√°micamente -->
      </tbody>
    </table>
    <h3>Total a Pagar: <span id="invoiceTotal">0.00</span></h3>
    <button onclick="createInvoice()">Crear Factura üíµ</button>

    <!-- Secci√≥n para mostrar la factura creada (en la p√°gina principal) -->
    <div id="invoiceDisplay" style="display:none;">
      <h2>Factura Generada</h2>
      <div class="invoice-container" id="invoiceContainer">
        <!-- Aqu√≠ se mostrar√° la factura con el detalle -->
      </div>
      <button onclick="printInvoice()">Imprimir Factura üñ®Ô∏è</button>
    </div>

    <hr>
    <!-- Secci√≥n: Listado de Facturas -->
    <h2>Listado de Facturas</h2>

    <!-- Filtros -->
    <label for="filterDate">Filtrar por Fecha:</label>
    <input type="date" id="filterDate">

    <label for="filterRoute">Filtrar por Ruta:</label>
    <select id="filterRoute">
      <option value="">-- Todas --</option>
      <option value="SIN RUTA">SIN RUTA</option>
      <option value="1">1</option>
      <option value="2">2</option>
      <option value="3">3</option>
      <option value="4">4</option>
      <option value="5">5</option>
    </select>

    <!-- Filtro: Estado -->
    <label for="filterAnulada">Estado:</label>
    <select id="filterAnulada">
      <option value="">-- Todas --</option>
      <option value="false">No Anuladas</option>
      <option value="true">Anuladas</option>
    </select>

    <!-- Filtro: M√©todo de Pago -->
    <label for="filterPaymentMethod">M√©todo de Pago:</label>
    <select id="filterPaymentMethod">
      <option value="">-- Todos --</option>
      <option value="Efectivo">Efectivo</option>
      <option value="Transferencia">Transferencia</option>
      <option value="Credito">Cr√©dito</option>
    </select>

    <button onclick="filterInvoices()">Filtrar Facturas üîç</button>

    <table id="invoicesTable">
      <thead>
        <tr>
          <th>ID Factura</th>
          <th>Fecha y Hora</th>
          <th>Cliente</th>
          <th>Ruta</th>
          <th>Total</th>
          <th>Estado</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody>
        <!-- Aqu√≠ se listan las facturas -->
      </tbody>
    </table>

    <!-- ******************************************************************
         SECCI√ìN: Registrar Abonos (Subcolecci√≥n)
    ****************************************************************** -->
    <!--<hr>
    <h2>Registrar Abonos a Facturas de Cr√©dito üí∏</h2>
    <label for="abonoClientSelect">Selecciona Cliente:</label>
    <select id="abonoClientSelect" onchange="loadCreditInvoicesForAbonos()">
      
    </select>

    <label for="abonoInvoiceSelect">Selecciona Factura (Cr√©dito Pendiente):</label>
    <select id="abonoInvoiceSelect" onchange="updateAbonoAmount()">
      
    </select>

    <label for="abonoAmount">Monto a Abonar (C$):</label>
    <input type="number" id="abonoAmount" step="0.01" min="0.01" />

    <label for="abonoRoute">Ruta del Abono:</label>
    <select id="abonoRoute">
      <option value="SIN RUTA">SIN RUTA</option>
      <option value="1">1</option>
      <option value="2">2</option>
      <option value="3">3</option>
      <option value="4">4</option>
      <option value="5">5</option>
      <option value="6">6</option>
      <option value="7">7</option>
      <option value="8">8</option>
      <option value="9">9</option>
      <option value="10">10</option>
    </select>

    <button onclick="registerAbono()">REGISTRAR ABONO</button>
    <button onclick="cancelAbono()">CANCELAR</button>

    
    <div id="abonoReceiptContainer" style="display:none; margin-top:20px;">
      <div id="abonoReceipt" style="border:1px solid #333; padding:10px;">
        
      </div>
      <button onclick="printAbonoReceipt()">Imprimir Recibo üñ®Ô∏è</button>
    </div>-->
    <!-- ****************************************************************** -->
  </div>

  <script>
    // Inicializar Firestore
    const db = firebase.firestore();
    let invoiceTotal = 0;
    // Arreglo para acumular los items escaneados en la previsualizaci√≥n
    let invoicePreviewItems = [];

    // Mostrar u ocultar informaci√≥n adicional para transferencia
    document.getElementById('paymentType').addEventListener('change', function() {
      if (this.value === "Transferencia") {
        document.getElementById('transferInfo').style.display = 'block';
      } else {
        document.getElementById('transferInfo').style.display = 'none';
      }
    });

    // Cargar clientes en el select de facturaci√≥n
    function loadClients() {
      db.collection("clientes").get().then((querySnapshot) => {
        const clientSelect = document.getElementById('clientSelect');
        clientSelect.innerHTML = '';
        querySnapshot.forEach((doc) => {
          const client = doc.data();
          const option = document.createElement('option');
          option.value = doc.id;
          option.textContent = client.nombreCliente + " - " + client.nombreTienda;
          clientSelect.appendChild(option);
        });
      }).catch((error) => {
        console.error("Error al cargar clientes: ", error);
      });
    }

    // ******************************************************************
    // Funciones para el escaneo y previsualizaci√≥n de IMEIs en facturaci√≥n
    // ******************************************************************

    // Agregar item a previsualizaci√≥n v√≠a escaneo
    function addInvoiceItemByScan() {
      const scannedImei = document.getElementById('invoiceImei').value.trim();
      if (!scannedImei) {
        alert("Deb√©s ingresar/escaniar un IMEI üò¨");
        return;
      }
      // Verificar si ya fue escaneado en la previsualizaci√≥n
      if (invoicePreviewItems.some(item => item.imei === scannedImei)) {
        alert("Este IMEI ya est√° en la previsualizaci√≥n üòÖ");
        document.getElementById('invoiceImei').value = '';
        return;
      }
      // Consultar en Articulos_X_IMEI para ver si el IMEI existe
      db.collection("Articulos_X_IMEI").where("imei", "==", scannedImei).get()
      .then((querySnapshot) => {
        if (querySnapshot.empty) {
          alert("El IMEI no se encontr√≥ en inventario üò¨");
          return;
        }
        // Tomamos el primer documento encontrado
        const doc = querySnapshot.docs[0];
        const imeiData = doc.data();
        const articleId = imeiData.articleId;
        // Consultar la informaci√≥n del art√≠culo en la colecci√≥n Articulos
        db.collection("Articulos").doc(articleId).get().then((docSnap) => {
          if (!docSnap.exists) {
            alert("No se encontr√≥ informaci√≥n del art√≠culo asociado üò¨");
            return;
          }
          const articleData = docSnap.data();
          // Crear objeto item para previsualizaci√≥n
          const newItem = {
            articleId: articleId,
            marca: articleData.marca,
            modelo: articleData.modelo,
            imei: scannedImei,
            precioVenta: articleData.precioVenta || 0,
            imeiDocId: doc.id,
            discount: 0,
            total: parseFloat(articleData.precioVenta || 0)
          };
          // Agregar al arreglo y actualizar tabla de previsualizaci√≥n
          invoicePreviewItems.push(newItem);
          updateInvoicePreviewTable();
          // Limpiar y reenfocar el input para el siguiente escaneo
          document.getElementById('invoiceImei').value = '';
          document.getElementById('invoiceImei').focus();
        }).catch((error) => {
          console.error("Error al obtener art√≠culo: ", error);
        });
      }).catch((error) => {
        console.error("Error al buscar IMEI: ", error);
      });
    }

    // Escucha el evento "Enter" para procesar el escaneo autom√°ticamente
    document.getElementById('invoiceImei').addEventListener('keyup', function(event) {
      if (event.key === 'Enter') {
        addInvoiceItemByScan();
      }
    });

    // Actualiza la tabla de previsualizaci√≥n con los items escaneados
    function updateInvoicePreviewTable() {
      const tbody = document.querySelector('#invoicePreviewTable tbody');
      tbody.innerHTML = '';
      invoicePreviewItems.forEach((item, index) => {
        const row = document.createElement('tr');

        // Columna Art√≠culo (marca, modelo e IMEI)
        const articleCell = document.createElement('td');
        articleCell.textContent = `${item.marca} ${item.modelo} - IMEI: ${item.imei}`;
        row.appendChild(articleCell);

        // Columna Precio Venta (editable)
        const priceCell = document.createElement('td');
        const priceInput = document.createElement('input');
        priceInput.type = 'number';
        priceInput.value = item.precioVenta;
        priceInput.addEventListener('input', function() {
          item.precioVenta = parseFloat(priceInput.value) || 0;
          recalcPreviewRow(item, row);
        });
        priceCell.appendChild(priceInput);
        row.appendChild(priceCell);

        // Columna Descuento (editable)
        const discountCell = document.createElement('td');
        const discountInput = document.createElement('input');
        discountInput.type = 'number';
        discountInput.value = item.discount;
        discountInput.addEventListener('input', function() {
          item.discount = parseFloat(discountInput.value) || 0;
          recalcPreviewRow(item, row);
        });
        discountCell.appendChild(discountInput);
        row.appendChild(discountCell);

        // Columna Total (calculado)
        const totalCell = document.createElement('td');
        totalCell.textContent = calculateItemTotal(item).toFixed(2);
        row.appendChild(totalCell);

        // Columna Acciones (Eliminar)
        const actionsCell = document.createElement('td');
        const delBtn = document.createElement('button');
        delBtn.textContent = "Eliminar";
        delBtn.onclick = function() {
          removeInvoicePreviewItem(index);
        };
        actionsCell.appendChild(delBtn);
        row.appendChild(actionsCell);

        tbody.appendChild(row);
      });
      recalcPreviewTotal();
    }

    // Calcula el total de un item en previsualizaci√≥n
    function calculateItemTotal(item) {
      let total = item.precioVenta;
      if(item.discount > 0) {
        total -= (total * item.discount / 100);
      }
      return total;
    }

    // Recalcula la fila de previsualizaci√≥n y actualiza el total
    function recalcPreviewRow(item, row) {
      const totalCell = row.children[3];
      totalCell.textContent = calculateItemTotal(item).toFixed(2);
      recalcPreviewTotal();
    }

    // Recalcula el total de todos los items en previsualizaci√≥n y lo muestra
    function recalcPreviewTotal() {
      let sum = 0;
      invoicePreviewItems.forEach(item => {
        sum += calculateItemTotal(item);
      });
      document.getElementById('previewTotal').textContent = sum.toFixed(2);
    }

    // Elimina un item de la previsualizaci√≥n
    function removeInvoicePreviewItem(index) {
      invoicePreviewItems.splice(index, 1);
      updateInvoicePreviewTable();
    }

    // Transfiere los items de previsualizaci√≥n a la tabla de items de factura
    function saveInvoicePreviewItems() {
      if (invoicePreviewItems.length === 0) {
        alert("No hay items en la previsualizaci√≥n üò¨");
        return;
      }
      const tbody = document.querySelector('#invoiceItemsTable tbody');
      invoicePreviewItems.forEach(item => {
        const row = document.createElement('tr');

        // Columna Art√≠culo: Creamos un select oculto con un solo option
        const articleCell = document.createElement('td');
        const articleSelect = document.createElement('select');
        const option = document.createElement('option');
        option.value = JSON.stringify(item);
        option.textContent = `${item.marca} ${item.modelo} - IMEI: ${item.imei}`;
        articleSelect.appendChild(option);
        articleSelect.disabled = true;
        articleCell.appendChild(articleSelect);
        row.appendChild(articleCell);

        // Columna Cantidad (fija en 1)
        const qtyCell = document.createElement('td');
        const qtyInput = document.createElement('input');
        qtyInput.type = 'number';
        qtyInput.value = 1;
        qtyInput.disabled = true;
        qtyCell.appendChild(qtyInput);
        row.appendChild(qtyCell);

        // Columna Precio Venta (editable)
        const priceCell = document.createElement('td');
        const priceInput = document.createElement('input');
        priceInput.type = 'number';
        priceInput.value = item.precioVenta;
        priceCell.appendChild(priceInput);
        row.appendChild(priceCell);

        // Columna Descuento (editable)
        const discountCell = document.createElement('td');
        const discountInput = document.createElement('input');
        discountInput.type = 'number';
        discountInput.value = item.discount;
        discountCell.appendChild(discountInput);
        row.appendChild(discountCell);

        // Columna Total (calculado)
        const totalCell = document.createElement('td');
        const recalcRow = function() {
          const price = parseFloat(priceInput.value) || 0;
          const discount = parseFloat(discountInput.value) || 0;
          let total = price;
          if(discount > 0) {
            total -= (total * discount / 100);
          }
          totalCell.textContent = total.toFixed(2);
          recalculateInvoice();
        };
        recalcRow();
        [priceInput, discountInput].forEach(input => {
          input.addEventListener('input', recalcRow);
        });
        row.appendChild(totalCell);

        // Columna Acciones (Eliminar fila)
        const actionsCell = document.createElement('td');
        const delBtn = document.createElement('button');
        delBtn.textContent = "Eliminar";
        delBtn.onclick = function() {
          tbody.removeChild(row);
          recalculateInvoice();
        };
        actionsCell.appendChild(delBtn);
        row.appendChild(actionsCell);

        tbody.appendChild(row);
      });
      // Limpiar previsualizaci√≥n y actualizar total de factura
      invoicePreviewItems = [];
      updateInvoicePreviewTable();
      recalculateInvoice();
    }

    // Recalcular total de factura (suma de los items en la tabla de factura)
    function recalculateInvoice() {
      const rows = document.querySelectorAll('#invoiceItemsTable tbody tr');
      let total = 0;
      rows.forEach(row => {
        const totalCell = row.children[4];
        total += parseFloat(totalCell.textContent) || 0;
      });
      invoiceTotal = total;
      document.getElementById('invoiceTotal').textContent = invoiceTotal.toFixed(2);
    }

    // Crear factura y guardar en Firestore (eliminando IMEIs usados)
    function createInvoice() {
      const clientId = document.getElementById('clientSelect').value;
      const route = document.getElementById('invoiceRoute').value;
      const currency = "N/A";//document.getElementById('currencySelect').value;

      let paymentType = document.getElementById('paymentType').value;
      let paymentMethod;
      if (paymentType === "Transferencia") {
        let bank = document.getElementById('bankSelect').value;
        let bankReference = document.getElementById('bankReference').value;
        paymentMethod = `Transferencia - Banco: ${bank} (#Ref: ${bankReference})`;
      } else if (paymentType === "Credito") {
        paymentMethod = "Cr√©dito a 30 d√≠as";
      } else {
        paymentMethod = "Efectivo";
      }

      const items = [];
      const rows = document.querySelectorAll('#invoiceItemsTable tbody tr');
      rows.forEach(row => {
        const articleSelectElem = row.children[0].querySelector('select');
        const quantity = parseFloat(row.children[1].querySelector('input').value) || 1;
        const price = parseFloat(row.children[2].querySelector('input').value) || 0;
        const discount = parseFloat(row.children[3].querySelector('input').value) || 0;
        const total = parseFloat(row.children[4].textContent) || 0;

        if (!articleSelectElem.value) return;
        if (total <= 0) return;

        const parsedValue = JSON.parse(articleSelectElem.value);
        const brand = parsedValue.marca;
        const model = parsedValue.modelo;
        const imei = parsedValue.imei;
        const articleId = parsedValue.articleId;
        const imeiDocId = parsedValue.imeiDocId;

        const imeiDocData = {
          articleId: articleId,
          imei: imei
        };

        items.push({
          articleId,
          brand,
          model,
          imei,
          imeiDocId,
          imeiDocData,
          quantity,
          price,
          discount,
          total
        });
      });

      const now = new Date();
      const yyyy = now.getFullYear();
      const mm = String(now.getMonth() + 1).padStart(2, '0');
      const dd = String(now.getDate()).padStart(2, '0');
      const fechaStr = `${yyyy}-${mm}-${dd}`;

      // üö® IMPORTANTE: Guardar "saldo" en la factura igual a "invoiceTotal"
      // para manejar pagos parciales
      const invoice = {
        clientId,
        route,
        currency,
        paymentType,
        paymentMethod,
        items,
        total: invoiceTotal,
        fecha: now,
        fechaStr,
        anulada: false,
        saldo: invoiceTotal // <-- Aqu√≠ almacenamos el saldo inicial
      };

      db.collection("facturas").add(invoice).then((docRef) => {
        alert("¬°Factura creada con √©xito! üéâ");

        // Eliminar los IMEIs seleccionados (si tienen imeiDocId)
        items.forEach(item => {
          if (item.imeiDocId) {
            db.collection("Articulos_X_IMEI").doc(item.imeiDocId).delete()
              .then(() => console.log(`IMEI doc ${item.imeiDocId} eliminado de Articulos_X_IMEI`))
              .catch(err => console.error("Error al eliminar IMEI doc:", err));
          }
        });

        displayInvoice(docRef.id, invoice);
        loadInvoices();
        document.querySelector('#invoiceItemsTable tbody').innerHTML = '';
        document.getElementById('invoiceTotal').textContent = "0.00";
      }).catch((error) => {
        console.error("Error al crear factura: ", error);
      });
    }

    // Mostrar factura generada (en la parte principal)
    function displayInvoice(invoiceId, invoice) {
      db.collection("clientes").doc(invoice.clientId).get().then((doc) => {
        const client = doc.data();
        let currencySymbol = invoice.currency === 'CORD' ? 'C$' : '$';
        let currencyText = invoice.currency === 'CORD' ? 'C√≥rdobas (C$)' : 'D√≥lares ($)';
        const invoiceHTML = `
          <div class="invoice-header">
            <h2>Factura - ${invoiceId}</h2>
            <p class="currency"><strong>Moneda:</strong> ${currencyText}</p>
            <p class="route"><strong>Ruta de la Factura:</strong> ${invoice.route}</p>
          </div>
          <div class="invoice-body">
            <table class="details-table">
              <tr>
                <td><strong>Fecha y Hora:</strong><br>${invoice.fecha ? invoice.fecha.toLocaleString() : ""}</td>
                <td><strong>Cliente:</strong><br>${client ? client.nombreCliente : "N/A"}</td>
              </tr>
              <tr>
                <td><strong>Tienda:</strong><br>${client ? client.nombreTienda : "N/A"}</td>
                <td><strong>Direcci√≥n:</strong><br>${client ? client.direccion : "N/A"}</td>
              </tr>
              <tr>
                <td><strong>Tel√©fono:</strong><br>${client ? client.telefono : "N/A"}</td>
                <td><strong>Pago:</strong><br>${invoice.paymentMethod || 'N/A'}</td>
              </tr>
            </table>
            <table class="items-table">
              <tr>
                <th>Cantidad</th>
                <th>Descripci√≥n</th>
                <th>Precio Venta</th>
                <th>Descuento</th>
                <th>Total</th>
              </tr>
              ${invoice.items.map(item => `
                <tr>
                  <td>${item.quantity}</td>
                  <td>${item.brand} ${item.model} ${item.imei ? '(IMEI: ' + item.imei + ')' : ''}</td>
                  <td>${currencySymbol}${item.price.toFixed(2)}</td>
                  <td>${item.discount}%</td>
                  <td>${currencySymbol}${item.total.toFixed(2)}</td>
                </tr>
              `).join('')}
              <tr>
                <td colspan="4" style="text-align: right;"><strong>Total a Pagar:</strong></td>
                <td><strong>${currencySymbol}${invoice.total.toFixed(2)}</strong></td>
              </tr>
            </table>
            <div class="signature">
              <p>_______________________</p>
              <p>Firma del Cliente</p>
            </div>
          </div>
        `;
        document.getElementById('invoiceContainer').innerHTML = invoiceHTML;
        document.getElementById('invoiceDisplay').style.display = 'block';
      }).catch((error) => {
        console.error("Error al obtener datos del cliente: ", error);
      });
    }

    // Imprimir factura desde la parte principal
    function printInvoice() {
      window.print();
    }

    // Listar facturas
    function loadInvoices() {
      db.collection("facturas").orderBy("fecha", "desc").get().then((querySnapshot) => {
        const tbody = document.querySelector('#invoicesTable tbody');
        tbody.innerHTML = '';
        querySnapshot.forEach((doc) => {
          const invoice = doc.data();

          let status = "";
          if (invoice.anulada) {
            status = "ANULADA";
          } else if (invoice.paymentType === "Credito" && parseFloat(invoice.saldo) === 0) {
            status = "PAGADA";
          } else {
            status = "ACTIVA";
          }

        let fecha = (typeof invoice.fecha.toDate === "function") 
            ? invoice.fecha.toDate()
            : new Date(invoice.fecha);

          //invoice.fecha ? invoice.fecha.toDate().toLocaleString() : ""
          const row = document.createElement('tr');
          row.innerHTML = `
            <td>${doc.id}</td>
            <td>${fecha}</td>
            <td>${invoice.clientId}</td>
            <td>${invoice.route}</td>
            <td>${invoice.total.toFixed(2)}</td>
            <td>${status}</td>
            <td>
              <button onclick="viewInvoiceDetail('${doc.id}')">Ver</button>
              ${invoice.anulada ? "" : `<button onclick="anularInvoice('${doc.id}')">ANULAR</button>`}
            </td>
          `;
          tbody.appendChild(row);
        });
      }).catch((error) => {
        console.error("Error al cargar facturas: ", error);
      });
    }

    // Anular factura y restaurar IMEIs
    function anularInvoice(invoiceId) {
      if (confirm("¬øEst√° seguro de ANULAR la factura?")) {
        let invoiceData = null;
        db.collection("facturas").doc(invoiceId).get()
          .then(docSnap => {
            if (!docSnap.exists) {
              throw new Error("La factura no existe.");
            }
            invoiceData = docSnap.data();
            return db.collection("facturas").doc(invoiceId).update({ anulada: true });
          })
          .then(() => {
            const items = invoiceData.items || [];
            const promises = [];
            /*items.forEach(item => {
              if (item.imeiDocId && item.imeiDocData) {
                const docRef = db.collection("Articulos_X_IMEI").doc(item.imeiDocId);
                promises.push(docRef.set(item.imeiDocData));
              }
            });*/
            /*items.forEach(item => {
                if (item.imei && item.articleId) {
                    const imeiDoc = {
                    imei: item.imei,
                    articleId: item.articleId
                    };
                    // Restaurar con nuevo ID basado en imei (o como se genere en tu sistema)
                    const newDocRef = db.collection("Articulos_X_IMEI").doc(); // o .doc(item.imei)
                    promises.push(newDocRef.set(imeiDoc));
                }
            });*/
            items.forEach(item => {
                console.log("Procesando item:", item); // üîç Muestra todo el item
              
                if (item.imei && item.articleId) {
                  const imeiDoc = {
                    imei: item.imei,
                    articleId: item.articleId
                  };
              
                  // üîç Mostrar el contenido a insertar
                  console.log("Preparando restauraci√≥n:", imeiDoc);
              
                  // Pod√©s usar el imei como ID si lo manej√°s as√≠ en Firestore
                  const newDocRef = db.collection("Articulos_X_IMEI").doc(item.imei);
                  const promise = newDocRef.set(imeiDoc)
                    .then(() => console.log(`‚úÖ IMEI ${item.imei} restaurado correctamente`))
                    .catch(err => console.error(`‚ùå Error al restaurar IMEI ${item.imei}`, err));
              
                  promises.push(promise);
                } else {
                  console.warn("‚ö†Ô∏è Item ignorado por falta de imei o articleId:", item);
                }
              });
              
              console.log("Total de operaciones push a promises:", promises.length);
            
            return Promise.all(promises);
          })
          .then(() => {
            alert("Factura ANULADA con √©xito. IMEIs restaurados.");
            loadInvoices();
          })
          .catch((error) => {
            console.error("Error al anular factura:", error);
          });
      }
    }

    // Filtros de facturas
    function filterInvoices() {
      const filterDate = document.getElementById('filterDate').value;
      const filterRoute = document.getElementById('filterRoute').value;
      const filterAnulada = document.getElementById('filterAnulada').value;
      const filterPaymentMethod = document.getElementById('filterPaymentMethod').value;

      let query = db.collection("facturas");

      if (filterDate) {
        query = query.where("fechaStr", "==", filterDate);
      }
      if (filterRoute) {
        query = query.where("route", "==", filterRoute);
      }
      if (filterAnulada) {
        const boolVal = (filterAnulada === "true");
        query = query.where("anulada", "==", boolVal);
      }
      if (filterPaymentMethod) {
        query = query.where("paymentType", "==", filterPaymentMethod);
      }

      query = query.orderBy("fecha", "desc");

      query.get()
        .then((querySnapshot) => {
          const tbody = document.querySelector('#invoicesTable tbody');
          tbody.innerHTML = '';
          querySnapshot.forEach((doc) => {
            const invoice = doc.data();

            let status = "";
            if (invoice.anulada) {
              status = "ANULADA";
            } else if (invoice.paymentType === "Credito" && parseFloat(invoice.saldo) === 0) {
              status = "PAGADA";
            } else {
              status = "ACTIVA";
            }

            let fecha = (typeof invoice.fecha.toDate === "function") 
            ? invoice.fecha.toDate()
            : new Date(invoice.fecha);
            //invoice.fecha ? invoice.fecha.toDate().toLocaleString() : ""
            const row = document.createElement('tr');
            row.innerHTML = `
              <td>${doc.id}</td>
              <td>${fecha}</td>
              <td>${invoice.clientId}</td>
              <td>${invoice.route}</td>
              <td>${invoice.total.toFixed(2)}</td>
              <td>${status}</td>
              <td>
                <button onclick="viewInvoiceDetail('${doc.id}')">Ver</button>
                ${invoice.anulada ? "" : `<button onclick="anularInvoice('${doc.id}')">ANULAR</button>`}
              </td>
            `;
            tbody.appendChild(row);
          });
        })
        .catch((error) => {
          console.error("Error al filtrar facturas: ", error);
        });
    }

    // ******************************************************************
    // VER DETALLE EN EL MODAL + BOT√ìN DE IMPRIMIR SOLO LA FACTURA
    // ******************************************************************

    // Funci√≥n para ver detalle de una factura en un modal
    function viewInvoiceDetail(invoiceId) {
      db.collection("facturas").doc(invoiceId).get().then((doc) => {
        if(doc.exists) {
          const invoice = doc.data();
          db.collection("clientes").doc(invoice.clientId).get().then((clientDoc) => {
            const client = clientDoc.data();
            let currencySymbol = invoice.currency === 'CORD' ? 'C$' : '$';
            let currencyText = invoice.currency === 'CORD' ? 'C√≥rdobas (C$)' : 'D√≥lares ($)';

            // Mostrar "ANULADA" si es true
            let invoiceStatus = invoice.anulada 
              ? `<span style="color: red; font-weight: bold;">ANULADA</span>` 
              : '';

            let fecha = (typeof invoice.fecha.toDate === "function") 
            ? invoice.fecha.toDate()
            : new Date(invoice.fecha);
            //invoice.fecha ? invoice.fecha.toDate().toLocaleString() : ""
            const invoiceHTML = `
              <div class="invoice-header">
                <h2>Factura - ${invoiceId} ${invoiceStatus}</h2>
                <p class="currency"><strong>Moneda:</strong> ${currencyText}</p>
                <p class="route"><strong>Ruta de la Factura:</strong> ${invoice.route}</p>
              </div>
              <div class="invoice-body">
                <table class="details-table">
                  <tr>
                    <td><strong>Fecha y Hora:</strong><br>${fecha}</td>
                    <td><strong>Cliente:</strong><br>${client ? client.nombreCliente : "N/A"}</td>
                  </tr>
                  <tr>
                    <td><strong>Tienda:</strong><br>${client ? client.nombreTienda : "N/A"}</td>
                    <td><strong>Direcci√≥n:</strong><br>${client ? client.direccion : "N/A"}</td>
                  </tr>
                  <tr>
                    <td><strong>Tel√©fono:</strong><br>${client ? client.telefono : "N/A"}</td>
                    <td><strong>Pago:</strong><br>${invoice.paymentMethod || 'N/A'}</td>
                  </tr>
                </table>
                <table class="items-table">
                  <tr>
                    <th>Cantidad</th>
                    <th>Descripci√≥n</th>
                    <th>Precio Venta</th>
                    <th>Descuento</th>
                    <th>Total</th>
                  </tr>
                  ${invoice.items.map(item => `
                    <tr>
                      <td>${item.quantity}</td>
                      <td>${item.brand} ${item.model} ${item.imei ? '(IMEI: ' + item.imei + ')' : ''}</td>
                      <td>${currencySymbol}${item.price.toFixed(2)}</td>
                      <td>${item.discount}%</td>
                      <td>${currencySymbol}${item.total.toFixed(2)}</td>
                    </tr>
                  `).join('')}
                  <tr>
                    <td colspan="4" style="text-align: right;"><strong>Total a Pagar:</strong></td>
                    <td><strong>${currencySymbol}${invoice.total.toFixed(2)}</strong></td>
                  </tr>
                </table>
                <div class="signature">
                  <p>_______________________</p>
                  <p>Firma del Cliente</p>
                </div>
              </div>
              <!-- Bot√≥n para imprimir SOLO esta factura -->
              <div style="text-align:center; margin-top:20px;">
                <button onclick="printModalInvoice()">Imprimir Factura üñ®Ô∏è</button>
              </div>
            `;
            document.getElementById('modalInvoiceContent').innerHTML = invoiceHTML;
            document.getElementById('invoiceModal').style.display = 'block';
          });
        }
      }).catch((error) => {
        console.error("Error al ver factura: ", error);
      });
    }

    // Funci√≥n para imprimir solo la factura del modal
    function printModalInvoice() {
      const modalContent = document.getElementById('modalInvoiceContent').innerHTML;
      // Abrir ventana emergente con el contenido de la factura
      const printWindow = window.open('', '_blank', 'width=800,height=600');
      printWindow.document.write(`
        <!DOCTYPE html>
        <html>
        <head>
          <title>Imprimir Factura</title>
          <style>
            /* Estilos b√°sicos para la impresi√≥n del modal */
            body {
              font-family: Arial, sans-serif;
              margin: 20px;
              padding: 20px;
            }
            .invoice-header h2 {
              margin: 0;
            }
            .items-table, .details-table {
              width: 100%;
              border-collapse: collapse;
              margin-top: 20px;
            }
            .items-table th, .items-table td, .details-table td {
              border: 1px solid #ccc;
              padding: 8px;
              text-align: left;
            }
            .items-table th {
              background-color: #333;
              color: #fff;
            }
            .signature {
              margin-top: 30px;
              text-align: center;
            }
            .invoice-header {
              text-align: center;
              border-bottom: 2px solid #000;
              margin-bottom: 20px;
            }
          </style>
        </head>
        <body>
          ${modalContent}
        </body>
        </html>
      `);
      printWindow.document.close();
      printWindow.focus();
      printWindow.print();
      printWindow.close();
    }

    function closeInvoiceModal() {
      document.getElementById('invoiceModal').style.display = 'none';
    }

    // ******************************************************************
    // SECCI√ìN DE ABONOS COMO SUBCOLECCI√ìN DE FACTURAS
    // ******************************************************************

    // Cargar lista de clientes para el select de abonos
    function loadClientsForAbonos() {
      const abonoClientSelect = document.getElementById('abonoClientSelect');
      abonoClientSelect.innerHTML = ''; // limpiar
      db.collection("clientes").get().then((querySnapshot) => {
        querySnapshot.forEach((doc) => {
          const data = doc.data();
          const opt = document.createElement('option');
          opt.value = doc.id;
          opt.textContent = data.nombreCliente + " - " + data.nombreTienda;
          abonoClientSelect.appendChild(opt);
        });

      // Si solo hay un cliente, dispara la carga de facturas autom√°ticamente
      if (abonoClientSelect.options.length === 1) {
        loadCreditInvoicesForAbonos();
      }
        
      }).catch((err) => {
        console.error("Error al cargar clientes para abonos:", err);
      });
    }

    // Cargar facturas de cr√©dito pendientes (saldo > 0) para el cliente seleccionado
    async function loadCreditInvoicesForAbonos() {
      const clientId = document.getElementById('abonoClientSelect').value;
      const abonoInvoiceSelect = document.getElementById('abonoInvoiceSelect');
      abonoInvoiceSelect.innerHTML = '';

      try {
        // Filtrar facturas de este cliente con paymentType="Credito" y no anuladas
        const querySnap = await db.collection("facturas")
          .where("clientId", "==", clientId)
          .where("paymentType", "==", "Credito")
          .where("anulada", "==", false)
          .orderBy("fecha", "asc")
          .get();

        querySnap.forEach((docFact) => {
          const factData = docFact.data();
          
          /*// Verificamos si el saldo > 0
          const saldo = factData.saldo !== undefined ? factData.saldo : factData.total;
          if (saldo > 0) {
            const opt = document.createElement('option');
            opt.value = docFact.id;
            opt.textContent = `Factura: ${docFact.id} - Saldo: C$${saldo.toFixed(2)}`;*/

          // Verificamos el saldo: si el campo 'saldo' existe, se usa; si no, se usa 'total'
          const saldo = factData.saldo !== undefined ? factData.saldo : factData.total;
          if (saldo > 0) {
            const opt = document.createElement('option');
            opt.value = docFact.id;
            opt.textContent = `Factura: ${docFact.id} - Saldo: C$${saldo.toFixed(2)}`;
            // Guardamos el saldo pendiente en un atributo data-saldo
            opt.dataset.saldo = saldo;
            abonoInvoiceSelect.appendChild(opt);
          }
          
        });

        // Si solo hay una factura, se dispara autom√°ticamente la funci√≥n para actualizar el monto
        if (abonoInvoiceSelect.options.length === 1) {
          updateAbonoAmount();
        }
        
        
      } catch (error) {
        console.error("Error al cargar facturas de cr√©dito:", error);
      }
    }

    function updateAbonoAmount() {
      const abonoInvoiceSelect = document.getElementById('abonoInvoiceSelect');
      const selectedOption = abonoInvoiceSelect.options[abonoInvoiceSelect.selectedIndex];
      if (selectedOption && selectedOption.dataset.saldo) {
        // Establece el input con el saldo pendiente
        document.getElementById('abonoAmount').value = parseFloat(selectedOption.dataset.saldo).toFixed(2);
      } else {
        document.getElementById('abonoAmount').value = "";
      }
    }


    // Registrar Abono usando una transacci√≥n
    async function registerAbono() {
      const clientId = document.getElementById('abonoClientSelect').value;
      const invoiceId = document.getElementById('abonoInvoiceSelect').value;
      const abonoAmountInput = document.getElementById('abonoAmount');
      const route = document.getElementById('abonoRoute').value;

      if (!clientId || !invoiceId) {
        alert("Debes seleccionar cliente y factura primero. üò¨");
        return;
      }

      let abonoAmount = parseFloat(abonoAmountInput.value);
      if (isNaN(abonoAmount) || abonoAmount <= 0) {
        alert("Monto de abono inv√°lido. üò¨");
        return;
      }

      try {
        await db.runTransaction(async (transaction) => {
          const invoiceRef = db.collection("facturas").doc(invoiceId);
          const invoiceDoc = await transaction.get(invoiceRef);

          if (!invoiceDoc.exists) {
            throw new Error("La factura no existe.");
          }
          const factData = invoiceDoc.data();
          const currentSaldo = factData.saldo !== undefined ? factData.saldo : factData.total;

          if (currentSaldo <= 0) {
            throw new Error("La factura ya est√° pagada o saldo en cero.");
          }
          if (abonoAmount > currentSaldo) {
            throw new Error(`El abono excede el saldo pendiente (C$${currentSaldo.toFixed(2)}).`);
          }

          // Nuevo saldo
          const newSaldo = currentSaldo - abonoAmount;
          transaction.update(invoiceRef, { saldo: newSaldo });

          // Generar referencia √∫nica
          const reference = generateReference();
          const dateTime = new Date();

          // Crear doc de abono en la subcolecci√≥n
          const abonoRef = invoiceRef.collection("abonos").doc();
          transaction.set(abonoRef, {
            clientId: clientId,
            amount: abonoAmount,
            pendingBalance: newSaldo,
            reference: reference,
            dateTime: dateTime,
            route: route
          });
        });

        alert("Abono registrado con √©xito. üéâ");
        // Mostrar el recibo de abono
        // Obtenemos la factura para mostrar datos en el recibo
        const factDocSnap = await db.collection("facturas").doc(invoiceId).get();
        if (!factDocSnap.exists) {
          console.error("No se encontr√≥ la factura tras registrar el abono.");
          return;
        }
        const facturaData = factDocSnap.data();
        const newSaldo = facturaData.saldo || 0;
        const abono = abonoAmount;
        showAbonoReceipt({
          invoiceId,
          abono,
          saldoPendiente: newSaldo,
          fecha: new Date(),
          route
        }, facturaData);

        // Recargar facturas pendientes
        loadCreditInvoicesForAbonos();
      } catch (error) {
        console.error("Error al registrar abono:", error);
        alert("Ocurri√≥ un error al registrar el abono: " + error.message);
      }
    }

    // Mostrar Recibo de Abono en pantalla
    function showAbonoReceipt({invoiceId, abono, saldoPendiente, fecha, route}, facturaData) {
      const container = document.getElementById('abonoReceiptContainer');
      const receiptDiv = document.getElementById('abonoReceipt');

      const originalTotal = parseFloat(facturaData.total).toFixed(2);
      const abonoStr = parseFloat(abono).toFixed(2);
      const balanceStr = parseFloat(saldoPendiente).toFixed(2);
      const fechaStr = fecha.toLocaleString();

      const html = `
        <h3 style="text-align:center;">Recibo de Abono</h3>
        <p><strong>Fecha y Hora:</strong> ${fechaStr}</p>
        <p><strong>Ruta:</strong> ${route}</p>
        <p><strong>Moneda:</strong> C√≥rdobas (C$)</p>
        <hr>
        <p><strong>Factura #:</strong> ${invoiceId}</p>
        <p><strong>Monto Original de la Factura:</strong> C$${originalTotal}</p>
        <p><strong>Monto Abonado:</strong> C$${abonoStr}</p>
        <p><strong>Balance Pendiente:</strong> C$${balanceStr}</p>
      `;

      receiptDiv.innerHTML = html;
      container.style.display = 'block';
    }

    // Imprimir SOLO el recibo de abono
    function printAbonoReceipt() {
      const printContents = document.getElementById('abonoReceipt').innerHTML;
      const printWindow = window.open('', '_blank', 'width=800,height=600');
      printWindow.document.write(`
        <html>
          <head>
            <title>Imprimir Recibo de Abono</title>
            <style>
              body { font-family: Arial, sans-serif; margin: 20px; padding: 20px; }
              h3 { text-align: center; }
              hr { margin: 10px 0; }
            </style>
          </head>
          <body>
            ${printContents}
          </body>
        </html>
      `);
      printWindow.document.close();
      printWindow.focus();
      printWindow.print();
      printWindow.close();
    }

    // Cancelar abono (limpia campos)
    function cancelAbono() {
      document.getElementById('abonoAmount').value = '';
      document.getElementById('abonoInvoiceSelect').innerHTML = '';
      document.getElementById('abonoReceiptContainer').style.display = 'none';
    }

    // Generar la referencia (yyyyMMddHHmmss)
    function generateReference() {
      const now = new Date();
      const yyyy = now.getFullYear();
      const mm = String(now.getMonth() + 1).padStart(2, '0');
      const dd = String(now.getDate()).padStart(2, '0');
      const hh = String(now.getHours()).padStart(2, '0');
      const min = String(now.getMinutes()).padStart(2, '0');
      const ss = String(now.getSeconds()).padStart(2, '0');
      return `${yyyy}${mm}${dd}${hh}${min}${ss}`;
    }

    // Inicializar la p√°gina
    window.onload = function() {
      loadClients();          // Para facturaci√≥n
      loadInvoices();         // Para listado de facturas
      loadClientsForAbonos(); // Para secci√≥n de abonos
    };
  </script>
  
  <!-- Modal para ver el detalle de una factura -->
  <div id="invoiceModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeInvoiceModal()">&times;</span>
      <div id="modalInvoiceContent">
        <!-- Detalle de factura en modal -->
      </div>
    </div>
  </div>
</body>
</html>
