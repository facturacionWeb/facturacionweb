<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Facturaci√≥n de Art√≠culos</title>
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
  <!-- Firebase Config -->
  <script src="https://facturacionweb.github.io/facturacionweb/firebase-config.js"></script>
  <!-- jQuery -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <!-- Select2 CSS y JS -->
  <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
  <style>
    /* Estilos b√°sicos */
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      padding: 20px;
      background-color: #f4f4f4;
    }
    .container {
      max-width: 1000px;
      margin: 0 auto;
      background: #fff;
      padding: 20px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    h1, h2, h3 {
      text-align: center;
    }
    label, input, select, button {
      margin: 10px 0;
      padding: 10px;
      width: calc(100% - 20px);
      box-sizing: border-box;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }
    table, th, td {
      border: 1px solid #ccc;
      padding: 10px;
      text-align: center;
    }
    th {
      background-color: #333;
      color: #fff;
    }
    /* Secci√≥n de la factura */
    .invoice-container {
      width: 800px;
      background: #fff;
      padding: 20px;
      margin: 20px auto;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    .invoice-header {
      text-align: center;
      border-bottom: 2px solid #000;
      margin-bottom: 20px;
    }
    .invoice-header h2 {
      margin: 0;
      color: #333;
    }
    .invoice-header .currency, .invoice-header .route {
      font-size: 16px;
      color: #555;
      margin-top: 5px;
    }
    .invoice-body {
      margin-bottom: 20px;
    }
    .details-table, .items-table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 20px;
    }
    .details-table td, .items-table th, .items-table td {
      border: 1px solid #ddd;
      padding: 10px;
    }
    .items-table th {
      background: #333;
      color: #fff;
      text-align: left;
    }
    .signature {
      margin-top: 30px;
      text-align: right;
    }
    /* Estilos para el modal de detalle de factura */
    .modal {
      display: none;
      position: fixed;
      z-index: 100;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgba(0,0,0,0.5);
    }
    .modal-content {
      background-color: #fff;
      margin: 10% auto;
      padding: 20px;
      width: 90%;
      max-width: 800px;
      position: relative;
    }
    .close {
      color: #aaa;
      float: right;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
    }
    /* Oculta todo excepto la factura al imprimir */
    @media print {
      body * {
        visibility: hidden;
      }
      #invoiceContainer, #invoiceContainer * {
        visibility: visible;
      }
      #invoiceContainer {
        position: absolute;
        left: 0;
        top: 0;
        width: 100%;
      }
    }
  </style>
</head>
<body>
  <a href="index.html">Volver a la P√°gina Principal</a>
  <div class="container">
    <h1>Facturaci√≥n de Art√≠culos üìÑüí∞</h1>
    
    <!-- Secci√≥n: Crear Nueva Factura -->
    <h2>Crear Nueva Factura</h2>
    <label for="clientSelect">Selecciona Cliente:</label>
    <select id="clientSelect"></select>

    <label for="invoiceRoute">Ruta de la Factura:</label>
    <select id="invoiceRoute">
      <option value="SIN RUTA">SIN RUTA</option>
      <option value="1">1</option>
      <option value="2">2</option>
      <option value="3">3</option>
      <option value="4">4</option>
      <option value="5">5</option>
    </select>

    <!-- Nuevo selector de Moneda -->
    <label for="currencySelect">Moneda:</label>
    <select id="currencySelect">
      <option value="CORD">C√≥rdobas (C$)</option>
      <option value="USD">D√≥lares ($)</option>
    </select>

    <!-- Nuevo selector de M√©todo de Pago -->
    <label for="paymentType">M√©todo de Pago:</label>
    <select id="paymentType">
      <option value="Efectivo">Efectivo</option>
      <option value="Transferencia">Transferencia</option>
    </select>

    <!-- Informaci√≥n adicional para Transferencia -->
    <div id="transferInfo" style="display: none;">
      <label for="bankSelect">Selecciona Banco:</label>
      <select id="bankSelect">
        <option value="BAC">BAC</option>
        <option value="LA FISE">LA FISE</option>
        <option value="BANPRO">BANPRO</option>
        <option value="AVANZ">AVANZ</option>
      </select>
      <label for="bankReference">N√∫mero de Referencia Bancaria:</label>
      <input type="text" id="bankReference" placeholder="N√∫mero de Referencia Bancaria">
    </div>

    <!-- Tabla para los items de la factura -->
    <h3>Items de Factura</h3>
    <table id="invoiceItemsTable">
      <thead>
        <tr>
          <th>Art√≠culo</th>
          <th>Cantidad</th>
          <th>Precio Venta</th>
          <th>Descuento (%)</th>
          <th>Total</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody>
        <!-- Aqu√≠ se agregan las filas din√°micamente -->
      </tbody>
    </table>
    <button onclick="addInvoiceItem()">Agregar Item ‚ûï</button>
    <h3>Total a Pagar: <span id="invoiceTotal">0.00</span></h3>
    <button onclick="createInvoice()">Crear Factura üíµ</button>

    <!-- Secci√≥n para mostrar la factura creada -->
    <div id="invoiceDisplay" style="display:none;">
      <h2>Factura Generada</h2>
      <div class="invoice-container" id="invoiceContainer">
        <!-- Aqu√≠ se mostrar√° la factura con el detalle -->
      </div>
      <button onclick="printInvoice()">Imprimir Factura üñ®Ô∏è</button>
    </div>

    <hr>
    <!-- Secci√≥n: Listado de Facturas -->
    <h2>Listado de Facturas</h2>
    <label for="filterDate">Filtrar por Fecha:</label>
    <input type="date" id="filterDate">
    <label for="filterRoute">Filtrar por Ruta:</label>
    <select id="filterRoute">
      <option value="">-- Todas --</option>
      <option value="SIN RUTA">SIN RUTA</option>
      <option value="1">1</option>
      <option value="2">2</option>
      <option value="3">3</option>
      <option value="4">4</option>
      <option value="5">5</option>
    </select>
    <button onclick="filterInvoices()">Filtrar Facturas üîç</button>

    <table id="invoicesTable">
      <thead>
        <tr>
          <th>ID Factura</th>
          <th>Fecha y Hora</th>
          <th>Cliente</th>
          <th>Ruta</th>
          <th>Total</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody>
        <!-- Aqu√≠ se listan las facturas -->
      </tbody>
    </table>
  </div>

  <!-- Modal para ver el detalle de una factura -->
  <div id="invoiceModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeInvoiceModal()">&times;</span>
      <div id="modalInvoiceContent">
        <!-- Detalle de factura -->
      </div>
    </div>
  </div>

  <script>
    // Inicializar Firestore
    const db = firebase.firestore();
    // Variable global para el total de la factura
    let invoiceTotal = 0;

    // Mostrar u ocultar informaci√≥n adicional para transferencia
    document.getElementById('paymentType').addEventListener('change', function() {
      if (this.value === "Transferencia") {
        document.getElementById('transferInfo').style.display = 'block';
      } else {
        document.getElementById('transferInfo').style.display = 'none';
      }
    });

    // Cargar clientes en el select de facturaci√≥n
    function loadClients() {
      db.collection("clientes").get().then((querySnapshot) => {
        const clientSelect = document.getElementById('clientSelect');
        clientSelect.innerHTML = '';
        querySnapshot.forEach((doc) => {
          const client = doc.data();
          const option = document.createElement('option');
          option.value = doc.id;
          option.textContent = client.nombreCliente + " - " + client.nombreTienda;
          clientSelect.appendChild(option);
        });
      }).catch((error) => {
        console.error("Error al cargar clientes: ", error);
      });
    }

    // Funci√≥n para poblar un select con los art√≠culos (guardando marca, modelo, IMEI aparte)
    function populateArticleSelect($select) {
      $select.empty();
      db.collection("Articulos").get().then((articlesSnapshot) => {
        let promises = [];
        articlesSnapshot.forEach((articleDoc) => {
          const articleData = articleDoc.data();
          const p = db.collection("Articulos_X_IMEI")
            .where("articleId", "==", articleDoc.id)
            .get()
            .then((imeiSnapshot) => {
              if (!imeiSnapshot.empty) {
                imeiSnapshot.forEach((imeiDoc) => {
                  const imeiData = imeiDoc.data();
                  // Construimos un JSON con la info
                  const payload = {
                    articleId: articleDoc.id,
                    marca: articleData.marca,
                    modelo: articleData.modelo,
                    imei: imeiData.imei
                  };
                  const optionText = `${articleData.marca} ${articleData.modelo} - IMEI: ${imeiData.imei}`;
                  const optionValue = JSON.stringify(payload);
                  $select.append(new Option(optionText, optionValue));
                });
              } else {
                // Sin IMEI
                const payload = {
                  articleId: articleDoc.id,
                  marca: articleData.marca,
                  modelo: articleData.modelo,
                  imei: ""
                };
                const optionText = `${articleData.marca} ${articleData.modelo}`;
                const optionValue = JSON.stringify(payload);
                $select.append(new Option(optionText, optionValue));
              }
            })
            .catch((error) => {
              console.error("Error al cargar IMEI para el art√≠culo: ", error);
            });
          promises.push(p);
        });
        Promise.all(promises).then(() => {
          $select.select2({
            placeholder: "Busca por marca, modelo o IMEI",
            allowClear: true,
            width: '100%'
          });
        });
      })
      .catch((error) => {
        console.error("Error al cargar art√≠culos: ", error);
      });
    }

    // Agregar una nueva fila de item en la factura
    function addInvoiceItem() {
      const tbody = document.querySelector('#invoiceItemsTable tbody');
      const row = document.createElement('tr');

      // Columna: Art√≠culo (select con b√∫squeda)
      const articleCell = document.createElement('td');
      const articleSelect = document.createElement('select');
      $(articleSelect).css('width', '100%');
      articleCell.appendChild(articleSelect);
      row.appendChild(articleCell);
      populateArticleSelect($(articleSelect));

      // Columna: Cantidad
      const quantityCell = document.createElement('td');
      const quantityInput = document.createElement('input');
      quantityInput.type = 'number';
      quantityInput.value = 1;
      quantityInput.min = 1;
      quantityCell.appendChild(quantityInput);
      row.appendChild(quantityCell);

      // Columna: Precio Venta
      const priceCell = document.createElement('td');
      const priceInput = document.createElement('input');
      priceInput.type = 'number';
      priceInput.placeholder = 'Precio Venta';
      priceCell.appendChild(priceInput);
      row.appendChild(priceCell);

      // Columna: Descuento (%)
      const discountCell = document.createElement('td');
      const discountInput = document.createElement('input');
      discountInput.type = 'number';
      discountInput.value = 0;
      discountInput.min = 0;
      discountCell.appendChild(discountInput);
      row.appendChild(discountCell);

      // Columna: Total (calculado)
      const totalCell = document.createElement('td');
      totalCell.textContent = "0.00";
      row.appendChild(totalCell);

      // Columna: Acciones (bot√≥n para eliminar la fila)
      const actionsCell = document.createElement('td');
      const deleteBtn = document.createElement('button');
      deleteBtn.textContent = "Eliminar";
      deleteBtn.onclick = function() {
        tbody.removeChild(row);
        recalculateInvoice();
      };
      actionsCell.appendChild(deleteBtn);
      row.appendChild(actionsCell);

      // Actualizar el total de la fila al modificar cantidad, precio o descuento
      [quantityInput, priceInput, discountInput].forEach(input => {
        input.addEventListener('input', function() {
          const qty = parseFloat(quantityInput.value) || 0;
          const price = parseFloat(priceInput.value) || 0;
          const discount = parseFloat(discountInput.value) || 0;
          let total = qty * price;
          if (discount > 0) {
            total -= (total * discount / 100);
          }
          totalCell.textContent = total.toFixed(2);
          recalculateInvoice();
        });
      });

      tbody.appendChild(row);
    }

    // Recalcular el total de la factura
    function recalculateInvoice() {
      const rows = document.querySelectorAll('#invoiceItemsTable tbody tr');
      let total = 0;
      rows.forEach(row => {
        const totalCell = row.children[4]; // Columna "Total"
        total += parseFloat(totalCell.textContent) || 0;
      });
      invoiceTotal = total;
      document.getElementById('invoiceTotal').textContent = invoiceTotal.toFixed(2);
    }

    // Crear factura y guardar en Firestore
    function createInvoice() {
      const clientId = document.getElementById('clientSelect').value;
      const route = document.getElementById('invoiceRoute').value;
      const currency = document.getElementById('currencySelect').value;

      // Procesar el m√©todo de pago seg√∫n selecci√≥n
      let paymentType = document.getElementById('paymentType').value;
      let paymentMethod;
      if(paymentType === "Transferencia") {
        let bank = document.getElementById('bankSelect').value;
        let bankReference = document.getElementById('bankReference').value;
        paymentMethod = `Transferencia - Banco: ${bank} (#Ref: ${bankReference})`;
      } else {
        paymentMethod = "Efectivo";
      }

      const items = [];

      // Recopilar items de la factura
      const rows = document.querySelectorAll('#invoiceItemsTable tbody tr');
      rows.forEach(row => {
        // Obtener el valor seleccionado del select de art√≠culo (con marca, modelo, imei)
        const articleSelectElem = row.children[0].querySelector('select');
        let brand = "";
        let model = "";
        let imei = "";
        let articleId = "";

        if (articleSelectElem.value) {
          const parsedValue = JSON.parse(articleSelectElem.value);
          brand = parsedValue.marca;
          model = parsedValue.modelo;
          imei = parsedValue.imei;
          articleId = parsedValue.articleId;
        }

        const quantity = parseFloat(row.children[1].querySelector('input').value) || 0;
        const price = parseFloat(row.children[2].querySelector('input').value) || 0;
        const discount = parseFloat(row.children[3].querySelector('input').value) || 0;
        const total = parseFloat(row.children[4].textContent) || 0;

        items.push({
          articleId: articleId,
          brand: brand,
          model: model,
          imei: imei,
          quantity: quantity,
          price: price,
          discount: discount,
          total: total
        });
      });

      // Crear objeto de factura
      const invoice = {
        clientId: clientId,
        route: route,
        currency: currency, // Moneda
        paymentMethod: paymentMethod,
        items: items,
        total: invoiceTotal,
        fecha: new Date() // Timestamp
      };

      db.collection("facturas").add(invoice).then((docRef) => {
        alert("¬°Factura creada con √©xito! üéâ");
        displayInvoice(docRef.id, invoice);
        loadInvoices(); // Actualiza el listado de facturas
        // Limpiar la tabla de items y reiniciar total
        document.querySelector('#invoiceItemsTable tbody').innerHTML = '';
        document.getElementById('invoiceTotal').textContent = "0.00";
      }).catch((error) => {
        console.error("Error al crear factura: ", error);
      });
    }

    // Mostrar la factura creada en la secci√≥n de detalle
    function displayInvoice(invoiceId, invoice) {
      db.collection("clientes").doc(invoice.clientId).get().then((doc) => {
        const client = doc.data();

        // L√≥gica para mostrar la moneda elegida
        let currencySymbol = invoice.currency === 'CORD' ? 'C$' : '$';
        let currencyText = invoice.currency === 'CORD' ? 'C√≥rdobas (C$)' : 'D√≥lares ($)';

        const invoiceHTML = `
          <div class="invoice-header">
            <h2>Factura - ${invoiceId}</h2>
            <p class="currency"><strong>Moneda:</strong> ${currencyText}</p>
            <p class="route"><strong>Ruta de la Factura:</strong> ${invoice.route}</p>
          </div>
          <div class="invoice-body">
            <table class="details-table">
              <tr>
                <td><strong>Fecha y Hora:</strong> ${new Date(invoice.fecha).toLocaleString()}</td>
                <td><strong>Cliente:</strong> ${client.nombreCliente}</td>
              </tr>
              <tr>
                <td><strong>Tienda:</strong> ${client.nombreTienda}</td>
                <td><strong>Direcci√≥n:</strong> ${client.direccion}</td>
              </tr>
              <tr>
                <td><strong>Tel√©fono:</strong> ${client.telefono}</td>
                <td><strong>Pago:</strong> ${invoice.paymentMethod || 'N/A'}</td>
              </tr>
            </table>
            <table class="items-table">
              <tr>
                <th>Cantidad</th>
                <th>Descripci√≥n</th>
                <th>Precio Venta</th>
                <th>Descuento</th>
                <th>Total</th>
              </tr>
              ${invoice.items.map(item => `
                <tr>
                  <td>${item.quantity}</td>
                  <td>${item.brand} ${item.model} ${item.imei ? '(IMEI: ' + item.imei + ')' : ''}</td>
                  <td>${currencySymbol}${item.price.toFixed(2)}</td>
                  <td>${item.discount}%</td>
                  <td>${currencySymbol}${item.total.toFixed(2)}</td>
                </tr>
              `).join('')}
              <tr>
                <td colspan="4" style="text-align: right;"><strong>Total a Pagar:</strong></td>
                <td><strong>${currencySymbol}${invoice.total.toFixed(2)}</strong></td>
              </tr>
            </table>
            <div class="signature">
              <p>_______________________</p>
              <p>Firma del Cliente</p>
            </div>
          </div>
        `;
        document.getElementById('invoiceContainer').innerHTML = invoiceHTML;
        document.getElementById('invoiceDisplay').style.display = 'block';
      }).catch((error) => {
        console.error("Error al obtener datos del cliente: ", error);
      });
    }

    // Funci√≥n para imprimir solo la secci√≥n de la factura
    function printInvoice() {
      window.print();
    }

    // Listar facturas
    function loadInvoices() {
      db.collection("facturas").orderBy("fecha", "desc").get().then((querySnapshot) => {
        const tbody = document.querySelector('#invoicesTable tbody');
        tbody.innerHTML = '';
        querySnapshot.forEach((doc) => {
          const invoice = doc.data();
          const row = document.createElement('tr');
          row.innerHTML = `
            <td>${doc.id}</td>
            <td>${new Date(invoice.fecha).toLocaleString()}</td>
            <td>${invoice.clientId}</td>
            <td>${invoice.route}</td>
            <td>${invoice.total.toFixed(2)}</td>
            <td>
              <button onclick="viewInvoiceDetail('${doc.id}')">Ver</button>
            </td>
          `;
          tbody.appendChild(row);
        });
      }).catch((error) => {
        console.error("Error al cargar facturas: ", error);
      });
    }

    // Filtrar facturas por fecha y ruta
    function filterInvoices() {
      const filterDate = document.getElementById('filterDate').value;
      const filterRoute = document.getElementById('filterRoute').value;
      let query = db.collection("facturas");

      if(filterDate) {
        const start = new Date(filterDate);
        start.setHours(0,0,0,0);
        const end = new Date(filterDate);
        end.setHours(23,59,59,999);
        query = query.where("fecha", ">=", start).where("fecha", "<=", end);
      }
      if(filterRoute) {
        query = query.where("route", "==", filterRoute);
      }

      query.orderBy("fecha", "desc").get().then((querySnapshot) => {
        const tbody = document.querySelector('#invoicesTable tbody');
        tbody.innerHTML = '';
        querySnapshot.forEach((doc) => {
          const invoice = doc.data();
          const row = document.createElement('tr');
          row.innerHTML = `
            <td>${doc.id}</td>
            <td>${new Date(invoice.fecha).toLocaleString()}</td>
            <td>${invoice.clientId}</td>
            <td>${invoice.route}</td>
            <td>${invoice.total.toFixed(2)}</td>
            <td>
              <button onclick="viewInvoiceDetail('${doc.id}')">Ver</button>
            </td>
          `;
          tbody.appendChild(row);
        });
      }).catch((error) => {
        console.error("Error al filtrar facturas: ", error);
      });
    }

    // Ver detalle de una factura en modal
    function viewInvoiceDetail(invoiceId) {
      db.collection("facturas").doc(invoiceId).get().then((doc) => {
        if(doc.exists) {
          const invoice = doc.data();
          db.collection("clientes").doc(invoice.clientId).get().then((clientDoc) => {
            const client = clientDoc.data();
            let currencySymbol = invoice.currency === 'CORD' ? 'C$' : '$';
            let currencyText = invoice.currency === 'CORD' ? 'C√≥rdobas (C$)' : 'D√≥lares ($)';

            const invoiceHTML = `
              <div class="invoice-header">
                <h2>Factura - ${invoiceId}</h2>
                <p class="currency"><strong>Moneda:</strong> ${currencyText}</p>
                <p class="route"><strong>Ruta de la Factura:</strong> ${invoice.route}</p>
              </div>
              <div class="invoice-body">
                <table class="details-table">
                  <tr>
                    <td><strong>Fecha y Hora:</strong> ${new Date(invoice.fecha).toLocaleString()}</td>
                    <td><strong>Cliente:</strong> ${client.nombreCliente}</td>
                  </tr>
                  <tr>
                    <td><strong>Tienda:</strong> ${client.nombreTienda}</td>
                    <td><strong>Direcci√≥n:</strong> ${client.direccion}</td>
                  </tr>
                  <tr>
                    <td><strong>Tel√©fono:</strong> ${client.telefono}</td>
                    <td><strong>Pago:</strong> ${invoice.paymentMethod || 'N/A'}</td>
                  </tr>
                </table>
                <table class="items-table">
                  <tr>
                    <th>Cantidad</th>
                    <th>Descripci√≥n</th>
                    <th>Precio Venta</th>
                    <th>Descuento</th>
                    <th>Total</th>
                  </tr>
                  ${invoice.items.map(item => `
                    <tr>
                      <td>${item.quantity}</td>
                      <td>${item.brand} ${item.model} ${item.imei ? '(IMEI: ' + item.imei + ')' : ''}</td>
                      <td>${currencySymbol}${item.price.toFixed(2)}</td>
                      <td>${item.discount}%</td>
                      <td>${currencySymbol}${item.total.toFixed(2)}</td>
                    </tr>
                  `).join('')}
                  <tr>
                    <td colspan="4" style="text-align: right;"><strong>Total a Pagar:</strong></td>
                    <td><strong>${currencySymbol}${invoice.total.toFixed(2)}</strong></td>
                  </tr>
                </table>
                <div class="signature">
                  <p>_______________________</p>
                  <p>Firma del Cliente</p>
                </div>
              </div>
            `;
            document.getElementById('modalInvoiceContent').innerHTML = invoiceHTML;
            document.getElementById('invoiceModal').style.display = 'block';
          });
        }
      }).catch((error) => {
        console.error("Error al ver factura: ", error);
      });
    }

    function closeInvoiceModal() {
      document.getElementById('invoiceModal').style.display = 'none';
    }

    // Inicializar la p√°gina: carga de clientes y facturas
    window.onload = function() {
      loadClients();
      loadInvoices();
    };
  </script>
</body>
</html>
