<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>Gesti√≥n de Usuarios</title>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
  <script src="https://facturacionweb.github.io/facturacionweb/firebase-config.js"></script>

  <style>
    body{font-family:Arial;padding:20px}
    .container{max-width:800px;margin:0 auto}
    input,button,label,select{margin:10px 0;display:block;width:calc(100% - 20px);padding:10px;box-sizing:border-box}
    .password-container{position:relative;width:calc(100% - 20px)}
    .password-container input{width:100%;padding-right:40px}
    .toggle-password{position:absolute;right:10px;top:50%;transform:translateY(-50%);cursor:pointer}
    table{width:100%;border-collapse:collapse}
    table,th,td{border:1px solid #000;padding:10px;text-align:center}
  </style>
</head>
<body>
  <a href="index.html">Volver a la P√°gina Principal</a>

  <div class="container">
    <h1>Gesti√≥n de Usuarios</h1>

    <!-- Formulario -->
    <input type="text" id="username" placeholder="Username" />
    <div class="password-container">
      <input type="password" id="password" placeholder="Password" />
      <span class="toggle-password" onclick="togglePassword()">üëÅÔ∏è</span>
    </div>
    <input type="text" id="fullName" placeholder="Nombre Completo" />
    <select id="location">
      <option value="TODOS">TODOS</option><option value="SIN RUTA">SIN RUTA</option>
      <option value="1">1</option><option value="2">2</option><option value="3">3</option>
      <option value="4">4</option><option value="5">5</option><option value="6">6</option>
      <option value="7">7</option><option value="8">8</option><option value="9">9</option>
      <option value="10">10</option>
    </select>

    <!-- üÜï Lista de permisos -->
    <label>Permisos de acceso:</label>
    <div id="pageList"></div>                <!-- üÜï -->

    <button onclick="addOrUpdateUser()">Agregar/Actualizar Usuario</button>
    <button onclick="clearFields()">Limpiar Campos</button>

    <!-- Tabla -->
    <h2>Usuarios Existentes</h2>
    <table>
      <thead><tr><th>Username</th><th>Nombre Completo</th><th>Ubicaci√≥n</th><th>Acciones</th></tr></thead>
      <tbody id="userTable"></tbody>
    </table>
  </div>

  <script>
    const db = firebase.firestore();

    // ---------- P√°ginas disponibles ----------
    const PAGES=[
      {key:'usuarios',label:'Administrar Usuarios'},
      {key:'clientes',label:'Administrar Clientes'},
      {key:'proveedores',label:'Administrar Proveedores'},
      {key:'articulos',label:'Administrar Art√≠culos'},
      {key:'facturas',label:'Facturar'},
      {key:'abonar',label:'Abonar'},
      {key:'notascredito',label:'Notas de Cr√©dito'},
      {key:'cargamasivaimei',label:'Carga IMEIs x Ruta'},
      {key:'reportearticulos',label:'Reporte Art√≠culos'},
      {key:'reportearticulosxruta',label:'Reporte por Ruta'},
      {key:'reporteestadoscuenta',label:'Estado de Cuenta'},
      {key:'reportefacturas',label:'Reporte Facturas'},
      {key:'buscar',label:'Buscar Item'},
      {key:'dashboard',label:'Dashboard Ventas'}
    ];

    // ---------- Render checkboxes ----------
    function renderPageCheckboxes(){
      const wrap=document.getElementById('pageList');
      wrap.innerHTML='';
      PAGES.forEach(p=>{
        wrap.innerHTML+=`
          <label style="display:inline-block;margin-right:10px;">
            <input type="checkbox" value="${p.key}"/> ${p.label}
          </label>`;
      });
    }

    // ---------- Utils ----------
    function getSelectedPages(){
      return Array.from(document.querySelectorAll('#pageList input:checked')).map(cb=>cb.value);
    }
    function setSelectedPages(arr){
      document.querySelectorAll('#pageList input').forEach(cb=>cb.checked=arr.includes(cb.value));
    }

    // ---------- Form helpers ----------
    function togglePassword(){const inp=password;inp.type=inp.type==='password'?'text':'password';}
    function clearFields(){
      username.value='';password.value='';fullName.value='';location.value='TODOS';
      setSelectedPages([]);
    }

    // ---------- CRUD ----------
    function addOrUpdateUser(){
      const data={
        username: username.value.trim(),
        password: password.value.trim(),
        fullName: fullName.value.trim(),
        location: location.value,
        allowedPages: getSelectedPages()            // üÜï
      };
      if(!data.username) return alert('Username requerido ‚ö†Ô∏è');

      db.collection('users').doc(data.username).set(data)  //¬†üÜï ahora guarda allowedPages
        .then(()=>{alert('Guardado ‚úÖ');loadUsers();clearFields();})
        .catch(e=>console.error('Err',e));
    }

    function deleteUser(user){
      db.collection('users').doc(user).delete()
        .then(()=>{alert('Eliminado');loadUsers();})
        .catch(e=>console.error(e));
    }

    function fillFormForEdit(d){
      username.value=d.username;password.value=d.password;
      fullName.value=d.fullName;location.value=d.location;
      setSelectedPages(d.allowedPages||[]);           // üÜï
    }

    // ---------- Cargar y pintar ----------
    function loadUsers(){
      db.collection('users').get().then(q=>{
        const tbody=userTable;tbody.innerHTML='';
        q.forEach(doc=>{
          const d=doc.data();
          tbody.innerHTML+=`<tr>
            <td>${d.username}</td><td>${d.fullName||''}</td><td>${d.location}</td>
            <td>
              <button onclick="deleteUser('${d.username}')">Eliminar</button>
              <button onclick="fillFormForEdit(${JSON.stringify(d).replace(/"/g,'&quot;')})">Editar</button>
            </td></tr>`;
        });
      });
    }

    // ---------- Init ----------
    window.onload=()=>{renderPageCheckboxes();loadUsers();}
  </script>
</body>
</html>
